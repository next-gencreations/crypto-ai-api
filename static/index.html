<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crypto AI Bot Dashboard</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />

    <!-- Simple dark theme with basic CSS only -->
    <style>
      :root {
        --bg: #050814;
        --bg-card: #101522;
        --bg-card-soft: #141b2c;
        --text-main: #f8fafc;
        --text-muted: #9ca3af;
        --accent: #22c55e;
        --accent-red: #ef4444;
        --border-soft: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text-main);
      }

      .page {
        max-width: 1080px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        margin-bottom: 24px;
      }

      h1 {
        margin: 0 0 4px;
        font-size: 28px;
        font-weight: 700;
      }

      header p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted);
      }

      header a {
        color: #38bdf8;
        text-decoration: none;
        margin-left: 4px;
        margin-right: 4px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .card {
        background: linear-gradient(145deg, var(--bg-card), #060b17);
        border-radius: 14px;
        padding: 14px 16px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      }

      .card h2 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .metric-main {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .metric-sub {
        font-size: 12px;
        color: var(--text-muted);
      }

      .metric-main.positive {
        color: var(--accent);
      }

      .metric-main.negative {
        color: var(--accent-red);
      }

      .section {
        background: radial-gradient(circle at top left, #111827, #020617);
        border-radius: 16px;
        padding: 16px 16px 18px;
        border: 1px solid #111827;
        margin-bottom: 18px;
      }

      .section h2 {
        margin: 0 0 4px;
        font-size: 16px;
      }

      .section p {
        margin: 0 0 12px;
        font-size: 13px;
        color: var(--text-muted);
      }

      .section-subtitle {
        margin-top: 4px;
        font-size: 13px;
        color: var(--text-muted);
      }

      .equity-chart-wrapper {
        position: relative;
        width: 100%;
        height: 260px;
      }

      canvas {
        width: 100% !important;
        height: 100% !important;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      th,
      td {
        padding: 6px 4px;
        text-align: left;
      }

      th {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-muted);
        border-bottom: 1px solid #111827;
      }

      tr + tr td {
        border-top: 1px solid #020617;
      }

      .text-right {
        text-align: right;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 1px 8px;
        font-size: 11px;
        border: 1px solid #1f2937;
        background: rgba(15, 23, 42, 0.85);
      }

      .pill span {
        margin-left: 5px;
        color: var(--text-muted);
      }

      .pill-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #22c55e;
      }

      .pnl-positive {
        color: var(--accent);
      }

      .pnl-negative {
        color: var(--accent-red);
      }

      .footer {
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-muted);
        text-align: center;
      }

      .footer a {
        color: #38bdf8;
        text-decoration: none;
      }

      /* Candlestick chart area */

      .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .chart-column h3 {
        font-size: 15px;
        margin: 0 0 8px;
        color: var(--text-main);
      }

      .chart-card {
        background: linear-gradient(145deg, var(--bg-card), #060b17);
        border-radius: 14px;
        border: 1px solid var(--border-soft);
        padding: 8px 8px 4px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
        margin-bottom: 10px;
      }

      .chart-card h4 {
        font-size: 13px;
        margin: 0 0 4px;
        color: var(--text-muted);
      }

      .tv-chart {
        width: 100%;
        height: 260px;
      }

      @media (max-width: 768px) {
        h1 {
          font-size: 24px;
        }

        .equity-chart-wrapper {
          height: 220px;
        }

        .tv-chart {
          height: 220px;
        }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header>
        <h1>Crypto AI Bot Dashboard</h1>
        <p>
          Paper-trading stats from Render —
          <a href="/data" target="_blank" rel="noopener noreferrer">raw stats</a> |
          <a href="/health" target="_blank" rel="noopener noreferrer">API status</a>
        </p>
      </header>

      <!-- Top metric cards -->
      <section class="cards">
        <div class="card">
          <h2>Total Trades</h2>
          <div class="metric-main" id="totalTrades">0</div>
          <div class="metric-sub" id="winsLosses">0 wins / 0 losses</div>
        </div>

        <div class="card">
          <h2>Win Rate</h2>
          <div class="metric-main" id="winRate">0.0%</div>
          <div class="metric-sub" id="avgPnlText">Avg $0.00 per trade</div>
        </div>

        <div class="card">
          <h2>PNL (Total)</h2>
          <div class="metric-main" id="totalPnl">$0.00</div>
          <div class="metric-sub">Based on closed trades only</div>
        </div>
      </section>

      <!-- Equity curve -->
      <section class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <div>
            <h2>Equity Curve</h2>
            <p>Based on closed trades only (last N points).</p>
          </div>
          <div class="pill" id="botStatusPill">
            <div class="pill-dot"></div>
            <span id="botStatusText">Checking bot status…</span>
          </div>
        </div>

        <div class="equity-chart-wrapper">
          <canvas id="equityChart"></canvas>
        </div>
      </section>

      <!-- Per-market performance -->
      <section class="section">
        <h2>Per-Market Performance <span id="marketCount" style="font-size: 11px; color: var(--text-muted);"></span></h2>
        <p>How the bot is doing on each market (paper trading).</p>

        <div style="overflow-x: auto;">
          <table id="marketTable">
            <thead>
              <tr>
                <th>Market</th>
                <th class="text-right">Trades</th>
                <th class="text-right">Win Rate</th>
                <th class="text-right">Total PNL</th>
                <th class="text-right">Avg PNL</th>
              </tr>
            </thead>
            <tbody id="marketTableBody">
              <tr>
                <td colspan="5" style="text-align: center; padding: 12px 4px; color: var(--text-muted);">
                  Waiting for trades…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Recent trades -->
      <section class="section">
        <h2>Recent Trades</h2>
        <p>Showing last N trades.</p>

        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Market</th>
                <th class="text-right">PNL (USD)</th>
              </tr>
            </thead>
            <tbody id="recentTradesBody">
              <tr>
                <td colspan="3" style="text-align: center; padding: 12px 4px; color: var(--text-muted);">
                  Waiting for trades…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Market Candlestick Charts (TradingView) -->
      <section class="section">
        <h2>Market Candlestick Charts</h2>
        <p class="section-subtitle">
          Live price action from TradingView. These are external charts only – your bot is still paper trading.
        </p>

        <div class="chart-grid">
          <!-- Coinbase -->
          <div class="chart-column">
            <h3>Coinbase</h3>

            <div class="chart-card">
              <h4>BTC / USD</h4>
              <div id="chart-btc-coinbase" class="tv-chart"></div>
            </div>

            <div class="chart-card">
              <h4>ETH / USD</h4>
              <div id="chart-eth-coinbase" class="tv-chart"></div>
            </div>

            <div class="chart-card">
              <h4>SOL / USD</h4>
              <div id="chart-sol-coinbase" class="tv-chart"></div>
            </div>
          </div>

          <!-- KuCoin -->
          <div class="chart-column">
            <h3>KuCoin (USDT)</h3>

            <div class="chart-card">
              <h4>BTC / USDT</h4>
              <div id="chart-btc-kucoin" class="tv-chart"></div>
            </div>

            <div class="chart-card">
              <h4>ETH / USDT</h4>
              <div id="chart-eth-kucoin" class="tv-chart"></div>
            </div>

            <div class="chart-card">
              <h4>SOL / USDT</h4>
              <div id="chart-sol-kucoin" class="tv-chart"></div>
            </div>
          </div>

          <!-- Crypto.com -->
          <div class="chart-column">
            <h3>Crypto.com</h3>

            <div class="chart-card">
              <h4>CRO / USD</h4>
              <div id="chart-cro-crypto" class="tv-chart"></div>
            </div>
          </div>
        </div>
      </section>

      <p class="footer">
        Bot is running on Render (paper trading only). Keep it training for 2–3 weeks before making AI changes.
      </p>
    </div>

    <!-- Chart.js for equity curve -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      async function loadStats() {
        try {
          const res = await fetch("/data");
          const data = await res.json();

          // ----- Top metrics -----
          const totalTrades = data.total_events || 0;
          const wins = data.wins || 0;
          const losses = data.losses || 0;
          const winRate = data.win_rate || 0; // already percentage in API
          const totalPnl = data.total_pnl_usd || 0;
          const avgPnl = data.avg_pnl_usd || 0;

          document.getElementById("totalTrades").textContent = totalTrades;
          document.getElementById(
            "winsLosses"
          ).textContent = `${wins} wins / ${losses} losses`;

          document.getElementById("winRate").textContent =
            winRate.toFixed(1) + "%";

          document.getElementById(
            "avgPnlText"
          ).textContent = `Avg $${avgPnl.toFixed(2)} per trade`;

          const pnlElem = document.getElementById("totalPnl");
          const pnlStr = (totalPnl >= 0 ? "+" : "-") + "$" + Math.abs(totalPnl).toFixed(2);
          pnlElem.textContent = pnlStr;
          pnlElem.classList.remove("positive", "negative");
          pnlElem.classList.add(totalPnl >= 0 ? "positive" : "negative");

          // ----- Equity curve -----
          const eqData = Array.isArray(data.equity_curve)
            ? data.equity_curve
            : [];

          const labels = eqData.map((p) =>
            new Date(p.time).toISOString().replace("T", " ").slice(0, 19)
          );
          const values = eqData.map((p) => p.equity_usd);

          const ctx = document.getElementById("equityChart").getContext("2d");

          new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Equity (USD)",
                  data: values,
                  borderWidth: 2,
                  pointRadius: 3,
                  tension: 0.2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  ticks: {
                    maxTicksLimit: 6,
                    color: "#9ca3af",
                    font: { size: 11 }
                  },
                  grid: {
                    display: false
                  }
                },
                y: {
                  ticks: {
                    color: "#9ca3af",
                    font: { size: 11 }
                  },
                  grid: {
                    color: "#111827"
                  }
                }
              },
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  mode: "index",
                  intersect: false
                }
              }
            }
          });

          // ----- Bot status pill -----
          if (data.bot_status) {
            const status = data.bot_status.status || "unknown";
            const minutesSince = data.bot_status.minutes_since ?? null;

            const pill = document.getElementById("botStatusPill");
            const dot = pill.querySelector(".pill-dot");
            const text = document.getElementById("botStatusText");

            let color = "#22c55e";
            let label = "Running OK";

            if (status === "idle") {
              color = "#eab308";
              label = "Idle recently";
            } else if (status === "stopped" || status === "unknown") {
              color = "#ef4444";
              label = "No heartbeat";
            }

            dot.style.background = color;

            if (minutesSince != null) {
              text.textContent = `${label} · last heartbeat ${minutesSince} min ago`;
            } else {
              text.textContent = label;
            }
          }

          // ----- Per-market table -----
          const marketBody = document.getElementById("marketTableBody");
          marketBody.innerHTML = "";

          const perMarket = Array.isArray(data.per_market)
            ? data.per_market
            : [];

          if (perMarket.length === 0) {
            marketBody.innerHTML =
              '<tr><td colspan="5" style="text-align:center; padding:12px 4px; color:var(--text-muted);">No data yet</td></tr>';
          } else {
            document.getElementById(
              "marketCount"
            ).textContent = `(${perMarket.length} markets)`;

            perMarket.forEach((m) => {
              const tr = document.createElement("tr");

              const totalPnl = m.total_pnl_usd || 0;
              const avgPnl = m.avg_pnl_usd || 0;

              const pnlClass =
                totalPnl > 0
                  ? "pnl-positive"
                  : totalPnl < 0
                  ? "pnl-negative"
                  : "";

              tr.innerHTML = `
                <td>${m.market}</td>
                <td class="text-right">${m.trades}</td>
                <td class="text-right">${(m.win_rate || 0).toFixed(1)}%</td>
                <td class="text-right ${pnlClass}">$${totalPnl.toFixed(2)}</td>
                <td class="text-right">$${avgPnl.toFixed(2)}</td>
              `;
              marketBody.appendChild(tr);
            });
          }

          // ----- Recent trades -----
          const recentBody = document.getElementById("recentTradesBody");
          recentBody.innerHTML = "";

          const recent = Array.isArray(data.recent_trades)
            ? data.recent_trades
            : [];

          if (recent.length === 0) {
            recentBody.innerHTML =
              '<tr><td colspan="3" style="text-align:center; padding:12px 4px; color:var(--text-muted);">No trades yet.</td></tr>';
          } else {
            recent.forEach((t) => {
              const pnl = t.pnl_usd || 0;
              const pnlClass =
                pnl > 0 ? "pnl-positive" : pnl < 0 ? "pnl-negative" : "";
              const pnlStr = (pnl >= 0 ? "+" : "-") + "$" + Math.abs(pnl).toFixed(2);

              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${new Date(t.time)
                  .toISOString()
                  .replace("T", " ")
                  .slice(0, 19)}</td>
                <td>${t.market}</td>
                <td class="text-right ${pnlClass}">${pnlStr}</td>
              `;
              recentBody.appendChild(tr);
            });
          }
        } catch (err) {
          console.error("Failed to load stats:", err);
          const pillText = document.getElementById("botStatusText");
          if (pillText) {
            pillText.textContent = "Error loading stats";
          }
        }
      }

      loadStats();
      // Optionally refresh every few minutes
      setInterval(loadStats, 180000); // 3 minutes
    </script>

    <!-- TradingView candlestick charts -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
      function createChart(containerId, symbol) {
        if (typeof TradingView === "undefined") {
          console.warn("TradingView library not loaded");
          return;
        }

        new TradingView.widget({
          container_id: containerId,
          autosize: true,
          symbol: symbol,
          interval: "60", // 1h candles
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1", // candles
          locale: "en",
          hide_side_toolbar: false,
          hide_top_toolbar: false,
          allow_symbol_change: true,
          backgroundColor: "#050814"
        });
      }

      window.addEventListener("DOMContentLoaded", function () {
        // Coinbase
        createChart("chart-btc-coinbase", "COINBASE:BTCUSD");
        createChart("chart-eth-coinbase", "COINBASE:ETHUSD");
        createChart("chart-sol-coinbase", "COINBASE:SOLUSD");

        // KuCoin
        createChart("chart-btc-kucoin", "KUCOIN:BTCUSDT");
        createChart("chart-eth-kucoin", "KUCOIN:ETHUSDT");
        createChart("chart-sol-kucoin", "KUCOIN:SOLUSDT");

        // Crypto.com
        createChart("chart-cro-crypto", "CRYPTOCOM:CROUSD");
      });
    </script>
  </body>
</html>
