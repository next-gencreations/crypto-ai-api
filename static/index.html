<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crypto AI Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #050814;
        --bg-card: #101522;
        --bg-card-soft: #141b2c;
        --text-main: #f8f4fc;
        --text-muted: #9ca3af;
        --accent: #22c55e;
        --accent-red: #ef4444;
        --accent-blue: #3b82f6;
        --border-soft: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text-main);
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        margin-bottom: 24px;
      }

      h1 {
        margin: 0 0 4px;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      header p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted);
      }

      header a {
        color: #38bdf8;
        text-decoration: none;
        margin-left: 4px;
        margin-right: 4px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .card {
        background: linear-gradient(145deg, var(--bg-card), #060b17);
        border-radius: 14px;
        padding: 14px 16px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      }

      .card h2 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .metric-main {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .metric-sub {
        font-size: 12px;
        color: var(--text-muted);
      }

      .metric-main.positive {
        color: var(--accent);
      }

      .metric-main.negative {
        color: var(--accent-red);
      }

      .card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.8);
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
      }

      .status-running {
        background-color: #22c55e;
      }

      .status-idle {
        background-color: #eab308;
      }

      .status-stopped {
        background-color: #ef4444;
      }

      .status-unknown {
        background-color: #6b7280;
      }

      .section-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .section-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin: 0 0 12px;
      }

      .section-card {
        margin-bottom: 24px;
      }

      .chart-container {
        height: 260px;
        background: radial-gradient(circle at top, #020617, #020617);
        border-radius: 14px;
        border: 1px solid var(--border-soft);
        overflow: hidden;
      }

      .chart-inner {
        width: 100%;
        height: 100%;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      thead {
        background: rgba(15, 23, 42, 0.9);
      }

      th,
      td {
        padding: 8px 10px;
        text-align: left;
      }

      th {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-bottom: 1px solid var(--border-soft);
      }

      tbody tr:nth-child(odd) {
        background: rgba(15, 23, 42, 0.4);
      }

      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.1);
      }

      tbody tr:hover {
        background: rgba(55, 65, 81, 0.4);
      }

      .text-right {
        text-align: right;
      }

      .muted {
        color: var(--text-muted);
      }

      .section-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
        gap: 16px;
      }

      @media (max-width: 900px) {
        .section-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .advanced-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px 14px;
        margin-top: 6px;
      }

      .adv-label {
        font-size: 11px;
        color: var(--text-muted);
      }

      .adv-value {
        font-size: 14px;
        font-weight: 600;
      }

      /* TradingView area */
      .tv-tabs {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        padding: 2px;
        margin-bottom: 8px;
      }

      .tv-tab {
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        cursor: pointer;
      }

      .tv-tab.active {
        background: #0f172a;
        color: var(--text-main);
      }

      .footer {
        margin-top: 18px;
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
      }

      /* ---------------------------------
         BOT PET (Tamagotchi-ish)
         --------------------------------- */

      .pet-row {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .pet-screen {
        width: 86px;
        height: 66px;
        border-radius: 14px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.22));
        box-shadow: inset 0 0 0 2px rgba(0, 0, 0, 0.25);
        position: relative;
        overflow: hidden;
      }

      .pet-inner {
        width: 100%;
        height: 100%;
        display: grid;
        place-items: center;
        image-rendering: pixelated;
      }

      .pet-svg {
        width: 64px;
        height: 52px;
        filter: drop-shadow(0 8px 18px rgba(0,0,0,0.35));
        opacity: 0.98;
      }

      .pet-bubble {
        position: absolute;
        right: 8px;
        bottom: 8px;
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.18);
        animation: petBlink 2.4s ease-in-out infinite;
      }

      @keyframes petBlink {
        0%, 100% { transform: translateY(0); opacity: 0.2; }
        50% { transform: translateY(-3px); opacity: 0.45; }
      }

      .pet-pacing {
        animation: petPace 1.6s ease-in-out infinite;
      }
      @keyframes petPace {
        0%, 100% { transform: translateX(-4px); }
        50% { transform: translateX(4px); }
      }

      .pet-shiver {
        animation: petShiver 0.25s linear infinite;
      }
      @keyframes petShiver {
        0% { transform: translateX(-1px) translateY(0); }
        50% { transform: translateX(1px) translateY(0); }
        100% { transform: translateX(-1px) translateY(0); }
      }

      .pet-title {
        font-weight: 700;
        margin-bottom: 2px;
        color: var(--text-main);
      }
      .pet-sub {
        font-size: 12px;
        color: var(--text-muted);
      }

      .pet-mini {
        display: inline-flex;
        gap: 8px;
        align-items: baseline;
        margin-top: 6px;
        font-size: 11px;
        color: var(--text-muted);
      }

      .pet-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 10px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(15, 23, 42, 0.7);
        color: var(--text-muted);
      }

      .pet-bar {
        width: 92px;
        height: 6px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.18);
        overflow: hidden;
        border: 1px solid rgba(31, 41, 55, 0.7);
      }
      .pet-bar > div {
        height: 100%;
        width: 50%;
        background: rgba(34, 197, 94, 0.7);
      }
      .pet-bar.red > div {
        background: rgba(239, 68, 68, 0.65);
      }

      .pet-hint {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 8px;
      }

      .pet-btns {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      .pet-btn {
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(15, 23, 42, 0.65);
        color: var(--text-main);
        border-radius: 999px;
        font-size: 11px;
        padding: 6px 10px;
        cursor: pointer;
      }
      .pet-btn:hover {
        background: rgba(15, 23, 42, 0.85);
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header>
        <h1>Crypto AI Bot Dashboard</h1>
        <p>
          Paper-trading stats from Render â€”
          <a href="/data" target="_blank">raw stats</a>
        </p>
      </header>

      <!-- Top KPIs -->
      <section class="cards">
        <div class="card">
          <h2>Total Trades</h2>
          <div class="metric-main" id="metric-total-trades">0</div>
          <div class="metric-sub">
            <span id="metric-wins">0 wins</span> /
            <span id="metric-losses">0 losses</span>
          </div>
        </div>

        <div class="card">
          <h2>Win Rate</h2>
          <div class="metric-main" id="metric-win-rate">0%</div>
          <div class="metric-sub">
            Avg <span id="metric-avg-pnl">-$0.00</span> per trade
          </div>
        </div>

        <div class="card">
          <h2>PNL (Total)</h2>
          <div class="metric-main negative" id="metric-total-pnl">$0.00</div>
          <div class="metric-sub">Based on closed trades only.</div>
        </div>

        <div class="card">
          <h2>Bot Status</h2>
          <div class="card-row" style="margin-bottom: 6px">
            <div class="status-pill" id="bot-status-pill">
              <span class="status-dot status-unknown" id="bot-status-dot"></span>
              <span id="bot-status-label">Unknown</span>
            </div>
            <span class="muted" id="bot-status-minutes"></span>
          </div>
          <div class="metric-sub" id="bot-status-last">Waiting for heartbeatâ€¦</div>
        </div>

        <!-- BOT PET CARD -->
        <div class="card">
          <h2>Bot Pet</h2>

          <div class="pet-row">
            <div class="pet-screen">
              <div class="pet-inner" id="pet-inner">
                <!-- SVG injected by JS -->
              </div>
              <div class="pet-bubble"></div>
            </div>

            <div style="min-width: 0">
              <div class="muted" style="font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase;">
                Mood
              </div>
              <div class="pet-title" id="pet-title">Watchingâ€¦</div>
              <div class="pet-sub" id="pet-sub">Waiting for trades</div>

              <div class="pet-mini">
                <span class="pet-badge" id="pet-stage">Egg</span>

                <div class="pet-bar" id="pet-xp-bar" title="Growth">
                  <div></div>
                </div>
              </div>
            </div>
          </div>

          <div class="pet-hint" id="pet-hint">
            Egg stays until the bot first goes profitable. Wins feed it ðŸ¥£.
          </div>

          <div class="pet-btns">
            <button class="pet-btn" id="pet-reset-btn" title="Resets only the pet (does not touch your trading data).">
              Reset Pet
            </button>
          </div>
        </div>
      </section>

      <!-- Advanced Analytics -->
      <section class="card section-card">
        <div class="card-row" style="margin-bottom: 6px">
          <div>
            <div class="section-title">Advanced Analytics</div>
            <div class="section-subtitle">Deeper stats from your closed trades.</div>
          </div>
        </div>

        <div class="advanced-grid">
          <div>
            <div class="adv-label">Profit Factor</div>
            <div class="adv-value" id="adv-profit-factor">â€”</div>
          </div>
          <div>
            <div class="adv-label">Avg Win (USD)</div>
            <div class="adv-value" id="adv-avg-win">â€”</div>
          </div>
          <div>
            <div class="adv-label">Avg Loss (USD)</div>
            <div class="adv-value" id="adv-avg-loss">â€”</div>
          </div>
          <div>
            <div class="adv-label">Best Trade (USD)</div>
            <div class="adv-value" id="adv-best-trade">â€”</div>
          </div>
          <div>
            <div class="adv-label">Worst Trade (USD)</div>
            <div class="adv-value" id="adv-worst-trade">â€”</div>
          </div>
          <div>
            <div class="adv-label">Max Drawdown (USD)</div>
            <div class="adv-value" id="adv-max-dd">â€”</div>
          </div>
          <div>
            <div class="adv-label">Recovery Factor</div>
            <div class="adv-value" id="adv-recovery-factor">â€”</div>
          </div>
          <div>
            <div class="adv-label">Sharpe Ratio</div>
            <div class="adv-value" id="adv-sharpe">â€”</div>
          </div>
        </div>
      </section>

      <!-- Equity + tables -->
      <section class="section-grid">
        <div>
          <div class="section-title">Equity Curve</div>
          <div class="section-subtitle">Tracks paper-trading balance over time (USD).</div>
          <div class="chart-container">
            <canvas id="equity-chart" class="chart-inner"></canvas>
          </div>
        </div>

        <div>
          <div class="section-card">
            <div class="section-title">Per-Market Performance</div>
            <div class="section-subtitle">How the bot is doing on each market (paper trading).</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Market</th>
                    <th class="text-right">Trades</th>
                    <th class="text-right">Win Rate</th>
                    <th class="text-right">Total PnL</th>
                    <th class="text-right">Avg PnL</th>
                  </tr>
                </thead>
                <tbody id="per-market-body">
                  <tr>
                    <td colspan="5" class="muted">No markets yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">Recent Trades</div>
            <div class="section-subtitle">Showing last 20 closed trades.</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Market</th>
                    <th class="text-right">PnL (USD)</th>
                  </tr>
                </thead>
                <tbody id="recent-trades-body">
                  <tr>
                    <td colspan="3" class="muted">No trades yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- TradingView candlesticks -->
      <section class="section-card">
        <div class="section-title">Market Candlestick Charts</div>
        <div class="section-subtitle">
          Live BTC-USD candlesticks on your main venues. Charts are from TradingView only (they do not place trades).
        </div>

        <div class="card">
          <div class="card-row" style="margin-bottom: 10px">
            <div>Venue</div>
            <div class="tv-tabs">
              <button class="tv-tab active" data-symbol="COINBASE:BTCUSD">Coinbase</button>
              <button class="tv-tab" data-symbol="KUCOIN:BTCUSDT">KuCoin</button>
              <button class="tv-tab" data-symbol="CRYPTOCOM:BTCUSD">Crypto.com</button>
            </div>
          </div>

          <div class="tradingview-widget-container" style="height: 400px">
            <div id="tv-chart"></div>
          </div>

          <div class="section-subtitle" style="margin-top: 10px">
            If a chart fails to load for a venue, adjust the TradingView symbol in the HTML (e.g.
            <span class="muted">COINBASE:BTCUSD, KUCOIN:BTCUSDT, CRYPTOCOM:BTCUSD</span>).
          </div>
        </div>
      </section>

      <div class="footer">
        Bot is running on Render (paper trading only). Keep it training for 2â€“3 weeks before making AI changes.
      </div>
    </div>

    <!-- Chart.js for equity curve -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- TradingView widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
      // ------------------------------
      // Utilities
      // ------------------------------
      function $(id) {
        return document.getElementById(id);
      }

      function formatUsd(v) {
        if (v === null || v === undefined || isNaN(v)) return "â€”";
        const sign = v < 0 ? "-" : "";
        const abs = Math.abs(v);
        return (
          sign +
          "$" +
          abs.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })
        );
      }

      function formatPercent(v, digits = 1) {
        if (v === null || v === undefined || isNaN(v)) return "â€”";
        return v.toFixed(digits).replace(/^-0\.0+$/, "0.0") + "%";
      }

      function formatNumber(v, digits = 2) {
        if (v === null || v === undefined || isNaN(v)) return "â€”";
        return v.toFixed(digits);
      }

      function formatTime(iso) {
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return iso;
        return d.toLocaleString();
      }

      // ------------------------------
      // Equity Chart
      // ------------------------------
      let equityChart = null;

      function updateEquityChart(points) {
        const ctx = $("equity-chart");

        const labels = points.map((p) => {
          const t = p.time_utc || p.time || p.timeUTC || p.timestamp;
          const d = new Date(t);
          return Number.isNaN(d.getTime()) ? String(t) : d.toLocaleTimeString();
        });

        const data = points.map((p) => p.equity_usd);

        if (equityChart) {
          equityChart.data.labels = labels;
          equityChart.data.datasets[0].data = data;
          equityChart.update();
          return;
        }

        equityChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Equity (USD)",
                data,
                tension: 0.35,
                borderWidth: 2,
                pointRadius: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => "Equity: " + formatUsd(ctx.parsed.y),
                },
              },
            },
            scales: {
              x: {
                ticks: { maxTicksLimit: 6 },
                grid: { color: "rgba(31,41,55,0.6)" },
              },
              y: {
                ticks: { callback: (v) => "$" + v },
                grid: { color: "rgba(31,41,55,0.6)" },
              },
            },
          },
        });
      }

      // ------------------------------
      // Bot status
      // ------------------------------
      function updateBotStatus(status) {
        const dot = $("bot-status-dot");
        const label = $("bot-status-label");
        const minutesEl = $("bot-status-minutes");
        const lastEl = $("bot-status-last");

        const s = status?.status || "unknown";
        label.textContent = s.charAt(0).toUpperCase() + s.slice(1);
        dot.className = "status-dot status-" + s;

        // minutes_since might not exist in your API; keep it optional
        if (status?.minutes_since != null) {
          minutesEl.textContent = status.minutes_since + " min since heartbeat";
        } else {
          minutesEl.textContent = "";
        }

        if (status?.last_heartbeat) {
          lastEl.textContent = "Last heartbeat: " + formatTime(status.last_heartbeat);
        } else {
          lastEl.textContent = "Waiting for heartbeatâ€¦";
        }
      }

      // ------------------------------
      // Per-market + recent trades
      // ------------------------------
      function updatePerMarket(perMarket) {
        const body = $("per-market-body");
        body.innerHTML = "";

        if (!perMarket || perMarket.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5;
          cell.className = "muted";
          cell.textContent = "No markets yet.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        perMarket.forEach((m) => {
          const row = document.createElement("tr");

          const cMarket = document.createElement("td");
          cMarket.textContent = m.market;
          row.appendChild(cMarket);

          const cTrades = document.createElement("td");
          cTrades.className = "text-right";
          cTrades.textContent = m.trades;
          row.appendChild(cTrades);

          const cWin = document.createElement("td");
          cWin.className = "text-right";
          cWin.textContent = formatPercent(m.win_rate, 1);
          row.appendChild(cWin);

          // backend uses total_pnl and avg_pnl; older UI might expect *_usd
          const total = m.total_pnl_usd ?? m.total_pnl ?? 0;
          const avg = m.avg_pnl_usd ?? m.avg_pnl ?? 0;

          const cTotal = document.createElement("td");
          cTotal.className = "text-right";
          cTotal.textContent = formatUsd(total);
          row.appendChild(cTotal);

          const cAvg = document.createElement("td");
          cAvg.className = "text-right";
          cAvg.textContent = formatUsd(avg);
          row.appendChild(cAvg);

          body.appendChild(row);
        });
      }

      function updateRecentTrades(trades) {
        const body = $("recent-trades-body");
        body.innerHTML = "";

        if (!trades || trades.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.className = "muted";
          cell.textContent = "No trades yet.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        trades.forEach((t) => {
          const row = document.createElement("tr");

          const cTime = document.createElement("td");
          cTime.textContent = t.time ? formatTime(t.time) : "â€”";
          row.appendChild(cTime);

          const cMarket = document.createElement("td");
          cMarket.textContent = t.market || "â€”";
          row.appendChild(cMarket);

          const pnl = t.pnl_usd ?? 0;
          const cPnl = document.createElement("td");
          cPnl.className = "text-right";
          cPnl.textContent = formatUsd(pnl);
          row.appendChild(cPnl);

          body.appendChild(row);
        });
      }

      // ------------------------------
      // Advanced metrics
      // ------------------------------
      function updateAdvancedMetrics(adv, maxDdFallback) {
        // Your backend puts max_drawdown_usd in advanced_metrics already,
        // but we also accept fallback if passed.
        const pf = adv?.profit_factor;
        const avgWin = adv?.avg_win_usd;
        const avgLoss = adv?.avg_loss_usd;
        const best = adv?.best_trade_usd;
        const worst = adv?.worst_trade_usd;
        const maxDd = adv?.max_drawdown_usd ?? maxDdFallback;

        $("adv-profit-factor").textContent = pf == null ? "â€”" : formatNumber(pf, 2);
        $("adv-avg-win").textContent = avgWin == null ? "â€”" : formatUsd(avgWin);
        $("adv-avg-loss").textContent = avgLoss == null ? "â€”" : formatUsd(avgLoss);
        $("adv-best-trade").textContent = best == null ? "â€”" : formatUsd(best);
        $("adv-worst-trade").textContent = worst == null ? "â€”" : formatUsd(worst);
        $("adv-max-dd").textContent = maxDd == null ? "â€”" : formatUsd(maxDd);

        $("adv-recovery-factor").textContent = adv?.recovery_factor ?? "â€”";
        $("adv-sharpe").textContent = adv?.sharpe_ratio ?? "â€”";
      }

      // ------------------------------
      // TradingView
      // ------------------------------
      let currentSymbol = "COINBASE:BTCUSD";

      function loadTradingView(symbol) {
        currentSymbol = symbol;
        const container = $("tv-chart");
        container.innerHTML = "";

        new TradingView.widget({
          autosize: true,
          symbol: symbol,
          interval: "15",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "en",
          enable_publishing: false,
          withdateranges: true,
          allow_symbol_change: false,
          container_id: "tv-chart",
        });
      }

      function setupTvTabs() {
        const tabs = document.querySelectorAll(".tv-tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            loadTradingView(tab.dataset.symbol);
          });
        });
      }

      // ------------------------------
      // BOT PET (Egg -> Baby -> Cat -> Dog)
      // Rules:
      // - Egg until TOTAL PNL first becomes > 0
      // - After hatchingOnce=true, never go back to egg
      // - When not in profit: hungry/sad
      // - Wins add XP (growth), losses reduce XP slightly and increase hunger
      // ------------------------------
      const PET_KEY = "crypto_ai_bot_pet_v2";

      function loadPetState() {
        try {
          const raw = localStorage.getItem(PET_KEY);
          if (!raw) {
            return {
              xp: 0,
              hunger: 2,         // 0 full, higher = hungry
              hatchedOnce: false,
              lastTradeKey: "",
              lastTotalPnlSeen: null,
              lastUpdatedAt: Date.now(),
            };
          }
          const pet = JSON.parse(raw);
          // backfill fields
          pet.xp = Number.isFinite(pet.xp) ? pet.xp : 0;
          pet.hunger = Number.isFinite(pet.hunger) ? pet.hunger : 2;
          pet.hatchedOnce = !!pet.hatchedOnce;
          pet.lastTradeKey = pet.lastTradeKey || "";
          pet.lastTotalPnlSeen = (pet.lastTotalPnlSeen === null || pet.lastTotalPnlSeen === undefined)
            ? null
            : Number(pet.lastTotalPnlSeen);
          pet.lastUpdatedAt = Number.isFinite(pet.lastUpdatedAt) ? pet.lastUpdatedAt : Date.now();
          return pet;
        } catch {
          return {
            xp: 0,
            hunger: 2,
            hatchedOnce: false,
            lastTradeKey: "",
            lastTotalPnlSeen: null,
            lastUpdatedAt: Date.now(),
          };
        }
      }

      function savePetState(pet) {
        localStorage.setItem(PET_KEY, JSON.stringify(pet));
      }

      function resetPetState() {
        localStorage.removeItem(PET_KEY);
      }

      // Stage rules (never revert to egg after hatching)
      // 0 egg, 1 baby, 2 cat, 3 dog
      function stageFromHatching(totalPnl, xp, hatchedOnce) {
        if (!hatchedOnce) {
          return totalPnl > 0 ? 1 : 0;
        }
        // after hatchingOnce, never return 0
        if (xp < 10) return 1;
        if (xp < 22) return 2;
        return 3;
      }

      function clamp(n, min, max) {
        return Math.max(min, Math.min(max, n));
      }

      function pct(n, min, max) {
        if (max <= min) return 0;
        return clamp((n - min) / (max - min), 0, 1);
      }

      function svgEgg(mood) {
        // mood: "watching" | "happy" | "hungry" | "sad"
        const face = mood === "happy" ? "happy" : (mood === "hungry" || mood === "sad") ? "sad" : "neutral";
        const mouth =
          face === "happy"
            ? '<path d="M26 31c2.5 2.3 9.5 2.3 12 0" stroke="rgba(10,12,20,0.9)" stroke-width="2" fill="none" stroke-linecap="round"/>'
            : face === "sad"
            ? '<path d="M26 34c2.5-2.3 9.5-2.3 12 0" stroke="rgba(10,12,20,0.9)" stroke-width="2" fill="none" stroke-linecap="round"/>'
            : '<path d="M28 33h10" stroke="rgba(10,12,20,0.9)" stroke-width="2" stroke-linecap="round"/>';

        const eyes =
          face === "sad"
            ? '<path d="M25 26l4 3M29 26l-4 3" stroke="rgba(10,12,20,0.9)" stroke-width="2" stroke-linecap="round"/><path d="M39 26l4 3M43 26l-4 3" stroke="rgba(10,12,20,0.9)" stroke-width="2" stroke-linecap="round"/>'
            : '<circle cx="28" cy="27" r="2.2" fill="rgba(10,12,20,0.9)"/><circle cx="42" cy="27" r="2.2" fill="rgba(10,12,20,0.9)"/>';

        return `
          <svg class="pet-svg" viewBox="0 0 64 52" xmlns="http://www.w3.org/2000/svg" aria-label="Egg pet">
            <defs>
              <linearGradient id="g1" x1="0" x2="1">
                <stop offset="0" stop-color="rgba(255,255,255,0.75)"/>
                <stop offset="1" stop-color="rgba(180,210,255,0.35)"/>
              </linearGradient>
              <linearGradient id="g2" x1="0" x2="1">
                <stop offset="0" stop-color="rgba(70,85,140,0.35)"/>
                <stop offset="1" stop-color="rgba(0,0,0,0.18)"/>
              </linearGradient>
            </defs>
            <ellipse cx="32" cy="28" rx="18" ry="20" fill="url(#g1)" stroke="rgba(255,255,255,0.14)" stroke-width="1.2"/>
            <ellipse cx="32" cy="31" rx="16" ry="16" fill="url(#g2)" opacity="0.35"/>
            ${eyes}
            ${mouth}
            ${mood === "hungry" ? '<path d="M18 12h10" stroke="rgba(239,68,68,0.9)" stroke-width="2" stroke-linecap="round"/><path d="M46 12h-10" stroke="rgba(239,68,68,0.9)" stroke-width="2" stroke-linecap="round"/>' : ""}
          </svg>
        `;
      }

      function svgBaby(mood) {
        const mouth =
          mood === "happy"
            ? '<path d="M26 34c2.5 2.3 9.5 2.3 12 0" stroke="rgba(10,12,20,0.9)" stroke-width="2" fill="none" stroke-linecap="round"/>'
            : mood === "hungry" || mood === "sad"
            ? '<path d="M26 36c2.5-2.3 9.5-2.3 12 0" stroke="rgba(10,12,20,0.9)" stroke-width="2" fill="none" stroke-linecap="round"/>'
            : '<path d="M28 35h10" stroke="rgba(10,12,20,0.9)" stroke-width="2" stroke-linecap="round"/>';

        return `
          <svg class="pet-svg" viewBox="0 0 64 52" xmlns="http://www.w3.org/2000/svg" aria-label="Baby pet">
            <defs>
              <linearGradient id="b1" x1="0" x2="1">
                <stop offset="0" stop-color="rgba(255,255,255,0.55)"/>
                <stop offset="1" stop-color="rgba(120,200,255,0.25)"/>
              </linearGradient>
            </defs>
            <rect x="16" y="10" width="32" height="36" rx="16" fill="url(#b1)" stroke="rgba(255,255,255,0.14)" stroke-width="1.2"/>
            <circle cx="28" cy="28" r="2.2" fill="rgba(10,12,20,0.9)"/>
            <circle cx="42" cy="28" r="2.2" fill="rgba(10,12,20,0.9)"/>
            ${mouth}
            ${mood === "hungry" ? '<path d="M20 14h24" stroke="rgba(239,68,68,0.85)" stroke-width="2" stroke-linecap="round" opacity="0.7"/>' : ""}
          </svg>
        `;
      }

      function svgCat(mood) {
        const eyes =
          mood === "sad" || mood === "hungry"
            ? '<path d="M24 26l5 3M29 26l-5 3" stroke="rgba(10,12,20,0.9)" stroke-width="2" stroke-linecap="round"/><path d="M40 26l5 3M45 26l-5 3" stroke="rgba(10,12,20,0.9)" stroke-width="2" stroke-linecap="round"/>'
            : '<circle cx="27" cy="27" r="2.2" fill="rgba(10,12,20,0.9)"/><circle cx="43" cy="27" r="2.2" fill="rgba(10,12,20,0.9)"/>';

        const mouth =
          mood === "happy"
            ? '<path d="M28 34c1.8 1.8 6.2 1.8 8 0" stroke="rgba(10,12,20,0.9)" stroke-width="2" fill="none" stroke-linecap="round"/>'
            : mood === "sad" || mood === "hungry"
            ? '<path d="M28 36c1.8-1.8 6.2-1.8 8 0" stroke="rgba(10,12,20,0.9)" stroke-width="2" fill="none" stroke-linecap="round"/>'
            : '<path d="M30 35h6" stroke="rgba(10,12,20,0.9)" stroke-width="2" stroke-linecap="round"/>';

        return `
          <svg class="pet-svg" viewBox="0 0 64 52" xmlns="http://www.w3.org/2000/svg" aria-label="Cat pet">
            <defs>
              <linearGradient id="c1" x1="0" x2="1">
                <stop offset="0" stop-color="rgba(255,255,255,0.55)"/>
                <stop offset="1" stop-color="rgba(200,255,220,0.25)"/>
              </linearGradient>
            </defs>
            <path d="M18 20l6-10 8 7h0l8-7 6 10v18c0 6-6 10-14 10h-0c-8 0-14-4-14-10V20z"
              fill="url(#c1)" stroke="rgba(255,255,255,0.14)" stroke-width="1.2" />
            ${eyes}
            ${mouth}
            ${mood === "hungry" ? '<path d="M18 16h10" stroke="rgba(239,68,68,0.9)" stroke-width="2" stroke-linecap="round"/><path d="M46 16h-10" stroke="rgba(239,68,68,0.9)" stroke-width="2" stroke-linecap="round"/>' : ""}
          </svg>
        `;
      }

      function svgDog(mood) {
        const eyes =
          mood === "sad" || mood === "hungry"
            ? '<path d="M24 26l5 3M29 26l-5 3" stroke="rgba(10,12,20,0.9)" stroke-width="2" stroke-linecap="round"/><path d="M40 26l5 3M45 26l-5 3" stroke="rgba(10,12,20,0.9)" stroke-width="2" stroke-linecap="round"/>'
            : '<circle cx="27" cy="27" r="2.2" fill="rgba(10,12,20,0.9)"/><circle cx="43" cy="27" r="2.2" fill="rgba(10,12,20,0.9)"/>';

        const mouth =
          mood === "happy"
            ? '<path d="M28 35c2.2 2.2 5.8 2.2 8 0" stroke="rgba(10,12,20,0.9)" stroke-width="2" fill="none" stroke-linecap="round"/><circle cx="32" cy="36" r="1.5" fill="rgba(10,12,20,0.9)"/>'
            : mood === "sad" || mood === "hungry"
            ? '<path d="M28 37c2.2-2.2 5.8-2.2 8 0" stroke="rgba(10,12,20,0.9)" stroke-width="2" fill="none" stroke-linecap="round"/><circle cx="32" cy="35.5" r="1.5" fill="rgba(10,12,20,0.9)"/>'
            : '<circle cx="32" cy="35.5" r="1.8" fill="rgba(10,12,20,0.9)"/>';

        return `
          <svg class="pet-svg" viewBox="0 0 64 52" xmlns="http://www.w3.org/2000/svg" aria-label="Dog pet">
            <defs>
              <linearGradient id="d1" x1="0" x2="1">
                <stop offset="0" stop-color="rgba(255,255,255,0.55)"/>
                <stop offset="1" stop-color="rgba(255,220,190,0.22)"/>
              </linearGradient>
            </defs>
            <path d="M18 20c0-8 8-12 14-12s14 4 14 12v18c0 6-6 10-14 10s-14-4-14-10V20z"
              fill="url(#d1)" stroke="rgba(255,255,255,0.14)" stroke-width="1.2"/>
            <path d="M18 22c-6 2-7 8-3 12 3 3 6 2 7-1" fill="rgba(255,255,255,0.12)"/>
            <path d="M46 22c6 2 7 8 3 12-3 3-6 2-7-1" fill="rgba(255,255,255,0.12)"/>
            ${eyes}
            ${mouth}
            ${mood === "hungry" ? '<path d="M16 16h12" stroke="rgba(239,68,68,0.9)" stroke-width="2" stroke-linecap="round"/><path d="M48 16h-12" stroke="rgba(239,68,68,0.9)" stroke-width="2" stroke-linecap="round"/>' : ""}
          </svg>
        `;
      }

      function petSvgFor(stage, mood) {
        if (stage === 0) return svgEgg(mood);
        if (stage === 1) return svgBaby(mood);
        if (stage === 2) return svgCat(mood);
        return svgDog(mood);
      }

      function stageLabel(stage) {
        return stage === 0 ? "Egg" : stage === 1 ? "Hatchling" : stage === 2 ? "Cat" : "Dog";
      }

      function renderPet(data) {
        const pet = loadPetState();

        const totalPnl = Number(data?.total_pnl_usd ?? 0);
        const wins = Number(data?.wins ?? 0);
        const losses = Number(data?.losses ?? 0);
        const recent = Array.isArray(data?.recent_trades) ? data.recent_trades : [];

        // Hatch forever the first time total pnl goes positive
        if (!pet.hatchedOnce && totalPnl > 0) {
          pet.hatchedOnce = true;
        }

        // Detect newest trade (first item is most recent in your API)
        let newestKey = "";
        let newestPnl = null;
        let newestMarket = "";
        if (recent.length > 0) {
          const t = recent[0];
          newestMarket = t.market || "";
          newestPnl = Number(t.pnl_usd ?? 0);
          newestKey = (t.time || "") + "|" + (t.market || "") + "|" + String(t.pnl_usd ?? "");
        }

        // Update XP/hunger only when a new trade arrives
        if (newestKey && newestKey !== pet.lastTradeKey) {
          pet.lastTradeKey = newestKey;

          if (newestPnl != null && newestPnl > 0) {
            // win = food
            pet.xp += 2;
            pet.hunger = clamp(pet.hunger - 1, 0, 10);
          } else {
            // loss = empty plate
            pet.xp -= 1;
            pet.hunger = clamp(pet.hunger + 1, 0, 10);
          }

          // Keep XP in sensible bounds
          pet.xp = clamp(pet.xp, 0, 40);
        }

        // Decide stage
        const stage = stageFromHatching(totalPnl, pet.xp, pet.hatchedOnce);

        // Mood rules
        // - Egg: watching/pacing until profitable
        // - Hatched: happy if in profit, hungry/sad if not
        let mood = "watching";
        let title = "Watchingâ€¦";
        let sub = "Waiting for trades";
        let hint = "Egg stays until the bot first goes profitable. Wins feed it ðŸ¥£.";

        const isWaiting = recent.length === 0;
        const inProfit = totalPnl > 0;

        if (stage === 0) {
          mood = isWaiting ? "watching" : "watching";
          title = "Egg ðŸ¥š";
          sub = inProfit ? "Crackingâ€¦" : "Needs first profit to hatch";
          hint = "Once TOTAL PnL goes above $0, it hatches forever.";
        } else {
          // hatched forever
          if (inProfit) {
            mood = "happy";
            title = "Happy ðŸ˜º";
            if (newestPnl != null && newestPnl > 0 && newestMarket) {
              sub = `Yum! ${newestMarket} +${formatUsd(newestPnl).replace("-", "")}`;
            } else {
              sub = "Wins are food ðŸ¥£";
            }
            hint = "Wins feed it. More wins = it grows.";
          } else {
            // not in profit
            if (pet.hunger >= 6) {
              mood = "hungry";
              title = "Hungry ðŸ˜¿";
              sub = "Losses = empty plateâ€¦ needs wins (food)";
              hint = "Get back into profit to cheer it up.";
            } else {
              mood = "sad";
              title = "Sad ðŸ™€";
              sub = "Not in profitâ€¦ keep it steady";
              hint = "One good run and it perks up.";
            }
          }
        }

        // Add a little pacing when waiting for trades
        const inner = $("pet-inner");
        inner.classList.remove("pet-pacing", "pet-shiver");
        if (stage === 0 || isWaiting) inner.classList.add("pet-pacing");
        if ((mood === "sad" || mood === "hungry") && stage !== 0) inner.classList.add("pet-shiver");

        // Inject SVG
        inner.innerHTML = petSvgFor(stage, mood);

        // Update labels
        $("pet-title").textContent = title;
        $("pet-sub").textContent = sub;
        $("pet-stage").textContent = stageLabel(stage);
        $("pet-hint").textContent = hint;

        // XP bar (growth progress)
        const xpBar = $("pet-xp-bar");
        const fill = xpBar.querySelector("div");
        // progress toward next stage
        let p = 0;
        if (!pet.hatchedOnce) {
          p = 0;
        } else if (stage === 1) {
          p = pct(pet.xp, 0, 10);
        } else if (stage === 2) {
          p = pct(pet.xp, 10, 22);
        } else {
          p = 1;
        }
        fill.style.width = Math.round(p * 100) + "%";

        // bar color
        xpBar.classList.remove("red");
        if (mood === "hungry" || mood === "sad") xpBar.classList.add("red");

        // Save state
        savePetState(pet);
      }

      // ------------------------------
      // Fetch + hydrate dashboard
      // ------------------------------
      async function refreshDashboard() {
        try {
          const res = await fetch("/data", { cache: "no-store" });
          const data = await res.json();

          // Top metrics (use your backend keys)
          $("metric-total-trades").textContent = data.total_trades ?? 0;
          $("metric-wins").textContent = (data.wins ?? 0) + " wins";
          $("metric-losses").textContent = (data.losses ?? 0) + " losses";

          const winRate = data.win_rate != null ? data.win_rate : 0;
          $("metric-win-rate").textContent = formatPercent(winRate, 1);

          const avgPnl = (data.total_trades ?? 0) > 0 ? (Number(data.total_pnl_usd ?? 0) / Number(data.total_trades ?? 1)) : 0;
          $("metric-avg-pnl").textContent = formatUsd(avgPnl);

          const totalPnl = Number(data.total_pnl_usd ?? 0);
          const pnlEl = $("metric-total-pnl");
          pnlEl.textContent = formatUsd(totalPnl);
          pnlEl.classList.remove("positive", "negative");
          pnlEl.classList.add(totalPnl >= 0 ? "positive" : "negative");

          // Equity
          updateEquityChart(data.equity_curve || []);

          // Bot status
          updateBotStatus(data.bot_status);

          // Per-market & trades
          updatePerMarket(data.per_market || []);
          updateRecentTrades(data.recent_trades || []);

          // Advanced
          updateAdvancedMetrics(data.advanced_metrics, data.max_drawdown_usd);

          // Pet
          renderPet(data);
        } catch (err) {
          console.error("Failed to refresh dashboard", err);
        }
      }

      // ------------------------------
      // Init
      // ------------------------------
      document.addEventListener("DOMContentLoaded", () => {
        setupTvTabs();
        loadTradingView(currentSymbol);

        $("pet-reset-btn").addEventListener("click", () => {
          resetPetState();
          refreshDashboard();
        });

        refreshDashboard();
        setInterval(refreshDashboard, 10_000);
      });
    </script>
  </body>
  </html>
