<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crypto AI Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #050814;
        --bg-card: #101522;
        --bg-card-soft: #141b2c;
        --text-main: #f8f4fc;
        --text-muted: #9ca3af;
        --accent: #22c55e;
        --accent-red: #ef4444;
        --accent-blue: #3b82f6;
        --border-soft: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text-main);
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        margin-bottom: 24px;
      }

      h1 {
        margin: 0 0 4px;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      header p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted);
      }

      header a {
        color: #38bdf8;
        text-decoration: none;
        margin-left: 4px;
        margin-right: 4px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .card {
        background: linear-gradient(145deg, var(--bg-card), #060b17);
        border-radius: 14px;
        padding: 14px 16px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      }

      .card h2 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .metric-main {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .metric-sub {
        font-size: 12px;
        color: var(--text-muted);
      }

      .metric-main.positive {
        color: var(--accent);
      }

      .metric-main.negative {
        color: var(--accent-red);
      }

      .card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.8);
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
      }

      .status-running {
        background-color: #22c55e;
      }

      .status-idle {
        background-color: #eab308;
      }

      .status-stopped {
        background-color: #ef4444;
      }

      .status-unknown {
        background-color: #6b7280;
      }

      .section-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .section-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin: 0 0 12px;
      }

      .section-card {
        margin-bottom: 24px;
      }

      .chart-container {
        height: 260px;
        background: radial-gradient(circle at top, #020617, #020617);
        border-radius: 14px;
        border: 1px solid var(--border-soft);
        overflow: hidden;
      }

      .chart-inner {
        width: 100%;
        height: 100%;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      thead {
        background: rgba(15, 23, 42, 0.9);
      }

      th,
      td {
        padding: 8px 10px;
        text-align: left;
      }

      th {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-bottom: 1px solid var(--border-soft);
      }

      tbody tr:nth-child(odd) {
        background: rgba(15, 23, 42, 0.4);
      }

      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.1);
      }

      tbody tr:hover {
        background: rgba(55, 65, 81, 0.4);
      }

      .text-right {
        text-align: right;
      }

      .muted {
        color: var(--text-muted);
      }

      .section-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
        gap: 16px;
      }

      @media (max-width: 900px) {
        .section-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .advanced-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px 14px;
        margin-top: 6px;
      }

      .adv-label {
        font-size: 11px;
        color: var(--text-muted);
      }

      .adv-value {
        font-size: 14px;
        font-weight: 600;
      }

      /* TradingView area */
      .tv-tabs {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        padding: 2px;
        margin-bottom: 8px;
      }

      .tv-tab {
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        cursor: pointer;
      }

      .tv-tab.active {
        background: #0f172a;
        color: var(--text-main);
      }

      .footer {
        margin-top: 18px;
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
      }

      /* ------------------------------
         BOT PET
      ------------------------------ */
      .pet-wrap {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .pet-box {
        position: relative;
        width: 112px;
        height: 86px;
        border-radius: 16px;
        border: 1px solid rgba(31, 41, 55, 0.85);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03),
          0 12px 28px rgba(0, 0, 0, 0.4);
        overflow: hidden;

        background: radial-gradient(circle at 30% 20%, rgba(56, 189, 248, 0.22), transparent 55%),
          radial-gradient(circle at 70% 80%, rgba(34, 197, 94, 0.10), transparent 55%),
          linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      }

      .pet-box::after {
        content: "";
        position: absolute;
        left: 10px;
        right: 10px;
        bottom: 8px;
        height: 10px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.14);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
        opacity: 0.7;
      }

      .pet-screen {
        position: absolute;
        left: 10px;
        top: 10px;
        right: 10px;
        bottom: 18px;
        border-radius: 12px;
        background: radial-gradient(circle at top, rgba(180, 212, 196, 0.22), rgba(11, 18, 33, 0.95));
        border: 1px solid rgba(180, 212, 196, 0.18);
        overflow: hidden;
      }

      .pet-scan {
        position: absolute;
        left: 10px;
        right: 10px;
        top: 10px;
        bottom: 18px;
        border-radius: 12px;
        pointer-events: none;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.05),
          transparent 25%,
          rgba(255, 255, 255, 0.02),
          transparent 60%
        );
        mix-blend-mode: screen;
        opacity: 0.35;
        animation: scan 3.2s linear infinite;
      }

      @keyframes scan {
        0% {
          transform: translateY(-40%);
        }
        100% {
          transform: translateY(40%);
        }
      }

      .pet-sprite {
        position: absolute;
        left: 0;
        top: 0;
        width: 112px;
        height: 86px;
        padding: 0;
        pointer-events: none;
        filter: drop-shadow(0 2px 0 rgba(0, 0, 0, 0.35));
      }

      .plate {
        position: absolute;
        left: 44px;
        bottom: 20px;
        width: 38px;
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(226, 232, 240, 0.18);
        background: rgba(226, 232, 240, 0.06);
        opacity: 0.9;
      }

      .food {
        position: absolute;
        left: 58px;
        bottom: 24px;
        width: 10px;
        height: 10px;
        border-radius: 3px;
        background: rgba(34, 197, 94, 0.75);
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.25);
        opacity: 0;
        transform: translateY(2px) scale(0.9);
      }

      .pet-fed .food {
        opacity: 1;
        transform: translateY(0) scale(1);
        transition: opacity 220ms ease, transform 220ms ease;
      }

      .pet-hungryHint {
        position: absolute;
        left: 50%;
        top: 36px;
        transform: translateX(-50%);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 10px;
        letter-spacing: 0.12em;
        color: rgba(239, 68, 68, 0.9);
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.6);
        opacity: 0;
        pointer-events: none;
      }

      .pet-hungry .pet-hungryHint {
        opacity: 1;
      }

      .pet-pace #pet-sprite {
        animation: pace 1.6s ease-in-out infinite;
      }

      @keyframes pace {
        0% {
          transform: translateX(-3px);
        }
        50% {
          transform: translateX(3px);
        }
        100% {
          transform: translateX(-3px);
        }
      }

      /* --- LCD icons row --- */
      .lcd-icons {
        position: absolute;
        left: 10px;
        right: 10px;
        top: 6px;
        display: flex;
        justify-content: space-between;
        gap: 6px;
        font-size: 10px;
        opacity: 0.9;
        filter: saturate(0.85);
        pointer-events: none;
      }

      .lcd-ic {
        opacity: 0.35;
        transform: translateY(0px);
        transition: opacity 220ms ease, transform 220ms ease;
      }

      .lcd-ic.on {
        opacity: 0.95;
        transform: translateY(-1px);
      }

      /* --- LEVEL UP overlay + sparkles --- */
      .levelup {
        position: absolute;
        left: 50%;
        top: 52%;
        transform: translate(-50%, -50%) scale(0.9);
        padding: 6px 8px;
        border-radius: 10px;
        background: rgba(2, 6, 23, 0.75);
        border: 1px solid rgba(180, 212, 196, 0.25);
        color: rgba(248, 244, 252, 0.95);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 10px;
        letter-spacing: 0.08em;
        opacity: 0;
        pointer-events: none;
      }

      .sparkles {
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0;
      }

      .sp {
        position: absolute;
        font-size: 10px;
        opacity: 0;
      }

      .sp.s1 {
        left: 14px;
        top: 18px;
      }
      .sp.s2 {
        right: 16px;
        top: 16px;
      }
      .sp.s3 {
        left: 18px;
        bottom: 18px;
      }
      .sp.s4 {
        right: 18px;
        bottom: 16px;
      }
      .sp.s5 {
        left: 50%;
        top: 52%;
        transform: translate(-50%, -50%);
      }

      .pet-levelup .levelup {
        animation: lvl 900ms ease-out 1;
      }

      @keyframes lvl {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.85);
        }
        20% {
          opacity: 1;
          transform: translate(-50%, -58%) scale(1);
        }
        70% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -64%) scale(0.92);
        }
      }

      .pet-levelup .sparkles {
        opacity: 1;
      }

      .pet-levelup .sp {
        animation: spk 800ms ease-out 1;
      }

      @keyframes spk {
        0% {
          opacity: 0;
          transform: translateY(6px) scale(0.7);
        }
        20% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translateY(-10px) scale(1.05);
        }
      }

      .pet-text h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.02em;
      }

      .pet-text p {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--text-muted);
      }

      .pet-bad {
        color: #f87171;
      }
      .pet-good {
        color: #34d399;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header>
        <h1>Crypto AI Bot Dashboard</h1>
        <p>
          Paper-trading stats from Render ‚Äî
          <a href="/data" target="_blank">raw stats</a>
        </p>
      </header>

      <!-- Top KPIs -->
      <section class="cards">
        <div class="card">
          <h2>Total Trades</h2>
          <div class="metric-main" id="metric-total-trades">0</div>
          <div class="metric-sub">
            <span id="metric-wins">0 wins</span> /
            <span id="metric-losses">0 losses</span>
          </div>
        </div>

        <div class="card">
          <h2>Win Rate</h2>
          <div class="metric-main" id="metric-win-rate">0%</div>
          <div class="metric-sub">
            Avg <span id="metric-avg-pnl">-$0.00</span> per trade
          </div>
        </div>

        <div class="card">
          <h2>PNL (Total)</h2>
          <div class="metric-main negative" id="metric-total-pnl">$0.00</div>
          <div class="metric-sub">Based on closed trades only.</div>
        </div>

        <div class="card">
          <h2>Bot Status</h2>
          <div class="card-row" style="margin-bottom: 6px">
            <div class="status-pill" id="bot-status-pill">
              <span class="status-dot status-unknown" id="bot-status-dot"></span>
              <span id="bot-status-label">Unknown</span>
            </div>
            <span class="muted" id="bot-status-minutes"></span>
          </div>
          <div class="metric-sub" id="bot-status-last">Waiting for heartbeat‚Ä¶</div>
        </div>

        <div class="card">
          <h2>Bot Pet</h2>
          <div class="pet-wrap">
            <div class="pet-box" id="pet-box">
              <div class="pet-screen">
                <div class="lcd-icons">
                  <span class="lcd-ic" id="ic-food" title="Food">üçΩÔ∏è</span>
                  <span class="lcd-ic" id="ic-play" title="Play">üéÆ</span>
                  <span class="lcd-ic" id="ic-health" title="Health">üíä</span>
                  <span class="lcd-ic" id="ic-clean" title="Clean">üßº</span>
                  <span class="lcd-ic" id="ic-love" title="Love">‚ù§Ô∏è</span>
                </div>

                <div class="levelup" id="pet-levelup">LEVEL UP!</div>

                <div class="sparkles" id="pet-sparkles" aria-hidden="true">
                  <span class="sp s1">‚ú¶</span>
                  <span class="sp s2">‚ú¶</span>
                  <span class="sp s3">‚ú¶</span>
                  <span class="sp s4">‚ú¶</span>
                  <span class="sp s5">‚ú¶</span>
                </div>
              </div>

              <div class="pet-scan"></div>
              <div class="pet-hungryHint">HUNGRY</div>

              <svg
                class="pet-sprite"
                id="pet-sprite"
                viewBox="0 0 64 64"
                xmlns="http://www.w3.org/2000/svg"
              ></svg>

              <div class="plate"></div>
              <div class="food"></div>
            </div>

            <div class="pet-text">
              <div class="card-row" style="margin-bottom: 2px">
                <div class="muted" style="letter-spacing: 0.12em">MOOD</div>
              </div>
              <h3 id="pet-mood">Watching‚Ä¶</h3>
              <p id="pet-sub">Waiting for trades</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Advanced Analytics -->
      <section class="card section-card">
        <div class="card-row" style="margin-bottom: 6px">
          <div>
            <div class="section-title">Advanced Analytics</div>
            <div class="section-subtitle">Deeper stats from your closed trades.</div>
          </div>
        </div>

        <div class="advanced-grid">
          <div>
            <div class="adv-label">Profit Factor</div>
            <div class="adv-value" id="adv-profit-factor">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Avg Win (USD)</div>
            <div class="adv-value" id="adv-avg-win">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Avg Loss (USD)</div>
            <div class="adv-value" id="adv-avg-loss">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Best Trade (USD)</div>
            <div class="adv-value" id="adv-best-trade">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Worst Trade (USD)</div>
            <div class="adv-value" id="adv-worst-trade">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Max Drawdown (USD)</div>
            <div class="adv-value" id="adv-max-dd">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Recovery Factor</div>
            <div class="adv-value" id="adv-recovery-factor">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Sharpe Ratio</div>
            <div class="adv-value" id="adv-sharpe">‚Äî</div>
          </div>
        </div>
      </section>

      <!-- Equity + tables -->
      <section class="section-grid">
        <div>
          <div class="section-title">Equity Curve</div>
          <div class="section-subtitle">Tracks paper-trading balance over time (USD).</div>
          <div class="chart-container">
            <canvas id="equity-chart" class="chart-inner"></canvas>
          </div>
        </div>

        <div>
          <div class="section-card">
            <div class="section-title">Per-Market Performance</div>
            <div class="section-subtitle">How the bot is doing on each market (paper trading).</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Market</th>
                    <th class="text-right">Trades</th>
                    <th class="text-right">Win Rate</th>
                    <th class="text-right">Total PnL</th>
                    <th class="text-right">Avg PnL</th>
                  </tr>
                </thead>
                <tbody id="per-market-body">
                  <tr>
                    <td colspan="5" class="muted">No markets yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">Recent Trades</div>
            <div class="section-subtitle">Showing last 20 closed trades.</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Market</th>
                    <th class="text-right">PnL (USD)</th>
                  </tr>
                </thead>
                <tbody id="recent-trades-body">
                  <tr>
                    <td colspan="3" class="muted">No trades yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- TradingView candlesticks -->
      <section class="section-card">
        <div class="section-title">Market Candlestick Charts</div>
        <div class="section-subtitle">
          Live BTC-USD candlesticks on your main venues. Charts are from TradingView only (they do not place trades).
        </div>

        <div class="card">
          <div class="card-row" style="margin-bottom: 10px">
            <div>Venue</div>
            <div class="tv-tabs">
              <button class="tv-tab active" data-symbol="COINBASE:BTCUSD">Coinbase</button>
              <button class="tv-tab" data-symbol="KUCOIN:BTCUSDT">KuCoin</button>
              <button class="tv-tab" data-symbol="CRYPTOCOM:BTCUSD">Crypto.com</button>
            </div>
          </div>

          <div class="tradingview-widget-container" style="height: 400px">
            <div id="tv-chart"></div>
          </div>

          <div class="section-subtitle" style="margin-top: 10px">
            If a chart fails to load for a venue, adjust the TradingView symbol in the HTML
            (e.g. <span class="muted">COINBASE:BTCUSD, KUCOIN:BTCUSDT, CRYPTOCOM:BTCUSD</span>).
          </div>
        </div>
      </section>

      <div class="footer">
        Bot is running on Render (paper trading only). Keep it training for 2‚Äì3 weeks before making AI changes.
      </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- TradingView -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
      // ------------------------------
      // Utilities
      // ------------------------------
      function $(id) {
        return document.getElementById(id);
      }

      function formatUsd(v) {
        if (v === null || v === undefined || isNaN(v)) return "‚Äî";
        const sign = v < 0 ? "-" : "";
        const abs = Math.abs(v);
        return (
          sign +
          "$" +
          abs.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })
        );
      }

      function formatPercent(v, digits = 1) {
        if (v === null || v === undefined || isNaN(v)) return "‚Äî";
        return v.toFixed(digits).replace(/^-0\.0+$/, "0.0") + "%";
      }

      function formatNumber(v, digits = 2) {
        if (v === null || v === undefined || isNaN(v)) return "‚Äî";
        return v.toFixed(digits);
      }

      function formatTime(iso) {
        if (!iso) return "‚Äî";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return String(iso);
        return d.toLocaleString();
      }

      // ------------------------------
      // Equity Chart
      // ------------------------------
      let equityChart = null;

      function updateEquityChart(points) {
        const ctx = $("equity-chart");
        const safePoints = (points || []).map((p) => ({
          time: p.time_utc || p.time || p.timeUTC || p.timeUtc || null,
          equity_usd: p.equity_usd,
        }));

        const labels = safePoints.map((p, idx) => {
          const t = p.time ? new Date(p.time) : null;
          return t && !Number.isNaN(t.getTime())
            ? t.toLocaleTimeString()
            : "t+" + idx;
        });

        const data = safePoints.map((p) => p.equity_usd);

        if (equityChart) {
          equityChart.data.labels = labels;
          equityChart.data.datasets[0].data = data;
          equityChart.update();
          return;
        }

        equityChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Equity (USD)",
                data,
                tension: 0.35,
                borderWidth: 2,
                pointRadius: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => "Equity: " + formatUsd(ctx.parsed.y),
                },
              },
            },
            scales: {
              x: {
                ticks: { maxTicksLimit: 6 },
                grid: { color: "rgba(31,41,55,0.6)" },
              },
              y: {
                ticks: { callback: (v) => "$" + v },
                grid: { color: "rgba(31,41,55,0.6)" },
              },
            },
          },
        });
      }

      // ------------------------------
      // Bot status
      // ------------------------------
      function updateBotStatus(status) {
        const dot = $("bot-status-dot");
        const label = $("bot-status-label");
        const minutesEl = $("bot-status-minutes");
        const lastEl = $("bot-status-last");

        const s = status?.status || "unknown";
        label.textContent = s.charAt(0).toUpperCase() + s.slice(1);
        dot.className = "status-dot status-" + s;

        // minutes_since is not in your app.py right now - so just show heartbeat time
        minutesEl.textContent = "";

        if (status?.last_heartbeat) {
          lastEl.textContent = "Last heartbeat: " + formatTime(status.last_heartbeat);
        } else {
          lastEl.textContent = "Waiting for heartbeat‚Ä¶";
        }
      }

      // ------------------------------
      // Advanced metrics
      // ------------------------------
      function updateAdvancedMetrics(adv, maxDrawdownOverride) {
        $("adv-profit-factor").textContent = adv?.profit_factor == null ? "‚Äî" : formatNumber(adv.profit_factor, 2);
        $("adv-avg-win").textContent = formatUsd(adv?.avg_win_usd ?? 0);
        $("adv-avg-loss").textContent = formatUsd(adv?.avg_loss_usd ?? 0);
        $("adv-best-trade").textContent = adv?.best_trade_usd == null ? "‚Äî" : formatUsd(adv.best_trade_usd);
        $("adv-worst-trade").textContent = adv?.worst_trade_usd == null ? "‚Äî" : formatUsd(adv.worst_trade_usd);

        const mdd = adv?.max_drawdown_usd ?? maxDrawdownOverride;
        $("adv-max-dd").textContent = mdd == null ? "‚Äî" : formatUsd(mdd);

        $("adv-recovery-factor").textContent = adv?.recovery_factor == null ? "‚Äî" : formatNumber(adv.recovery_factor, 2);
        $("adv-sharpe").textContent = adv?.sharpe_ratio == null ? "‚Äî" : formatNumber(adv.sharpe_ratio, 2);
      }

      // ------------------------------
      // Per-market + recent trades
      // ------------------------------
      function updatePerMarket(perMarket) {
        const body = $("per-market-body");
        body.innerHTML = "";

        if (!perMarket || perMarket.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5;
          cell.className = "muted";
          cell.textContent = "No markets yet.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        perMarket.forEach((m) => {
          const row = document.createElement("tr");

          const cMarket = document.createElement("td");
          cMarket.textContent = m.market;
          row.appendChild(cMarket);

          const cTrades = document.createElement("td");
          cTrades.className = "text-right";
          cTrades.textContent = m.trades;
          row.appendChild(cTrades);

          const cWin = document.createElement("td");
          cWin.className = "text-right";
          cWin.textContent = formatPercent(m.win_rate, 1);
          row.appendChild(cWin);

          const cTotal = document.createElement("td");
          cTotal.className = "text-right";
          cTotal.textContent = formatUsd(m.total_pnl ?? m.total_pnl_usd ?? 0);
          row.appendChild(cTotal);

          const cAvg = document.createElement("td");
          cAvg.className = "text-right";
          cAvg.textContent = formatUsd(m.avg_pnl ?? m.avg_pnl_usd ?? 0);
          row.appendChild(cAvg);

          body.appendChild(row);
        });
      }

      function updateRecentTrades(trades) {
        const body = $("recent-trades-body");
        body.innerHTML = "";

        if (!trades || trades.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.className = "muted";
          cell.textContent = "No trades yet.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        trades.forEach((t) => {
          const row = document.createElement("tr");

          const cTime = document.createElement("td");
          cTime.textContent = t.time ? formatTime(t.time) : "‚Äî";
          row.appendChild(cTime);

          const cMkt = document.createElement("td");
          cMkt.textContent = t.market || "‚Äî";
          row.appendChild(cMkt);

          const cPnl = document.createElement("td");
          cPnl.className = "text-right";
          cPnl.textContent = formatUsd(t.pnl_usd ?? 0);
          row.appendChild(cPnl);

          body.appendChild(row);
        });
      }

      // ------------------------------
      // TradingView
      // ------------------------------
      let currentSymbol = "COINBASE:BTCUSD";
      let tvWidget = null;

      function loadTradingView(symbol) {
        currentSymbol = symbol;
        const container = document.getElementById("tv-chart");
        container.innerHTML = "";

        tvWidget = new TradingView.widget({
          autosize: true,
          symbol,
          interval: "15",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "en",
          enable_publishing: false,
          withdateranges: true,
          allow_symbol_change: false,
          container_id: "tv-chart",
        });
      }

      function setupTvTabs() {
        const tabs = document.querySelectorAll(".tv-tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            loadTradingView(tab.dataset.symbol);
          });
        });
      }

      // ------------------------------
      // BOT PET logic (local, evolves on wins)
      // ------------------------------
      const PET_KEY = "crypto_bot_pet_v1";

      function loadPet() {
        try {
          const raw = localStorage.getItem(PET_KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch {
          return null;
        }
      }

      function savePet(pet) {
        localStorage.setItem(PET_KEY, JSON.stringify(pet));
      }

      function defaultPet() {
        return {
          xp: 0,
          hunger: 45, // 0 = full, 100 = starving
          lastWins: 0,
          lastLosses: 0,
          lastTotalTrades: 0,
          lastTotalPnl: 0,
          lastUpdate: Date.now(),
        };
      }

      function stageFromXp(xp) {
        if (xp < 3) return 0; // egg
        if (xp < 7) return 1; // baby blob
        if (xp < 13) return 2; // cat
        return 3; // dog
      }

      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      function setIcon(id, on) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.toggle("on", !!on);
      }

      function renderPetSprite(stage, moodKey) {
        // Simple pixel-like SVG built from circles/rects (no external images)
        // moodKey: HAPPY / SAD / WATCH / HUNGRY
        const svg = $("pet-sprite");
        const eye = moodKey === "SAD" || moodKey === "HUNGRY" ? "x" : "o";
        const mouth =
          moodKey === "HAPPY"
            ? "smile"
            : moodKey === "SAD" || moodKey === "HUNGRY"
            ? "frown"
            : "flat";

        // helpers
        const face = (cx, cy) => {
          const eyeL =
            eye === "o"
              ? `<circle cx="${cx - 7}" cy="${cy}" r="2.2" fill="rgba(248,244,252,0.92)"/>`
              : `<path d="M${cx - 9} ${cy - 2} L${cx - 5} ${cy + 2} M${cx - 5} ${cy - 2} L${cx - 9} ${cy + 2}" stroke="rgba(248,244,252,0.92)" stroke-width="1.6" stroke-linecap="round"/>`;
          const eyeR =
            eye === "o"
              ? `<circle cx="${cx + 7}" cy="${cy}" r="2.2" fill="rgba(248,244,252,0.92)"/>`
              : `<path d="M${cx + 5} ${cy - 2} L${cx + 9} ${cy + 2} M${cx + 9} ${cy - 2} L${cx + 5} ${cy + 2}" stroke="rgba(248,244,252,0.92)" stroke-width="1.6" stroke-linecap="round"/>`;

          let mouthPath = "";
          if (mouth === "smile") {
            mouthPath = `<path d="M${cx - 6} ${cy + 7} Q ${cx} ${cy + 12} ${cx + 6} ${
              cy + 7
            }" stroke="rgba(248,244,252,0.92)" stroke-width="1.8" fill="none" stroke-linecap="round"/>`;
          } else if (mouth === "frown") {
            mouthPath = `<path d="M${cx - 6} ${cy + 12} Q ${cx} ${cy + 7} ${cx + 6} ${
              cy + 12
            }" stroke="rgba(248,244,252,0.92)" stroke-width="1.8" fill="none" stroke-linecap="round"/>`;
          } else {
            mouthPath = `<path d="M${cx - 6} ${cy + 10} L${cx + 6} ${
              cy + 10
            }" stroke="rgba(248,244,252,0.92)" stroke-width="1.8" stroke-linecap="round"/>`;
          }

          return eyeL + eyeR + mouthPath;
        };

        let body = "";

        if (stage === 0) {
          // egg
          body = `
            <g opacity="0.95">
              <ellipse cx="32" cy="38" rx="15" ry="18" fill="rgba(248,244,252,0.10)" stroke="rgba(226,232,240,0.18)" stroke-width="1.2"/>
              <path d="M23 32 Q32 26 41 32" stroke="rgba(248,244,252,0.20)" stroke-width="1.2" fill="none"/>
              ${face(32, 38)}
            </g>`;
        } else if (stage === 1) {
          // baby blob
          body = `
            <g opacity="0.98">
              <rect x="18" y="24" width="28" height="28" rx="12" fill="rgba(248,244,252,0.12)" stroke="rgba(226,232,240,0.20)" stroke-width="1.2"/>
              <circle cx="22" cy="52" r="4" fill="rgba(248,244,252,0.10)"/>
              <circle cx="42" cy="52" r="4" fill="rgba(248,244,252,0.10)"/>
              ${face(32, 36)}
            </g>`;
        } else if (stage === 2) {
          // cat
          body = `
            <g opacity="0.98">
              <path d="M18 30 L26 22 L30 30 Z" fill="rgba(248,244,252,0.14)" stroke="rgba(226,232,240,0.22)" stroke-width="1.2"/>
              <path d="M46 30 L38 22 L34 30 Z" fill="rgba(248,244,252,0.14)" stroke="rgba(226,232,240,0.22)" stroke-width="1.2"/>
              <rect x="18" y="28" width="28" height="26" rx="12" fill="rgba(248,244,252,0.12)" stroke="rgba(226,232,240,0.22)" stroke-width="1.2"/>
              <path d="M20 42 L12 40" stroke="rgba(248,244,252,0.28)" stroke-width="1.2" stroke-linecap="round"/>
              <path d="M20 45 L12 45" stroke="rgba(248,244,252,0.28)" stroke-width="1.2" stroke-linecap="round"/>
              <path d="M44 42 L52 40" stroke="rgba(248,244,252,0.28)" stroke-width="1.2" stroke-linecap="round"/>
              <path d="M44 45 L52 45" stroke="rgba(248,244,252,0.28)" stroke-width="1.2" stroke-linecap="round"/>
              ${face(32, 38)}
            </g>`;
        } else {
          // dog
          body = `
            <g opacity="0.98">
              <path d="M18 34 Q14 38 16 44 Q18 48 22 46 L22 34 Z" fill="rgba(248,244,252,0.10)" stroke="rgba(226,232,240,0.20)" stroke-width="1.2"/>
              <path d="M46 34 Q50 38 48 44 Q46 48 42 46 L42 34 Z" fill="rgba(248,244,252,0.10)" stroke="rgba(226,232,240,0.20)" stroke-width="1.2"/>
              <rect x="18" y="28" width="28" height="28" rx="12" fill="rgba(248,244,252,0.12)" stroke="rgba(226,232,240,0.22)" stroke-width="1.2"/>
              <circle cx="32" cy="44" r="3" fill="rgba(248,244,252,0.55)"/>
              ${face(32, 38)}
            </g>`;
        }

        svg.innerHTML = body;
      }

      function renderPet(pet, data) {
        const petBox = $("pet-box");
        const moodEl = $("pet-mood");
        const subEl = $("pet-sub");

        // time-based hunger increase
        const now = Date.now();
        const dtMin = (now - (pet.lastUpdate || now)) / 60000;
        pet.lastUpdate = now;

        // hunger drifts up over time
        pet.hunger = clamp(pet.hunger + dtMin * 1.2, 0, 100);

        const prevStage = stageFromXp(pet.xp);

        // detect new wins/losses (from backend totals)
        const wins = data?.wins ?? 0;
        const losses = data?.losses ?? 0;

        const newWins = Math.max(0, wins - (pet.lastWins ?? 0));
        const newLosses = Math.max(0, losses - (pet.lastLosses ?? 0));

        // "wins are food"
        if (newWins > 0) {
          pet.xp += newWins * 2;
          pet.hunger = clamp(pet.hunger - newWins * 18, 0, 100);
          petBox.classList.add("pet-fed");
          setTimeout(() => petBox.classList.remove("pet-fed"), 1200);
        }

        // "losses are empty plate"
        if (newLosses > 0) {
          pet.xp = Math.max(0, pet.xp - newLosses * 1);
          pet.hunger = clamp(pet.hunger + newLosses * 12, 0, 100);
        }

        pet.lastWins = wins;
        pet.lastLosses = losses;

        // wipeout reset (based on equity if available)
        const lastEquity = (data?.equity_curve && data.equity_curve.length)
          ? data.equity_curve[data.equity_curve.length - 1]?.equity_usd
          : null;

        if (typeof lastEquity === "number" && lastEquity < 500) {
          // reset pet on wipeout
          const fresh = defaultPet();
          fresh.lastWins = wins;
          fresh.lastLosses = losses;
          Object.assign(pet, fresh);
          petBox.classList.add("pet-levelup");
          $("pet-levelup").textContent = "RESET!";
          setTimeout(() => {
            $("pet-levelup").textContent = "LEVEL UP!";
            petBox.classList.remove("pet-levelup");
          }, 1100);
        }

        // mood + pacing
        let moodKey = "WATCH";
        let moodText = "Watching‚Ä¶";
        let subText = "Waiting for trades";

        // last trade info
        const lastTrade = (data?.recent_trades && data.recent_trades.length)
          ? data.recent_trades[0]
          : null;

        if (pet.hunger >= 75) {
          moodKey = "HUNGRY";
          moodText = "Hungry üòø";
          subText = "Needs wins (food)";
        } else if (newLosses > 0) {
          moodKey = "SAD";
          moodText = "Sad üò¢";
          subText = "Empty plate‚Ä¶";
        } else if (newWins > 0) {
          moodKey = "HAPPY";
          moodText = "Happy üòÑ";
          if (lastTrade?.market) {
            const pnl = lastTrade?.pnl_usd ?? 0;
            subText = "Yum! " + lastTrade.market + " " + formatUsd(pnl);
          } else {
            subText = "Yum! Win snack!";
          }
        } else {
          moodKey = "WATCH";
          moodText = "Watching‚Ä¶";
          subText = "Waiting for trades";
        }

        // stage + evolution animation
        const stage = stageFromXp(pet.xp);
        if (stage !== prevStage) {
          const petBox = $("pet-box");
          petBox.classList.add("pet-levelup");
          setTimeout(() => petBox.classList.remove("pet-levelup"), 950);
        }

        // hungry state + pacing state
        petBox.classList.toggle("pet-hungry", pet.hunger >= 75);
        petBox.classList.toggle("pet-pace", moodKey === "WATCH");

        // icons react
        setIcon("ic-food", pet.hunger >= 60);
        setIcon("ic-health", pet.hunger >= 80);
        setIcon("ic-love", moodKey === "HAPPY");
        setIcon("ic-play", moodKey === "WATCH");
        setIcon("ic-clean", moodKey === "SAD" && pet.hunger < 80);

        // show mood
        moodEl.textContent = moodText;
        subEl.textContent = subText;

        // plate food only when win just happened
        if (newWins > 0) petBox.classList.add("pet-fed");

        // draw sprite
        renderPetSprite(stage, moodKey);

        savePet(pet);
      }

      // ------------------------------
      // Fetch + hydrate dashboard
      // ------------------------------
      async function refreshDashboard() {
        try {
          const res = await fetch("/data", { cache: "no-store" });
          const data = await res.json();

          // Top metrics
          $("metric-total-trades").textContent = data.total_trades ?? data.total_events ?? 0;
          $("metric-wins").textContent = (data.wins ?? 0) + " wins";
          $("metric-losses").textContent = (data.losses ?? 0) + " losses";

          const winRate = data.win_rate != null ? data.win_rate : 0;
          $("metric-win-rate").textContent = formatPercent(winRate, 1);

          $("metric-avg-pnl").textContent = formatUsd(data.avg_pnl_usd ?? 0);

          const totalPnl = data.total_pnl_usd ?? 0;
          const pnlEl = $("metric-total-pnl");
          pnlEl.textContent = formatUsd(totalPnl);
          pnlEl.classList.remove("positive", "negative");
          pnlEl.classList.add(totalPnl >= 0 ? "positive" : "negative");

          // Equity
          updateEquityChart(data.equity_curve || []);

          // Bot status
          updateBotStatus(data.bot_status);

          // Per-market & trades
          updatePerMarket(data.per_market || []);
          updateRecentTrades(data.recent_trades || []);

          // Advanced
          updateAdvancedMetrics(data.advanced_metrics, data.max_drawdown_usd);

          // Pet
          const pet = loadPet() || defaultPet();
          renderPet(pet, data);
        } catch (err) {
          console.error("Failed to refresh dashboard", err);
        }
      }

      // ------------------------------
      // Init
      // ------------------------------
      document.addEventListener("DOMContentLoaded", () => {
        setupTvTabs();
        loadTradingView(currentSymbol);
        refreshDashboard();
        setInterval(refreshDashboard, 10_000);
      });
    </script>
  </body>
 </html>
