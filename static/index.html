<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crypto AI Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #050814;
        --bg-card: #101522;
        --bg-card-soft: #141b2c;
        --text-main: #f8f4fc;
        --text-muted: #9ca3af;
        --accent: #22c55e;
        --accent-red: #ef4444;
        --accent-blue: #3b82f6;
        --border-soft: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text-main);
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        margin-bottom: 24px;
      }

      h1 {
        margin: 0 0 4px;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      header p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted);
      }

      header a {
        color: #38bdf8;
        text-decoration: none;
        margin-left: 4px;
        margin-right: 4px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .card {
        background: linear-gradient(145deg, var(--bg-card), #060b17);
        border-radius: 14px;
        padding: 14px 16px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      }

      .card h2 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .metric-main {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .metric-sub {
        font-size: 12px;
        color: var(--text-muted);
      }

      .metric-main.positive {
        color: var(--accent);
      }

      .metric-main.negative {
        color: var(--accent-red);
      }

      .card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.8);
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
      }

      .status-running {
        background-color: #22c55e;
      }

      .status-idle {
        background-color: #eab308;
      }

      .status-stopped {
        background-color: #ef4444;
      }

      .status-unknown {
        background-color: #6b7280;
      }

      .section-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .section-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin: 0 0 12px;
      }

      .section-card {
        margin-bottom: 24px;
      }

      .chart-container {
        height: 260px;
        background: radial-gradient(circle at top, #020617, #020617);
        border-radius: 14px;
        border: 1px solid var(--border-soft);
        overflow: hidden;
      }

      .chart-inner {
        width: 100%;
        height: 100%;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      thead {
        background: rgba(15, 23, 42, 0.9);
      }

      th,
      td {
        padding: 8px 10px;
        text-align: left;
      }

      th {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-bottom: 1px solid var(--border-soft);
      }

      tbody tr:nth-child(odd) {
        background: rgba(15, 23, 42, 0.4);
      }

      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.1);
      }

      tbody tr:hover {
        background: rgba(55, 65, 81, 0.4);
      }

      .text-right {
        text-align: right;
      }

      .muted {
        color: var(--text-muted);
      }

      .section-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
        gap: 16px;
      }

      @media (max-width: 900px) {
        .section-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .advanced-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px 14px;
        margin-top: 6px;
      }

      .adv-label {
        font-size: 11px;
        color: var(--text-muted);
      }

      .adv-value {
        font-size: 14px;
        font-weight: 600;
      }

      .tv-tabs {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        padding: 2px;
        margin-bottom: 8px;
      }

      .tv-tab {
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        cursor: pointer;
      }

      .tv-tab.active {
        background: #0f172a;
        color: var(--text-main);
      }

      .footer {
        margin-top: 18px;
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
      }

      /* BOT PET UI */
      .pet-wrap {
        display: grid;
        grid-template-columns: 96px 1fr;
        gap: 12px;
        align-items: center;
      }

      .pet-screen {
        width: 96px;
        height: 96px;
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: radial-gradient(
          circle at top,
          rgba(59, 130, 246, 0.18),
          rgba(2, 6, 23, 0.9)
        );
        display: grid;
        place-items: center;
        position: relative;
        overflow: hidden;
      }

      canvas#pet-canvas {
        width: 96px;
        height: 96px;
        image-rendering: pixelated;
        filter: drop-shadow(0 0 10px rgba(96, 165, 250, 0.25))
          drop-shadow(0 0 18px rgba(34, 197, 94, 0.12));
      }

      .pet-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-muted);
        margin: 0 0 4px;
      }

      .pet-mood {
        font-size: 22px;
        font-weight: 800;
        margin: 0;
        line-height: 1.1;
      }

      .pet-desc {
        margin-top: 6px;
        color: var(--text-muted);
        font-size: 12px;
      }

      .barline {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }

      .barrow {
        display: grid;
        grid-template-columns: 56px 1fr 40px;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .bar {
        height: 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.12);
      }

      .bar > span {
        display: block;
        height: 100%;
        width: 0%;
        border-radius: 999px;
      }

      .bar .g {
        background: rgba(34, 197, 94, 0.85);
      }

      .bar .h {
        background: rgba(239, 68, 68, 0.8);
      }

      .pet-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(15, 23, 42, 0.65);
        color: var(--text-main);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
      }

      .btn:hover {
        border-color: rgba(148, 163, 184, 0.32);
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header>
        <h1>Crypto AI Bot Dashboard</h1>
        <p>
          Paper-trading stats from Render â€”
          <a href="/data" target="_blank">raw stats</a>
        </p>
      </header>

      <section class="cards">
        <div class="card">
          <h2>Total Trades</h2>
          <div class="metric-main" id="metric-total-trades">0</div>
          <div class="metric-sub">
            <span id="metric-wins">0 wins</span> /
            <span id="metric-losses">0 losses</span>
          </div>
        </div>

        <div class="card">
          <h2>Win Rate</h2>
          <div class="metric-main" id="metric-win-rate">0%</div>
          <div class="metric-sub">
            Avg <span id="metric-avg-pnl">-$0.00</span> per trade
          </div>
        </div>

        <div class="card">
          <h2>PNL (Total)</h2>
          <div class="metric-main negative" id="metric-total-pnl">$0.00</div>
          <div class="metric-sub">Based on closed trades only.</div>
        </div>

        <div class="card">
          <h2>Bot Status</h2>
          <div class="card-row" style="margin-bottom: 6px">
            <div class="status-pill" id="bot-status-pill">
              <span class="status-dot status-unknown" id="bot-status-dot"></span>
              <span id="bot-status-label">Unknown</span>
            </div>
            <span class="muted" id="bot-status-minutes"></span>
          </div>
          <div class="metric-sub" id="bot-status-last">Waiting for heartbeatâ€¦</div>
        </div>

        <div class="card">
          <h2>Bot Pet</h2>
          <div class="pet-wrap">
            <div class="pet-screen">
              <canvas id="pet-canvas" width="32" height="32"></canvas>
            </div>
            <div>
              <div class="pet-title">Mood</div>
              <div class="pet-mood" id="pet-mood">Watchingâ€¦ ðŸ‘€</div>
              <div class="pet-desc" id="pet-desc">Waiting for trades</div>

              <div class="barline">
                <div class="barrow">
                  <div>Growth</div>
                  <div class="bar">
                    <span class="g" id="pet-growth-bar"></span>
                  </div>
                  <div class="muted" id="pet-growth-text">0%</div>
                </div>
                <div class="barrow">
                  <div>Hunger</div>
                  <div class="bar">
                    <span class="h" id="pet-hunger-bar"></span>
                  </div>
                  <div class="muted" id="pet-hunger-text">0%</div>
                </div>
              </div>

              <div class="pet-actions">
                <button class="btn" id="pet-reset">Reset Pet</button>
              </div>

              <div class="pet-desc" style="margin-top: 10px">
                Wins are <b>food</b>. Losses are an <b>empty plate</b>.
                <br />Egg hatches when Total PnL goes positive â€” then it never reverts.
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card section-card">
        <div class="card-row" style="margin-bottom: 6px">
          <div>
            <div class="section-title">Advanced Analytics</div>
            <div class="section-subtitle">Deeper stats from your closed trades.</div>
          </div>
        </div>
        <div class="advanced-grid">
          <div>
            <div class="adv-label">Profit Factor</div>
            <div class="adv-value" id="adv-profit-factor">â€”</div>
          </div>
          <div>
            <div class="adv-label">Avg Win (USD)</div>
            <div class="adv-value" id="adv-avg-win">â€”</div>
          </div>
          <div>
            <div class="adv-label">Avg Loss (USD)</div>
            <div class="adv-value" id="adv-avg-loss">â€”</div>
          </div>
          <div>
            <div class="adv-label">Best Trade (USD)</div>
            <div class="adv-value" id="adv-best-trade">â€”</div>
          </div>
          <div>
            <div class="adv-label">Worst Trade (USD)</div>
            <div class="adv-value" id="adv-worst-trade">â€”</div>
          </div>
          <div>
            <div class="adv-label">Max Drawdown (USD)</div>
            <div class="adv-value" id="adv-max-dd">â€”</div>
          </div>
          <div>
            <div class="adv-label">Recovery Factor</div>
            <div class="adv-value" id="adv-recovery-factor">â€”</div>
          </div>
          <div>
            <div class="adv-label">Sharpe Ratio</div>
            <div class="adv-value" id="adv-sharpe">â€”</div>
          </div>
        </div>
      </section>

      <section class="section-grid">
        <div>
          <div class="section-title">Equity Curve</div>
          <div class="section-subtitle">Tracks paper-trading balance over time (USD).</div>
          <div class="chart-container">
            <canvas id="equity-chart" class="chart-inner"></canvas>
          </div>
        </div>

        <div>
          <div class="section-card">
            <div class="section-title">Per-Market Performance</div>
            <div class="section-subtitle">
              How the bot is doing on each market (paper trading).
            </div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Market</th>
                    <th class="text-right">Trades</th>
                    <th class="text-right">Win Rate</th>
                    <th class="text-right">Total PnL</th>
                    <th class="text-right">Avg PnL</th>
                  </tr>
                </thead>
                <tbody id="per-market-body">
                  <tr>
                    <td colspan="5" class="muted">No markets yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">Recent Trades</div>
            <div class="section-subtitle">Showing last 20 closed trades.</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Market</th>
                    <th class="text-right">PnL (USD)</th>
                  </tr>
                </thead>
                <tbody id="recent-trades-body">
                  <tr>
                    <td colspan="3" class="muted">No trades yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="section-card">
        <div class="section-title">Market Candlestick Charts</div>
        <div class="section-subtitle">
          Live BTC-USD candlesticks on your main venues. Charts are from TradingView
          only (they do not place trades).
        </div>

        <div class="card">
          <div class="card-row" style="margin-bottom: 10px">
            <div>Venue</div>
            <div class="tv-tabs">
              <button class="tv-tab active" data-symbol="COINBASE:BTCUSD">Coinbase</button>
              <button class="tv-tab" data-symbol="KUCOIN:BTCUSDT">KuCoin</button>
              <button class="tv-tab" data-symbol="CRYPTOCOM:BTCUSD">Crypto.com</button>
            </div>
          </div>

          <div class="tradingview-widget-container" style="height: 400px">
            <div id="tv-chart"></div>
          </div>

          <div class="section-subtitle" style="margin-top: 10px">
            If a chart fails to load, adjust the symbol (e.g.
            <span class="muted">COINBASE:BTCUSD, KUCOIN:BTCUSDT, CRYPTOCOM:BTCUSD</span>).
          </div>
        </div>
      </section>

      <div class="footer">
        Bot is running on Render (paper trading only). Keep it training for 2â€“3 weeks
        before making AI changes.
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
      function $(id) { return document.getElementById(id); }

      function formatUsd(v) {
        if (v === null || v === undefined || isNaN(v)) return "â€”";
        const sign = v < 0 ? "-" : "";
        const abs = Math.abs(v);
        return sign + "$" + abs.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      function formatPercent(v, digits = 1) {
        if (v === null || v === undefined || isNaN(v)) return "â€”";
        return v.toFixed(digits).replace(/^-0\.0+$/, "0.0") + "%";
      }
      function formatNumber(v, digits = 2) {
        if (v === null || v === undefined || isNaN(v)) return "â€”";
        return v.toFixed(digits);
      }
      function formatTime(iso) {
        if (!iso) return "â€”";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return iso;
        return d.toLocaleString();
      }

      // =============================
      // Equity chart
      // =============================
      let equityChart = null;
      function updateEquityChart(points) {
        const ctx = $("equity-chart");
        const labels = (points || []).map((p, idx) => {
          const iso = p.time_utc || p.time;
          const d = new Date(iso);
          if (Number.isNaN(d.getTime())) return "t+" + idx;
          return d.toLocaleTimeString();
        });
        const data = (points || []).map((p) => p.equity_usd);

        if (equityChart) {
          equityChart.data.labels = labels;
          equityChart.data.datasets[0].data = data;
          equityChart.update();
          return;
        }

        equityChart = new Chart(ctx, {
          type: "line",
          data: { labels, datasets: [{ label: "Equity (USD)", data, tension: 0.35, borderWidth: 2, pointRadius: 2 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (c) => "Equity: " + formatUsd(c.parsed.y) } },
            },
            scales: {
              x: { ticks: { maxTicksLimit: 6 }, grid: { color: "rgba(31,41,55,0.6)" } },
              y: { ticks: { callback: (v) => "$" + v }, grid: { color: "rgba(31,41,55,0.6)" } },
            },
          },
        });
      }

      // =============================
      // Bot status
      // =============================
      function updateBotStatus(status) {
        const dot = $("bot-status-dot");
        const label = $("bot-status-label");
        const minutesEl = $("bot-status-minutes");
        const lastEl = $("bot-status-last");

        const s = status?.status || "unknown";
        label.textContent = s.charAt(0).toUpperCase() + s.slice(1);
        dot.className = "status-dot status-" + s;
        minutesEl.textContent = "";

        if (status?.last_heartbeat) lastEl.textContent = "Last heartbeat: " + formatTime(status.last_heartbeat);
        else lastEl.textContent = "Heartbeat file not found yet.";
      }

      // =============================
      // Tables
      // =============================
      function updatePerMarket(perMarket) {
        const body = $("per-market-body");
        body.innerHTML = "";
        if (!perMarket || perMarket.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5; cell.className = "muted"; cell.textContent = "No markets yet.";
          row.appendChild(cell); body.appendChild(row); return;
        }
        perMarket.forEach((m) => {
          const row = document.createElement("tr");
          const c1 = document.createElement("td"); c1.textContent = m.market; row.appendChild(c1);
          const c2 = document.createElement("td"); c2.className="text-right"; c2.textContent=m.trades; row.appendChild(c2);
          const c3 = document.createElement("td"); c3.className="text-right"; c3.textContent=formatPercent(m.win_rate,1); row.appendChild(c3);
          const c4 = document.createElement("td"); c4.className="text-right"; c4.textContent=formatUsd(m.total_pnl); row.appendChild(c4);
          const c5 = document.createElement("td"); c5.className="text-right"; c5.textContent=formatUsd(m.avg_pnl); row.appendChild(c5);
          body.appendChild(row);
        });
      }

      function updateRecentTrades(trades) {
        const body = $("recent-trades-body");
        body.innerHTML = "";
        if (!trades || trades.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3; cell.className = "muted"; cell.textContent = "No trades yet.";
          row.appendChild(cell); body.appendChild(row); return;
        }
        trades.forEach((t) => {
          const row = document.createElement("tr");
          const c1 = document.createElement("td"); c1.textContent = formatTime(t.time); row.appendChild(c1);
          const c2 = document.createElement("td"); c2.textContent = t.market; row.appendChild(c2);
          const c3 = document.createElement("td"); c3.className="text-right"; c3.textContent = formatUsd(t.pnl_usd); row.appendChild(c3);
          body.appendChild(row);
        });
      }

      function updateAdvancedMetrics(adv) {
        $("adv-profit-factor").textContent = adv?.profit_factor != null ? formatNumber(adv.profit_factor,2) : "â€”";
        $("adv-avg-win").textContent = formatUsd(adv?.avg_win_usd);
        $("adv-avg-loss").textContent = formatUsd(adv?.avg_loss_usd);
        $("adv-best-trade").textContent = formatUsd(adv?.best_trade_usd);
        $("adv-worst-trade").textContent = formatUsd(adv?.worst_trade_usd);
        $("adv-max-dd").textContent = formatUsd(adv?.max_drawdown_usd);
        $("adv-recovery-factor").textContent = adv?.recovery_factor != null ? formatNumber(adv.recovery_factor,2) : "â€”";
        $("adv-sharpe").textContent = adv?.sharpe_ratio != null ? formatNumber(adv.sharpe_ratio,2) : "â€”";
      }

      // =============================
      // TradingView
      // =============================
      let currentSymbol = "COINBASE:BTCUSD";
      function loadTradingView(symbol) {
        currentSymbol = symbol;
        const container = document.getElementById("tv-chart");
        container.innerHTML = "";
        new TradingView.widget({
          autosize: true,
          symbol,
          interval: "30",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "en",
          enable_publishing: false,
          withdateranges: true,
          allow_symbol_change: false,
          container_id: "tv-chart",
        });
      }
      function setupTvTabs() {
        const tabs = document.querySelectorAll(".tv-tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            loadTradingView(tab.dataset.symbol);
          });
        });
      }

      // ==========================================================
      // BOT PET
      // ==========================================================
      const PET_KEY = "ngc_botpet_v4";

      function loadPetState() {
        try { const raw = localStorage.getItem(PET_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; }
      }
      function savePetState(s) { localStorage.setItem(PET_KEY, JSON.stringify(s)); }
      function newPetState() {
        return {
          hatched: false,
          petType: null, // "cat" | "dog"
          growth: 0,
          hunger: 0,
          lastWins: 0,
          lastLosses: 0,
          lastTotalPnl: 0,
          lastSeenAt: Date.now(),
          lastEvent: "idle", // "idle" | "feed" | "lose" | "hatch"
          lastEventAt: 0,
        };
      }

      let petState = loadPetState() || newPetState();
      $("pet-reset").addEventListener("click", () => { petState = newPetState(); savePetState(petState); });

      const PALETTE = {
        " ": null,
        ".": "rgba(255,255,255,0.10)",

        // outlines that pop on dark background
        "K": "#64748b",   // light slate
        "k": "#475569",   // darker slate

        "W": "#f8fafc",
        "G": "#cbd5e1",
        "D": "#94a3b8",

        // cat orange tabby tones
        "O": "#f59e0b",
        "o": "#d97706",
        "S": "#fbbf24",   // stripe highlight

        // dog ear/nose (not pure black)
        "E": "#334155",   // ear dark slate
        "e": "#1f2937",   // deeper slate

        "P": "#fb7185",   // pink
        "R": "#ef4444",   // red
        "Y": "#fbbf24",   // yellow
      };

      function drawSprite(canvas, sprite) {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let y = 0; y < sprite.length; y++) {
          const row = sprite[y];
          for (let x = 0; x < row.length; x++) {
            const ch = row[x];
            const col = PALETTE[ch];
            if (!col) continue;
            ctx.fillStyle = col;
            ctx.fillRect(x, y, 1, 1);
          }
        }
      }

      function drawComposite(canvas, baseSprite, overlaySprite) {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawSprite(canvas, baseSprite);
        if (!overlaySprite) return;
        const temp = document.createElement("canvas");
        temp.width = 32; temp.height = 32;
        drawSprite(temp, overlaySprite);
        ctx.drawImage(temp, 0, 0);
      }

      // =============================
      // Sprites (32x32)
      // - Cat: chunky ginger tabby silhouette (lazy eyes, stripes)
      // - Dog: white pup with big dark ear + muzzle
      // =============================
      const FRAMES = {
        egg_idle1: [
          "                                ",
          "                                ",
          "            kkkkkkkk            ",
          "          kkWWWWWWWWkk          ",
          "         kWWWWWWWWWWWWk         ",
          "        kWWWWWWWWWWWWWWk        ",
          "        kWWWWWWWWWWWWWWk        ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "        kWWWWWWWWWWWWWWk        ",
          "        kWWWWWWWWWWWWWWk        ",
          "         kWWWWWWWWWWWWk         ",
          "          kkWWWWWWWWkk          ",
          "            kkkkkkkk            ",
          "                                ",
          "                                ",
          "             ..  ..             ",
          "            .. .. ..            ",
          "             ..  ..             ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        egg_idle2: [
          "                                ",
          "                                ",
          "            kkkkkkkk            ",
          "          kkWWWWWWWWkk          ",
          "         kWWWWWWWWWWWWk         ",
          "        kWWWWWWWWWWWWWWk        ",
          "        kWWWWWWWWWWWWWWk        ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "       kWWWWWWWWWWWWWWWWk       ",
          "        kWWWWWWWWWWWWWWk        ",
          "        kWWWWWWWWWWWWWWk        ",
          "         kWWWWWWWWWWWWk         ",
          "          kkWWWWWWWWkk          ",
          "            kkkkkkkk            ",
          "                                ",
          "                                ",
          "             .. ..              ",
          "            ..  ..              ",
          "             .. ..              ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],

        // =============================
        // CAT (ginger tabby, lazy vibe)
        // =============================
        cat_idle1: [
          "                                ",
          "                                ",
          "            kkOOOOkk            ",
          "          kkOOooooOOk           ",
          "         kOOOooSSooOOOk         ",
          "        kOOoWWWWWWoOOOk         ",
          "        kOoWGGGGGGWoOOOk        ",
          "        kOoWGGGGGGWoOOOk        ",
          "        kOoWWWWWWWWoOOOk        ",
          "         kOOooSSooooOOk         ",
          "          kkOOooooOOkk          ",
          "             kOOOOOk            ",
          "        kkkkkkOOOOkkkkkk        ",
          "       kOOOkkOOOOOOkkOOOk       ",
          "      kOOOOkOOOooOOOkOOOOk      ",
          "      kOOOOkOOooooOOOkOOOOk     ",
          "       kOOOkkOOOOOOkkOOOk       ",
          "        kkkkkOOOOOOkkkkk        ",
          "          kOOOOOOOOOOk          ",
          "          kOOOooOOOooOk         ",
          "          kOOoooooooOOk         ",
          "           kkOOOooOOkk          ",
          "             kkkkkk             ",
          "            k  kk  k            ",
          "            k  kk  k            ",
          "             kk  kk             ",
          "               kk               ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        cat_idle2: [
          "                                ",
          "                                ",
          "            kkOOOOkk            ",
          "          kkOOooooOOk           ",
          "         kOOOooSSooOOOk         ",
          "        kOOoWWWWWWoOOOk         ",
          "        kOoWGGGGGGWoOOOk        ",
          "        kOoWGGGGGGWoOOOk        ",
          "        kOoWWWWWWWWoOOOk        ",
          "         kOOooSSooooOOk         ",
          "          kkOOooooOOkk          ",
          "             kOOOOOk            ",
          "        kkkkkkOOOOkkkkkk        ",
          "       kOOOkkOOOOOOkkOOOk       ",
          "      kOOOOkOOOooOOOkOOOOk      ",
          "      kOOOOkOOooooOOOkOOOOk     ",
          "       kOOOkkOOOOOOkkOOOk       ",
          "        kkkkkOOOOOOkkkkk        ",
          "          kOOOOOOOOOOk          ",
          "          kOOOooOOOooOk         ",
          "           kOOoooooOOk          ",
          "            kkOOOkkk            ",
          "             kkkkk              ",
          "             k kk k             ",
          "             k kk k             ",
          "              k  k              ",
          "               kk               ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        cat_blink: [
          "                                ",
          "                                ",
          "            kkOOOOkk            ",
          "          kkOOooooOOk           ",
          "         kOOOooSSooOOOk         ",
          "        kOOoWWWWWWoOOOk         ",
          "        kOoWDDDDDDWoOOOk        ",
          "        kOoWDDDDDDWoOOOk        ",
          "        kOoWWWWWWWWoOOOk        ",
          "         kOOooSSooooOOk         ",
          "          kkOOooooOOkk          ",
          "             kOOOOOk            ",
          "        kkkkkkOOOOkkkkkk        ",
          "       kOOOkkOOOOOOkkOOOk       ",
          "      kOOOOkOOOooOOOkOOOOk      ",
          "      kOOOOkOOooooOOOkOOOOk     ",
          "       kOOOkkOOOOOOkkOOOk       ",
          "        kkkkkOOOOOOkkkkk        ",
          "          kOOOOOOOOOOk          ",
          "          kOOOooOOOooOk         ",
          "          kOOoooooooOOk         ",
          "           kkOOOooOOkk          ",
          "             kkkkkk             ",
          "            k  kk  k            ",
          "            k  kk  k            ",
          "             kk  kk             ",
          "               kk               ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        cat_sad: [
          "                                ",
          "                                ",
          "            kkOOOOkk            ",
          "          kkOOooooOOk           ",
          "         kOOOooSSooOOOk         ",
          "        kOOoWWWWWWoOOOk         ",
          "        kOoWRRRRRRWoOOOk        ",
          "        kOoWRRRRRRWoOOOk        ",
          "        kOoWWWWWWWWoOOOk        ",
          "         kOOooSSooooOOk         ",
          "          kkOOooooOOkk          ",
          "             kOOOOOk            ",
          "        kkkkkkOOOOkkkkkk        ",
          "       kOOOkkOOOOOOkkOOOk       ",
          "      kOOOOkOOOooOOOkOOOOk      ",
          "      kOOOOkOOooooOOOkOOOOk     ",
          "       kOOOkkOOOOOOkkOOOk       ",
          "        kkkkkOOOOOOkkkkk        ",
          "          kOOOOOOOOOOk          ",
          "             ..RR..             ",
          "              .RR.              ",
          "               ..               ",
          "             kkkkkk             ",
          "            k  kk  k            ",
          "            k  kk  k            ",
          "             kk  kk             ",
          "               kk               ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        cat_faint: [
          "                                ",
          "                                ",
          "                                ",
          "             kkOOOOkk           ",
          "           kkOOooooOOk          ",
          "          kOOOooSSooOOOk        ",
          "         kOOoWWWWWWoOOOk        ",
          "         kOoWRRRRRRWoOOOk       ",
          "         kOoWRRRRRRWoOOOk       ",
          "         kOoWWWWWWWWoOOOk       ",
          "          kOOooSSooooOOk        ",
          "           kkOOooooOOkk         ",
          "              kOOOOOk           ",
          "      kkkkkkkkOOOOOOOOkkkkkkkk  ",
          "     kOOOkkOOOOOOOOOOOOOOkkOOOk ",
          "      kkkkkkkkOOOOOOOOkkkkkkkk  ",
          "           kOOOOOOOOOOk         ",
          "            kkOOOOOOkk          ",
          "              kkkkkk            ",
          "              k kk k            ",
          "              k kk k            ",
          "               k  k             ",
          "                kk              ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],

        // =============================
        // DOG (white pup, dark ear + muzzle vibe)
        // =============================
        dog_idle1: [
          "                                ",
          "                                ",
          "            kkWWWWkk            ",
          "          kkWWWWWWWWkk          ",
          "         kWWWWWEEWWWWWk         ",
          "        kWWWWEEEEEEWWWWk        ",
          "        kWWWWEWWWWWEWWWWk       ",
          "        kWWWWWWWWWWWWWWk        ",
          "         kWWWWeeeeeWWWWk        ",
          "          kkWWWeeeWWWkk          ",
          "            kWWWWWWWWk           ",
          "             kWWWWWWk            ",
          "        kkkkkWWWWWWWWkkkkk       ",
          "       k..kkWWWWWWWWWWkk..k      ",
          "       k..kkWWWWWWWWWWkk..k      ",
          "        kkkkkWWWWWWWWkkkkk       ",
          "           kkWWWWWWWWkk           ",
          "             kWWWWWWk             ",
          "              kkWWkk              ",
          "               kkk                ",
          "              k   k               ",
          "              k   k               ",
          "               kkk                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        dog_idle2: [
          "                                ",
          "                                ",
          "            kkWWWWkk            ",
          "          kkWWWWWWWWkk          ",
          "         kWWWWWEEWWWWWk         ",
          "        kWWWWEEEEEEWWWWk        ",
          "        kWWWWEWWWWWEWWWWk       ",
          "        kWWWWWWWWWWWWWWk        ",
          "         kWWWWeeeeeWWWWk        ",
          "          kkWWWeeeeWWkk          ",
          "            kWWWWWWWWk           ",
          "             kWWWWWWk            ",
          "        kkkkkWWWWWWWWkkkkk       ",
          "       k..kkWWWWWWWWWWkk..k      ",
          "       k..kkWWWWWWWWWWkk..k      ",
          "        kkkkkWWWWWWWWkkkkk       ",
          "           kkWWWWWWWWkk           ",
          "             kWWWWWWk             ",
          "              kkWWkk              ",
          "               kkk                ",
          "             k   k                ",
          "             k   k                ",
          "              kkk                 ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        dog_sad: [
          "                                ",
          "                                ",
          "            kkWWWWkk            ",
          "          kkWWWWWWWWkk          ",
          "         kWWWWWRRWWWWWk         ",
          "        kWWWWRRRRRRWWWWk        ",
          "        kWWWWEWWWWWEWWWWk       ",
          "        kWWWWWWWWWWWWWWk        ",
          "         kWWWWeeeeeWWWWk        ",
          "          kkWWWeeeeWWkk          ",
          "            kWWWWWWWWk           ",
          "             kWWWWWWk            ",
          "        kkkkkWWWWWWWWkkkkk       ",
          "       k..kkWWWWWWWWWWkk..k      ",
          "       k..kkWWWWWWWWWWkk..k      ",
          "        kkkkkWWWWWWWWkkkkk       ",
          "           kkWWWWWWWWkk           ",
          "             ..RR..RR..           ",
          "              .RR..RR.            ",
          "               ..  ..             ",
          "               kkk                ",
          "              k   k               ",
          "              k   k               ",
          "               kkk                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        dog_faint: [
          "                                ",
          "                                ",
          "                                ",
          "            kkWWWWkk            ",
          "          kkWWWWWWWWkk          ",
          "         kWWWWWRRWWWWWk         ",
          "        kWWWWRRRRRRWWWWk        ",
          "        kWWWWEWWWWWEWWWWk       ",
          "        kWWWWWWWWWWWWWWk        ",
          "         kWWWWeeeeeWWWWk        ",
          "          kkWWWeeeeWWkk          ",
          "            kWWWWWWWWk           ",
          "      kkkkkkWWWWWWWWWWkkkkkk     ",
          "     k..kkWWWWWWWWWWWWWWkk..k    ",
          "      kkkkkkWWWWWWWWWWkkkkkk     ",
          "           kkWWWWWWWWkk           ",
          "              kkWWkk              ",
          "               kkk                ",
          "              k   k               ",
          "              k   k               ",
          "               kkk                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],

        // Plates
        plate_full: [
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "            kkkkkkkk            ",
          "          kkWWWWWWWWkk          ",
          "         kWWYYYYYYYYWWk         ",
          "         kWWYYYYYYYYWWk         ",
          "          kkWWWWWWWWkk          ",
          "            kkkkkkkk            ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        plate_empty: [
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "            kkkkkkkk            ",
          "          kkWWWWWWWWkk          ",
          "         kWWWWWWWWWWWWk         ",
          "         kWWWWWWWWWWWWk         ",
          "          kkWWWWWWWWkk          ",
          "            kkkkkkkk            ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
      };

      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

      function petMaybeHatch(totalPnl) {
        if (petState.hatched) return;
        if (totalPnl > 0.01) {
          petState.hatched = true;
          petState.petType = Math.random() < 0.5 ? "cat" : "dog"; // random
          petState.lastEvent = "hatch";
          petState.lastEventAt = Date.now();
        }
      }

      function updatePetUI(stats, recentTrade) {
        const totalPnl = stats.total_pnl_usd ?? 0;
        const growthPct = Math.round(petState.growth);
        const hungerPct = Math.round(petState.hunger);

        $("pet-growth-bar").style.width = growthPct + "%";
        $("pet-hunger-bar").style.width = hungerPct + "%";
        $("pet-growth-text").textContent = growthPct + "%";
        $("pet-hunger-text").textContent = hungerPct + "%";

        const fainted = petState.hatched && petState.hunger >= 92;
        const hungry = petState.hatched && petState.hunger >= 70;

        let mood = "Watchingâ€¦ ðŸ‘€";
        let desc = "Waiting for trades";

        if (!petState.hatched) {
          mood = totalPnl > 0 ? "Hatchingâ€¦ ðŸ£" : "Egg (waiting) ðŸ¥š";
          desc = totalPnl > 0
            ? "Profit detected â€” about to hatch!"
            : "Stays an egg until Total PnL goes positive.";
        } else if (fainted) {
          mood = "Fainted â˜ ï¸ (needs wins)";
          desc = "Too hungry. Wins will revive it (it wonâ€™t revert to egg).";
        } else if (hungry) {
          mood = "Hungry ðŸ½ï¸";
          desc = "Needs wins (food). Losses make hunger worse.";
        } else {
          if (petState.lastEvent === "feed") {
            mood = "Happy " + (petState.petType === "cat" ? "ðŸ˜º" : "ðŸ¶");
            desc = recentTrade?.market
              ? "Yum! " + recentTrade.market + " " + formatUsd(recentTrade.pnl_usd)
              : "Wins are food â€” keep feeding it!";
          } else if (petState.lastEvent === "lose") {
            mood = "Sad " + (petState.petType === "cat" ? "ðŸ˜¿" : "ðŸ˜”");
            desc = "Empty plateâ€¦ losses increase hunger.";
          } else {
            mood = "Chilling ðŸ˜Œ";
            desc = "Watching the marketâ€¦";
          }
        }

        $("pet-mood").textContent = mood;
        $("pet-desc").textContent = desc;
      }

      function petApplyChangesFromStats(stats) {
        const now = Date.now();
        const minutes = (now - (petState.lastSeenAt || now)) / 60000;
        if (minutes > 0) petState.hunger = clamp(petState.hunger + minutes * 0.6, 0, 100);

        const wins = stats.wins ?? 0;
        const losses = stats.losses ?? 0;
        const totalPnl = stats.total_pnl_usd ?? 0;
        const recentTrade = (stats.recent_trades || [])[0];

        petMaybeHatch(totalPnl);

        const dW = wins - (petState.lastWins ?? 0);
        const dL = losses - (petState.lastLosses ?? 0);

        if (dW > 0) {
          petState.hunger = clamp(petState.hunger - 18 * dW, 0, 100);
          petState.growth = clamp(petState.growth + 10 * dW, 0, 100);
          petState.lastEvent = "feed";
          petState.lastEventAt = now;
        } else if (dL > 0) {
          petState.hunger = clamp(petState.hunger + 14 * dL, 0, 100);
          petState.growth = clamp(petState.growth - 2 * dL, 0, 100);
          petState.lastEvent = "lose";
          petState.lastEventAt = now;
        } else {
          if (now - (petState.lastEventAt || 0) > 3500) petState.lastEvent = "idle";
        }

        petState.lastWins = wins;
        petState.lastLosses = losses;
        petState.lastTotalPnl = totalPnl;
        petState.lastSeenAt = now;

        savePetState(petState);
        updatePetUI(stats, recentTrade);
      }

      const petCanvas = $("pet-canvas");
      let petTick = 0;

      function pickFrame() {
        const now = Date.now();
        const t = petTick;
        const fainted = petState.hatched && petState.hunger >= 92;
        const hungry = petState.hatched && petState.hunger >= 70;

        let plate = null;
        const eventAge = now - (petState.lastEventAt || 0);
        if (petState.lastEvent === "feed" && eventAge < 1800) plate = FRAMES.plate_full;
        else if (petState.lastEvent === "lose" && eventAge < 2200) plate = FRAMES.plate_empty;
        else if (hungry || fainted) plate = FRAMES.plate_empty;

        if (!petState.hatched) {
          const base = t % 18 < 9 ? FRAMES.egg_idle1 : FRAMES.egg_idle2;
          return { base, plate: null };
        }

        if (fainted) {
          const base = petState.petType === "cat" ? FRAMES.cat_faint : FRAMES.dog_faint;
          return { base, plate };
        }

        if (hungry) {
          const base = petState.petType === "cat" ? FRAMES.cat_sad : FRAMES.dog_sad;
          return { base, plate };
        }

        if (petState.lastEvent === "feed" && eventAge < 2200) {
          if (petState.petType === "cat") {
            const blink = t % 12 < 2;
            const base = blink ? FRAMES.cat_blink : (t % 18 < 9 ? FRAMES.cat_idle1 : FRAMES.cat_idle2);
            return { base, plate };
          } else {
            const base = t % 18 < 9 ? FRAMES.dog_idle1 : FRAMES.dog_idle2;
            return { base, plate };
          }
        }

        if (petState.lastEvent === "lose" && eventAge < 2200) {
          const base = petState.petType === "cat" ? FRAMES.cat_sad : FRAMES.dog_sad;
          return { base, plate };
        }

        if (petState.petType === "cat") {
          const blink = t % 45 === 0 || t % 45 === 1;
          const base = blink ? FRAMES.cat_blink : (t % 18 < 9 ? FRAMES.cat_idle1 : FRAMES.cat_idle2);
          return { base, plate };
        } else {
          const base = t % 18 < 9 ? FRAMES.dog_idle1 : FRAMES.dog_idle2;
          return { base, plate };
        }
      }

      function petLoop() {
        petTick++;
        const { base, plate } = pickFrame();
        drawComposite(petCanvas, base, plate);
        requestAnimationFrame(petLoop);
      }

      // =============================
      // Dashboard fetch + hydrate
      // =============================
      async function refreshDashboard() {
        try {
          const res = await fetch("/data");
          const data = await res.json();

          $("metric-total-trades").textContent = data.total_trades ?? 0;
          $("metric-wins").textContent = (data.wins ?? 0) + " wins";
          $("metric-losses").textContent = (data.losses ?? 0) + " losses";
          $("metric-win-rate").textContent = formatPercent(data.win_rate ?? 0, 1);

          const avgPnl = (data.total_trades ?? 0) > 0 ? (data.total_pnl_usd ?? 0) / data.total_trades : 0;
          $("metric-avg-pnl").textContent = formatUsd(avgPnl);

          const totalPnl = data.total_pnl_usd ?? 0;
          const pnlEl = $("metric-total-pnl");
          pnlEl.textContent = formatUsd(totalPnl);
          pnlEl.classList.remove("positive", "negative");
          pnlEl.classList.add(totalPnl >= 0 ? "positive" : "negative");

          updateEquityChart(data.equity_curve || []);
          updateBotStatus(data.bot_status);
          updatePerMarket(data.per_market || []);
          updateRecentTrades(data.recent_trades || []);
          updateAdvancedMetrics(data.advanced_metrics);

          petApplyChangesFromStats({
            wins: data.wins ?? 0,
            losses: data.losses ?? 0,
            total_pnl_usd: data.total_pnl_usd ?? 0,
            recent_trades: data.recent_trades || [],
          });
        } catch (err) {
          console.error("Failed to refresh dashboard", err);
        }
      }

      // =============================
      // Init
      // =============================
      document.addEventListener("DOMContentLoaded", () => {
        setupTvTabs();
        loadTradingView(currentSymbol);
        refreshDashboard();
        setInterval(refreshDashboard, 10_000);
        petLoop();
      });
    </script>
  </body>
              </html>
