<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crypto AI Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #050814;
        --bg-card: #101522;
        --text-main: #f8f4fc;
        --text-muted: #9ca3af;
        --accent: #22c55e;
        --accent-red: #ef4444;
        --border-soft: #1f2937;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text-main);
      }
      .page { max-width: 1200px; margin: 0 auto; padding: 24px 16px 40px; }
      header { margin-bottom: 24px; }
      h1 { margin: 0 0 4px; font-size: 28px; font-weight: 700; letter-spacing: 0.03em; }
      header p { margin: 0; font-size: 13px; color: var(--text-muted); }
      header a { color: #38bdf8; text-decoration: none; margin: 0 4px; }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }
      .card {
        background: linear-gradient(145deg, var(--bg-card), #060b17);
        border-radius: 14px;
        padding: 14px 16px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 12px 30px rgba(0,0,0,0.45);
      }
      .card h2 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }
      .metric-main { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
      .metric-sub { font-size: 12px; color: var(--text-muted); }
      .metric-main.positive { color: var(--accent); }
      .metric-main.negative { color: var(--accent-red); }

      .card-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); }
      .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; border-radius: 999px; font-size: 11px; background: rgba(15, 23, 42, 0.8); }
      .status-dot { width: 7px; height: 7px; border-radius: 50%; }
      .status-running { background-color: #22c55e; }
      .status-idle { background-color: #eab308; }
      .status-stopped { background-color: #ef4444; }
      .status-unknown { background-color: #6b7280; }

      .section-title { font-size: 14px; text-transform: uppercase; letter-spacing: 0.14em; color: var(--text-muted); margin: 0 0 8px; }
      .section-subtitle { font-size: 12px; color: var(--text-muted); margin: 0 0 12px; }
      .section-card { margin-bottom: 24px; }

      .section-grid { display: grid; grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr); gap: 16px; }
      @media (max-width: 900px) { .section-grid { grid-template-columns: minmax(0,1fr); } }

      .chart-container {
        height: 260px;
        background: radial-gradient(circle at top, #020617, #020617);
        border-radius: 14px;
        border: 1px solid var(--border-soft);
        overflow: hidden;
      }
      .chart-inner { width: 100%; height: 100%; }

      table { width: 100%; border-collapse: collapse; font-size: 12px; }
      thead { background: rgba(15, 23, 42, 0.9); }
      th, td { padding: 8px 10px; text-align: left; }
      th {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-bottom: 1px solid var(--border-soft);
      }
      tbody tr:nth-child(odd) { background: rgba(15, 23, 42, 0.4); }
      tbody tr:nth-child(even) { background: rgba(15, 23, 42, 0.1); }
      tbody tr:hover { background: rgba(55, 65, 81, 0.4); }
      .text-right { text-align: right; }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        background: rgba(15, 23, 42, 0.9);
      }
      .pill.positive { color: var(--accent); }
      .pill.negative { color: var(--accent-red); }
      .muted { color: var(--text-muted); }

      .advanced-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px 14px;
        margin-top: 6px;
      }
      .adv-label { font-size: 11px; color: var(--text-muted); }
      .adv-value { font-size: 14px; font-weight: 600; }

      .tv-tabs {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        padding: 2px;
        margin-bottom: 8px;
      }
      .tv-tab {
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        cursor: pointer;
      }
      .tv-tab.active { background: #0f172a; color: var(--text-main); }

      .footer { margin-top: 18px; font-size: 11px; color: var(--text-muted); text-align: center; }

      /* PET */
      .pet-wrap { display: grid; grid-template-columns: 128px 1fr; gap: 14px; align-items: center; }
      .pet-screen {
        width: 122px; height: 122px;
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        background:
          radial-gradient(circle at 18% 18%, rgba(59,130,246,0.20), transparent 55%),
          radial-gradient(circle at 85% 62%, rgba(34,197,94,0.16), transparent 55%),
          linear-gradient(180deg, rgba(15,23,42,0.85), rgba(2,6,23,0.92));
        display: grid; place-items: center;
        position: relative; overflow: hidden;
        box-shadow: inset 0 0 22px rgba(56,189,248,0.10);
      }
      .pet-screen::before {
        content: ""; position: absolute; inset: 0;
        background: repeating-linear-gradient(
          180deg,
          rgba(255,255,255,0.03),
          rgba(255,255,255,0.03) 1px,
          transparent 2px,
          transparent 5px
        );
        opacity: 0.22;
        pointer-events: none;
      }
      .pet-screen::after {
        content: ""; position: absolute; inset: 0;
        background: linear-gradient(120deg, rgba(255,255,255,0.12), transparent 45%);
        pointer-events: none; opacity: 0.35;
      }
      canvas#pet-canvas { image-rendering: pixelated; width: 96px; height: 96px; }

      .pet-meta .pet-title { display: flex; align-items: baseline; justify-content: space-between; gap: 10px; }
      .pet-meta .pet-title b { font-size: 14px; letter-spacing: 0.02em; }
      .pet-meta .pet-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

      .pet-bars { margin-top: 10px; display: grid; gap: 8px; }
      .bar-row { display: grid; grid-template-columns: 70px 1fr 44px; gap: 8px; align-items: center; }
      .bar-row span { font-size: 11px; color: var(--text-muted); }

      .bar {
        height: 10px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 999px;
        overflow: hidden;
      }
      .bar > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(34,197,94,0.95), rgba(59,130,246,0.85));
      }
      .bar.danger > i {
        background: linear-gradient(90deg, rgba(239,68,68,0.95), rgba(245,158,11,0.85));
      }

      .pet-actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
      .btn {
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(15, 23, 42, 0.8);
        color: var(--text-main);
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 999px;
        cursor: pointer;
      }
      .btn:hover { border-color: rgba(148, 163, 184, 0.32); }

      .pet-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(15,23,42,0.8);
        color: var(--text-muted);
        border: 1px solid rgba(148, 163, 184, 0.12);
      }
      .shake { animation: shake 240ms ease-in-out infinite; }
      @keyframes shake {
        0% { transform: translate(0,0) rotate(0deg); }
        25% { transform: translate(1px,-1px) rotate(-1deg); }
        50% { transform: translate(-1px,1px) rotate(1deg); }
        75% { transform: translate(1px,1px) rotate(0deg); }
        100% { transform: translate(0,0) rotate(0deg); }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header>
        <h1>Crypto AI Bot Dashboard</h1>
        <p>Paper-trading stats from Render ‚Äî <a href="/data" target="_blank">raw stats</a></p>
      </header>

      <section class="cards">
        <div class="card">
          <h2>Total Trades</h2>
          <div class="metric-main" id="metric-total-trades">0</div>
          <div class="metric-sub"><span id="metric-wins">0 wins</span> / <span id="metric-losses">0 losses</span></div>
        </div>

        <div class="card">
          <h2>Win Rate</h2>
          <div class="metric-main" id="metric-win-rate">0%</div>
          <div class="metric-sub">Avg <span id="metric-avg-pnl">-$0.00</span> per trade</div>
        </div>

        <div class="card">
          <h2>PNL (Total)</h2>
          <div class="metric-main negative" id="metric-total-pnl">$0.00</div>
          <div class="metric-sub">Based on closed trades only.</div>
        </div>

        <div class="card">
          <h2>Bot Status</h2>
          <div class="card-row" style="margin-bottom: 6px">
            <div class="status-pill">
              <span class="status-dot status-unknown" id="bot-status-dot"></span>
              <span id="bot-status-label">Unknown</span>
            </div>
            <span class="muted" id="bot-status-minutes"></span>
          </div>
          <div class="metric-sub" id="bot-status-last">Waiting for heartbeat‚Ä¶</div>
        </div>

        <div class="card">
          <h2>Bot Pet</h2>
          <div class="pet-wrap">
            <div class="pet-screen" id="pet-screen">
              <canvas id="pet-canvas" width="96" height="96"></canvas>
            </div>

            <div class="pet-meta">
              <div class="pet-title">
                <div>
                  <div class="muted" style="font-size: 11px; letter-spacing: 0.14em; text-transform: uppercase;">Mood</div>
                  <b id="pet-mood">Watching‚Ä¶</b>
                </div>
                <span class="pet-badge" id="pet-stage">Egg</span>
              </div>

              <div class="pet-sub" id="pet-subtext">Wins are food üçó. Losses are empty plates üçΩÔ∏è.</div>

              <div class="pet-bars">
                <div class="bar-row">
                  <span>Growth</span>
                  <div class="bar"><i id="pet-xp-bar"></i></div>
                  <span class="muted" id="pet-xp-text">0%</span>
                </div>
                <div class="bar-row">
                  <span>Hunger</span>
                  <div class="bar danger"><i id="pet-hunger-bar"></i></div>
                  <span class="muted" id="pet-hunger-text">0%</span>
                </div>
              </div>

              <div class="pet-actions">
                <button class="btn" id="pet-reset-btn">Reset Pet</button>
                <span class="muted" style="font-size:11px" id="pet-debug"></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card section-card">
        <div class="section-title">Advanced Analytics</div>
        <div class="section-subtitle">Deeper stats from your closed trades.</div>
        <div class="advanced-grid">
          <div><div class="adv-label">Profit Factor</div><div class="adv-value" id="adv-profit-factor">‚Äî</div></div>
          <div><div class="adv-label">Avg Win (USD)</div><div class="adv-value" id="adv-avg-win">‚Äî</div></div>
          <div><div class="adv-label">Avg Loss (USD)</div><div class="adv-value" id="adv-avg-loss">‚Äî</div></div>
          <div><div class="adv-label">Best Trade (USD)</div><div class="adv-value" id="adv-best-trade">‚Äî</div></div>
          <div><div class="adv-label">Worst Trade (USD)</div><div class="adv-value" id="adv-worst-trade">‚Äî</div></div>
          <div><div class="adv-label">Max Drawdown (USD)</div><div class="adv-value" id="adv-max-dd">‚Äî</div></div>
          <div><div class="adv-label">Recovery Factor</div><div class="adv-value" id="adv-recovery-factor">‚Äî</div></div>
          <div><div class="adv-label">Sharpe Ratio</div><div class="adv-value" id="adv-sharpe">‚Äî</div></div>
        </div>
      </section>

      <section class="section-grid">
        <div>
          <div class="section-title">Equity Curve</div>
          <div class="section-subtitle">Tracks paper-trading balance over time (USD).</div>
          <div class="chart-container">
            <canvas id="equity-chart" class="chart-inner"></canvas>
          </div>
        </div>

        <div>
          <div class="section-card">
            <div class="section-title">Per-Market Performance</div>
            <div class="section-subtitle">How the bot is doing on each market (paper trading).</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Market</th><th class="text-right">Trades</th><th class="text-right">Win Rate</th><th class="text-right">Total PnL</th><th class="text-right">Avg PnL</th>
                  </tr>
                </thead>
                <tbody id="per-market-body">
                  <tr><td colspan="5" class="muted">No markets yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">Recent Trades</div>
            <div class="section-subtitle">Showing last 20 closed trades.</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr><th>Time</th><th>Market</th><th class="text-right">PnL (USD)</th></tr>
                </thead>
                <tbody id="recent-trades-body">
                  <tr><td colspan="3" class="muted">No trades yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="section-card">
        <div class="section-title">Market Candlestick Charts</div>
        <div class="section-subtitle">TradingView charts only (visual). No real trading.</div>

        <div class="card">
          <div class="card-row" style="margin-bottom: 10px">
            <div>Venue</div>
            <div class="tv-tabs">
              <button class="tv-tab active" data-symbol="COINBASE:BTCUSD">Coinbase</button>
              <button class="tv-tab" data-symbol="KUCOIN:BTCUSDT">KuCoin</button>
              <button class="tv-tab" data-symbol="CRYPTOCOM:BTCUSD">Crypto.com</button>
            </div>
          </div>
          <div class="tradingview-widget-container" style="height: 400px">
            <div id="tv-chart"></div>
          </div>
        </div>
      </section>

      <div class="footer">Bot is running on Render (paper trading only).</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>

    <script>
      // ---------- utils ----------
      function $(id){ return document.getElementById(id); }
      function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
      function formatUsd(v){
        if(v===null||v===undefined||isNaN(v)) return "‚Äî";
        const sign=v<0?"-":"";
        const abs=Math.abs(v);
        return sign+"$"+abs.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      }
      function formatPercent(v,d=1){
        if(v===null||v===undefined||isNaN(v)) return "‚Äî";
        return v.toFixed(d)+"%";
      }
      function formatNumber(v,d=2){
        if(v===null||v===undefined||isNaN(v)) return "‚Äî";
        return v.toFixed(d);
      }
      function formatTime(iso){
        const d=new Date(iso);
        return Number.isNaN(d.getTime()) ? iso : d.toLocaleString();
      }

      // ---------- chart ----------
      let equityChart=null;
      function updateEquityChart(points){
        const ctx=$("equity-chart");
        const labels=points.map(p=>{
          const t=p.time_utc||p.time||"";
          const d=new Date(t);
          return Number.isNaN(d.getTime()) ? "" : d.toLocaleTimeString();
        });
        const data=points.map(p=>p.equity_usd);

        if(equityChart){
          equityChart.data.labels=labels;
          equityChart.data.datasets[0].data=data;
          equityChart.update();
          return;
        }
        equityChart=new Chart(ctx,{
          type:"line",
          data:{ labels, datasets:[{ label:"Equity (USD)", data, tension:0.35, borderWidth:2, pointRadius:2 }] },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(c)=>"Equity: "+formatUsd(c.parsed.y) } } },
            scales:{
              x:{ ticks:{maxTicksLimit:6}, grid:{color:"rgba(31,41,55,0.6)"} },
              y:{ ticks:{ callback:(v)=>"$"+v }, grid:{color:"rgba(31,41,55,0.6)"} }
            }
          }
        });
      }

      // ---------- status ----------
      function updateBotStatus(status){
        const s=status?.status||"unknown";
        $("bot-status-label").textContent=s.charAt(0).toUpperCase()+s.slice(1);
        $("bot-status-dot").className="status-dot status-"+s;
        $("bot-status-minutes").textContent=status?.minutes_since!=null ? (status.minutes_since+" min since heartbeat") : "";
        $("bot-status-last").textContent=status?.last_heartbeat ? ("Last heartbeat: "+formatTime(status.last_heartbeat)) : "Heartbeat file not found yet.";
      }

      // ---------- tables ----------
      function updatePerMarket(perMarket){
        const body=$("per-market-body");
        body.innerHTML="";
        if(!perMarket||perMarket.length===0){
          body.innerHTML=`<tr><td colspan="5" class="muted">No markets yet.</td></tr>`;
          return;
        }
        perMarket.forEach(m=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${m.market}</td>
            <td class="text-right">${m.trades}</td>
            <td class="text-right">${formatPercent(m.win_rate,1)}</td>
            <td class="text-right">${formatUsd(m.total_pnl)}</td>
            <td class="text-right">${formatUsd(m.avg_pnl)}</td>
          `;
          body.appendChild(tr);
        });
      }
      function updateRecentTrades(trades){
        const body=$("recent-trades-body");
        body.innerHTML="";
        if(!trades||trades.length===0){
          body.innerHTML=`<tr><td colspan="3" class="muted">No trades yet.</td></tr>`;
          return;
        }
        trades.forEach(t=>{
          const v=Number(t.pnl_usd);
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${t.time?formatTime(t.time):"‚Äî"}</td>
            <td>${t.market||"‚Äî"}</td>
            <td class="text-right"><span class="pill ${v>=0?"positive":"negative"}">${formatUsd(v)}</span></td>
          `;
          body.appendChild(tr);
        });
      }
      function updateAdvancedMetrics(adv, maxDdFromRoot){
        const a=adv||{};
        $("adv-profit-factor").textContent=a.profit_factor==null?"‚Äî":formatNumber(a.profit_factor,2);
        $("adv-avg-win").textContent=a.avg_win_usd==null?"‚Äî":formatUsd(a.avg_win_usd);
        $("adv-avg-loss").textContent=a.avg_loss_usd==null?"‚Äî":formatUsd(a.avg_loss_usd);
        $("adv-best-trade").textContent=a.best_trade_usd==null?"‚Äî":formatUsd(a.best_trade_usd);
        $("adv-worst-trade").textContent=a.worst_trade_usd==null?"‚Äî":formatUsd(a.worst_trade_usd);
        const maxdd=(a.max_drawdown_usd!=null)?a.max_drawdown_usd:maxDdFromRoot;
        $("adv-max-dd").textContent=maxdd==null?"‚Äî":formatUsd(maxdd);
        $("adv-recovery-factor").textContent=a.recovery_factor==null?"‚Äî":formatNumber(a.recovery_factor,2);
        $("adv-sharpe").textContent=a.sharpe_ratio==null?"‚Äî":formatNumber(a.sharpe_ratio,2);
      }

      // ---------- TV ----------
      let currentSymbol="COINBASE:BTCUSD";
      function loadTradingView(symbol){
        currentSymbol=symbol;
        const container=document.getElementById("tv-chart");
        container.innerHTML="";
        new TradingView.widget({
          autosize:true, symbol, interval:"15", timezone:"Etc/UTC",
          theme:"dark", style:"1", locale:"en",
          enable_publishing:false, withdateranges:true, allow_symbol_change:false,
          container_id:"tv-chart"
        });
      }
      function setupTvTabs(){
        document.querySelectorAll(".tv-tab").forEach(tab=>{
          tab.addEventListener("click",()=>{
            document.querySelectorAll(".tv-tab").forEach(t=>t.classList.remove("active"));
            tab.classList.add("active");
            loadTradingView(tab.dataset.symbol);
          });
        });
      }

      // ==========================================================
      // PET
      // ==========================================================
      const PET_KEY="botpet_animals_v3"; // new key so this sprite upgrade starts clean
      const DEFAULT_PET={
        hatched:false,
        species:null,            // cat/dog
        stage:"egg",             // egg/hatchling/baby/teen/adult
        xp:0,
        hunger:35,
        fainted:false,
        mood:"watching",
        lastTotalTrades:0,
        lastWins:0,
        lastLosses:0,
        lastEventAt:Date.now(),
        anim:{mode:"idle", until:0},
        lastEvent:"none",
        blinkUntil:0,
        blinkNext: Date.now() + 2500 + Math.random()*2500,
      };

      const HATCH_PNL_THRESHOLD=0.01;
      const HUNGER_TIME_RATE=1.15;   // per hour drift
      const TICK_MS=120;

      const FAINT_AT=100;
      const REVIVE_BELOW=85;

      function loadPet(){
        try{
          const raw=localStorage.getItem(PET_KEY);
          if(!raw) return structuredClone(DEFAULT_PET);
          const p=JSON.parse(raw);
          return { ...structuredClone(DEFAULT_PET), ...p, anim:{...DEFAULT_PET.anim,...(p.anim||{})} };
        }catch{ return structuredClone(DEFAULT_PET); }
      }
      function savePet(p){ localStorage.setItem(PET_KEY, JSON.stringify(p)); }
      function resetPet(){ const p=structuredClone(DEFAULT_PET); savePet(p); return p; }

      function setAnim(p,mode,ms){ p.anim={mode, until: Date.now()+ms}; }
      function animMode(p){ return (Date.now() <= (p.anim?.until||0)) ? (p.anim?.mode||"idle") : "idle"; }
      function pickSpeciesRandom(){ return Math.random()<0.5 ? "cat" : "dog"; }

      function stageFromXp(xp, hatched){
        if(!hatched) return "egg";
        if(xp < 10) return "hatchling";
        if(xp < 30) return "baby";
        if(xp < 65) return "teen";
        return "adult";
      }

      function applyTimeHunger(p){
        const now=Date.now();
        const dt=Math.max(0, now-(p.lastEventAt||now));
        const add=(dt/(60*60*1000))*HUNGER_TIME_RATE;
        p.hunger = clamp(p.hunger + add, 0, 100);
        p.lastEventAt=now;
      }

      function maybeHatch(p, totalPnl){
        if(p.hatched) return false;
        if(totalPnl > HATCH_PNL_THRESHOLD){
          p.hatched=true;
          p.species=pickSpeciesRandom();
          p.xp=Math.max(p.xp, 2);
          p.stage="hatchling";
          p.lastEvent="none";
          setAnim(p,"hatch",2000);
          return true;
        }
        return false;
      }

      function processTradeDeltas(p, data){
        const totalTrades=data.total_trades??0;
        const wins=data.wins??0;
        const losses=data.losses??0;

        const dTrades=totalTrades-(p.lastTotalTrades||0);
        const dWins=wins-(p.lastWins||0);
        const dLosses=losses-(p.lastLosses||0);

        p.lastTotalTrades=totalTrades;
        p.lastWins=wins;
        p.lastLosses=losses;

        if(dTrades<=0) return {dTrades:0,dWins:0,dLosses:0};

        if(dWins>0){
          p.xp = clamp(p.xp + dWins*5, 0, 100);
          p.hunger = clamp(p.hunger - dWins*14, 0, 100);
          p.mood="happy";
          p.lastEvent="food";
          setAnim(p,"eat",1400);
        }
        if(dLosses>0 && !p.fainted){
          p.hunger = clamp(p.hunger + dLosses*13, 0, 100);
          p.mood="sad";
          p.lastEvent="empty";
          setAnim(p,"sad",1400);
        }
        return {dTrades,dWins,dLosses};
      }

      function updateFaintState(p){
        if(!p.hatched) return;
        if(!p.fainted && p.hunger >= FAINT_AT){
          p.fainted=true;
          p.mood="sad";
          setAnim(p,"faint",4500);
        }
        if(p.fainted && p.hunger <= REVIVE_BELOW){
          p.fainted=false;
          p.mood="happy";
          setAnim(p,"revive",1800);
        }
      }

      // ---------- pixel renderer ----------
      const canvas=$("pet-canvas");
      const ctx=canvas.getContext("2d");
      const SCALE=3;

      // stronger outline / contrast
      const PALETTE={
        " ": null,
        ".": "rgba(0,0,0,0.18)",
        "#": "#0b1220",
        "W": "#f1f5f9",
        "G": "#94a3b8",
        "D": "#64748b",
        "P": "#fb7185",
        "Y": "#fbbf24",
        "B": "#60a5fa",
        "R": "#ef4444",
        "O": "#f97316",
        "K": "#0b1220",
        "T": "#22c55e"
      };

      function drawFrame(frame, ox, oy, scale){
        for(let y=0;y<frame.length;y++){
          const row=frame[y];
          for(let x=0;x<row.length;x++){
            const ch=row[x];
            const col=PALETTE[ch];
            if(!col) continue;
            ctx.fillStyle=col;
            ctx.fillRect(ox + x*scale, oy + y*scale, scale, scale);
          }
        }
      }
      function drawCentered(frame, bobY=0){
        drawFrame(frame, 0, Math.floor(bobY), SCALE);
      }
      function drawSparkles(t){
        ctx.save();
        ctx.globalAlpha=0.85;
        ctx.fillStyle=PALETTE["B"];
        const pts=[[14,14],[80,20],[22,78],[74,72]];
        pts.forEach((p,i)=>{
          const pulse=(Math.sin((t/120)+(i*1.2))*0.5+0.5);
          const r=1+Math.floor(pulse*2);
          ctx.fillRect(p[0]-r,p[1],r*2,1);
          ctx.fillRect(p[0],p[1]-r,1,r*2);
        });
        ctx.restore();
      }

      function badgeText(p){
        if(!p.hatched) return "Egg";
        if(p.fainted) return (p.species==="dog"?"Dog":"Cat")+" (Fainted)";
        const sp=p.species==="dog"?"Dog":"Cat";
        const st=p.stage||"hatchling";
        if(st==="hatchling") return "Hatchling "+sp;
        if(st==="baby") return "Baby "+sp;
        if(st==="teen") return "Teen "+sp;
        return "Adult "+sp;
      }

      function moodText(p){
        if(p.fainted) return "Fainted ‚ò†Ô∏è (needs wins)";
        if(!p.hatched) return "Incubating‚Ä¶ ü•ö";
        if(p.hunger>=85) return "Starving üòø";
        if(p.hunger>=65) return "Hungry üêæ";
        if(p.mood==="sad") return "Sad üò¢";
        return "Happy üòä";
      }

      function pct(v){ return Math.round(clamp(v,0,100)); }

      // --------- SPRITES ----------
      const FRAMES = {
        // egg
        egg_idle:[
          "                                ",
          "            #######             ",
          "         ###GGGGGG###           ",
          "       ##GGGGWWWWGGGG##         ",
          "      #GGGWWWWWWWWWWGGG#        ",
          "     #GGWWGGGGGGGGGGWWGG#       ",
          "    #GGWGGGGGGGGGGGGGGWGG#      ",
          "    #GGWGGGGGGGGGGGGGGWGG#      ",
          "   #GGWGGGGGGGGGGGGGGGGWGG#     ",
          "   #GGWGGGGGGGGGGGGGGGGWGG#     ",
          "   #GGWGGGGGGGGGGGGGGGGWGG#     ",
          "   #GGWWGGGGGGGGGGGGGGWWGG#     ",
          "   #GGGWWWWGGGGGGGGWWWWGGG#     ",
          "    #GGGGGWWWWWWWWWWGGGGG#      ",
          "     #GGGGGGGGGGGGGGGGGG#       ",
          "      #GGGGGGGGGGGGGGGG#        ",
          "       ##GGGGGGGGGGGG##         ",
          "         ###GGGGGG###           ",
          "            #######             ",
          "                                ",
          "          .............         ",
          "        .................       ",
          "          .............         ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        egg_crack:[
          "                                ",
          "            #######             ",
          "         ###GGGGGG###           ",
          "       ##GGGGWWWWGGGG##         ",
          "      #GGGWWWW##WWWWGGG#        ",
          "     #GGWWGGG##  ##GGWWGG#      ",
          "    #GGWGGGG##    ##GGGGWGG#    ",
          "    #GGWGGG##      ##GGGGWGG#   ",
          "   #GGWGGG##   ##   ##GGGGWGG#  ",
          "   #GGWGG##   ####   ##GGGWGG#  ",
          "   #GGWGG##    ##    ##GGGWGG#  ",
          "   #GGWWG##          ##GGWWGG#  ",
          "   #GGGWW##   ####   ##WWGGG#   ",
          "    #GGGG##  ######  ##GGGG#    ",
          "     #GGG##   ####   ##GGG#     ",
          "      #GG##          ##GG#      ",
          "       ##GGGGGGGGGGGGGG##       ",
          "         ###GGGGGGGG###         ",
          "            #######             ",
          "                                ",
          "          .............         ",
          "        .................       ",
          "          .............         ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        egg_shake:[
          "                                ",
          "             #######            ",
          "          ###GGGGGG###          ",
          "        ##GGGGWWWWGGGG##        ",
          "       #GGGWWWWWWWWWWGGG#       ",
          "      #GGWWGGGGGGGGGGWWGG#      ",
          "     #GGWGGGGGGGGGGGGGGWGG#     ",
          "     #GGWGGGGGGGGGGGGGGWGG#     ",
          "    #GGWGGGGGGGGGGGGGGGGWGG#    ",
          "    #GGWGGGGGGGGGGGGGGGGWGG#    ",
          "    #GGWGGGGGGGGGGGGGGGGWGG#    ",
          "    #GGWWGGGGGGGGGGGGGGWWGG#    ",
          "    #GGGWWWWGGGGGGGGWWWWGGG#    ",
          "     #GGGGGWWWWWWWWWWGGGGG#     ",
          "      #GGGGGGGGGGGGGGGGGG#      ",
          "       #GGGGGGGGGGGGGGGG#       ",
          "        ##GGGGGGGGGGGG##        ",
          "          ###GGGGGG###          ",
          "             #######            ",
          "                                ",
          "           .............        ",
          "         .................      ",
          "           .............        ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        eggshell_bits:[
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "      ..  .  ..  .  ..          ",
          "    .  . .  .  . .  .  .        ",
          "   .  .   .   .   .   .  .      ",
          "     . . . . . . . . .          ",
          "   .   .   .   .   .   .        ",
          "      . . .   . . .             ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        bowl_food:[
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "           ##########           ",
          "         ##WWWWWWWWWW##         ",
          "        #WWWWYYWWYYWWWW#        ",
          "        #WWWWWWWWWWWWWW#        ",
          "         ##WWWWWWWWWW##         ",
          "           ##########           ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        plate_empty:[
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "            #######             ",
          "          ##WWWWWWW##           ",
          "        ##WWWWWWWWWWW##         ",
          "       #WWWWWWWWWWWWWWW#        ",
          "        ##WWWWWWWWWWW##         ",
          "          ##WWWWWWW##           ",
          "            #######             ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        scarf_teen:[
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "        RRRRRRRRRRRRRR          ",
          "       RRRR RRRRRR RRRR         ",
          "        RRRRRR  RRRRRR          ",
          "          RR      RR            ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],
        crown_adult:[
          "                                ",
          "             Y   Y              ",
          "            YYY YYY             ",
          "           YYYYYYYYY            ",
          "          YYYYYYYYYYY           ",
          "           YY  YY  YY           ",
          "            YYYYYYYY            ",
          "             YYYYYY             ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
          "                                ",
        ],

        // ===== CAT (clearer ears + tail + body)
        cat_adult_idle1:[
"                                ",
"                                ",
"            ##KWWK##            ",
"           #KWWWWWWK#           ",
"          #KWWPPPPWWK#          ",
"         #KWWPWWWWPWWK#         ",
"         #KWWWWWWWWWWK#         ",
"         #KWWWK####KWWK#        ",
"          #KWWK####KWWK#        ",
"           #KWWKKKKWWK#         ",
"            ##KWWWWK##          ",
"              KWWWWK            ",
"        ######KWWWWK######      ",
"       #..###KWWWWWWK###..#     ",
"       #..###KWWWWWWK###..#     ",
"        ######KWWWWK######      ",
"          ###KWWWWWWK###        ",
"            #KWWWWWWK#          ",
"            #KWWWWWWK#          ",
"             ##KWWK##           ",
"               K  K             ",
"              K    K            ",
"             K  KK  K           ",
"              KK  KK            ",
"                KK              ",
"               KKKK             ",
"              KK  KK            ",
"                 KK             ",
"                                ",
"                                ",
"                                ",
"                                ",
        ],
        cat_adult_idle2:[
"                                ",
"                                ",
"            ##KWWK##            ",
"           #KWWWWWWK#           ",
"          #KWWPPPPWWK#          ",
"         #KWWPWWWWPWWK#         ",
"         #KWWWWWWWWWWK#         ",
"         #KWWWK######WWK#       ",
"          #KWWK####KWWK#        ",
"           #KWWKKKKWWK#         ",
"            ##KWWWWK##          ",
"              KWWWWK            ",
"        ######KWWWWK######      ",
"       #..###KWWWWWWK###..#     ",
"       #..###KWWWWWWK###..#     ",
"        ######KWWWWK######      ",
"          ###KWWWWWWK###        ",
"            #KWWWWWWK#          ",
"            #KWWWWWWK#          ",
"             ##KWWK##           ",
"               K  K             ",
"              K    K            ",
"              K KK K            ",
"               K  K             ",
"                KK              ",
"               KKK              ",
"              KK KK             ",
"                KK              ",
"                                ",
"                                ",
"                                ",
"                                ",
        ],
        cat_adult_idle1_blink:[
"                                ",
"                                ",
"            ##KWWK##            ",
"           #KWWWWWWK#           ",
"          #KWWGGGGWWK#          ",
"         #KWWGWWWWGWWK#         ",
"         #KWWWWWWWWWWK#         ",
"         #KWWWK####KWWK#        ",
"          #KWWK####KWWK#        ",
"           #KWWKKKKWWK#         ",
"            ##KWWWWK##          ",
"              KWWWWK            ",
"        ######KWWWWK######      ",
"       #..###KWWWWWWK###..#     ",
"       #..###KWWWWWWK###..#     ",
"        ######KWWWWK######      ",
"          ###KWWWWWWK###        ",
"            #KWWWWWWK#          ",
"            #KWWWWWWK#          ",
"             ##KWWK##           ",
"               K  K             ",
"              K    K            ",
"             K  KK  K           ",
"              KK  KK            ",
"                KK              ",
"               KKKK             ",
"              KK  KK            ",
"                 KK             ",
"                                ",
"                                ",
"                                ",
"                                ",
        ],
        cat_adult_walk1:null, // will fall back to idle if missing
        cat_adult_walk2:null,
        cat_adult_sad1:[
"                                ",
"                                ",
"            ##KWWK##            ",
"           #KWWWWWWK#           ",
"          #KWWRRRRWWK#          ",
"         #KWWRWWWWRWWK#         ",
"         #KWWWWWWWWWWK#         ",
"         #KWWWK######WWK#       ",
"          #KWWK####KWWK#        ",
"           #KWWKKKKWWK#         ",
"            ##KWWWWK##          ",
"              KWWWWK            ",
"        ######KWWWWK######      ",
"       #..###KWWWWWWK###..#     ",
"       #..###KWWWWWWK###..#     ",
"        ######KWWWWK######      ",
"          ###KWWWWWWK###        ",
"             ..RR..RR..         ",
"              .RR..RR.          ",
"               ..  ..           ",
"               K  K             ",
"              K    K            ",
"             K  KK  K           ",
"              KK  KK            ",
"                KK              ",
"               KKKK             ",
"              KK  KK            ",
"                 KK             ",
"                                ",
"                                ",
"                                ",
"                                ",
        ],

        // CAT FAINTED (recognisable)
        cat_faint:[
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"           ##KWWK##             ",
"          #KWWWWWWK#            ",
"         #KWWRRRRWWK#           ",
"         #KWWRWWWRWWK#          ",
"         #KWWWWWWWWWK#          ",
"          #KWWWKKKWWK#          ",
"           ##KWWWWK##           ",
"              KWWK              ",
"      ######  KWWK  ######      ",
"     #..###KWWWWWWK###..#       ",
"     #..###KWWWWWWK###..#       ",
"      ######KWWWWK######        ",
"        ###KWWWWWWK###          ",
"          #KWWWWWWK#            ",
"           ##KWWK##             ",
"             K  K               ",
"            K    K              ",
"            K KK K              ",
"             K  K               ",
"              KK                ",
"             KKK                ",
"            KK KK               ",
"              KK                ",
"                                ",
"                                ",
"                                ",
"                                ",
        ],

        // ===== DOG (clear floppy ears + snout)
        dog_adult_idle1:[
"                                ",
"                                ",
"        ##KWWK##  ##KWWK##      ",
"       #KWWWWWK##KWWWWWWK#      ",
"      #KWWPPPPWWWWPPPPWWK#      ",
"      #KWWPWWWWWWWWWWWPWWK#     ",
"      #KWWWWWWWWWWWWWWWWK#      ",
"       #KWWWK######KWWWWK#      ",
"        #KWWK##KK##KWWWWK#      ",
"         #KWWK  KK  KWWK#       ",
"          ##KWWWWWWWWK##        ",
"            #KWWWWWWK#          ",
"        ####KWWWWWWWWK####      ",
"       #..##KWWWWWWWWK##..#     ",
"       #..##KWWWWWWWWK##..#     ",
"        ####KWWWWWWWWK####      ",
"          ##KWWWWWWWWK##        ",
"            #KWWWWWWK#          ",
"            #KWWWWWWK#          ",
"             ##KWWK##           ",
"               KKK              ",
"              K   K             ",
"              K   K             ",
"               KKK              ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
        ],
        dog_adult_idle2:[
"                                ",
"                                ",
"        ##KWWK##  ##KWWK##      ",
"       #KWWWWWK##KWWWWWWK#      ",
"      #KWWPPPPWWWWPPPPWWK#      ",
"      #KWWPWWWWWWWWWWWPWWK#     ",
"      #KWWWWWWWWWWWWWWWWK#      ",
"       #KWWWK########WWWWK#     ",
"        #KWWK##KK  ##KWWK#      ",
"         #KWWK  KK   KWWK#      ",
"          ##KWWWWWWWWK##        ",
"            #KWWWWWWK#          ",
"        ####KWWWWWWWWK####      ",
"       #..##KWWWWWWWWK##..#     ",
"       #..##KWWWWWWWWK##..#     ",
"        ####KWWWWWWWWK####      ",
"          ##KWWWWWWWWK##        ",
"            #KWWWWWWK#          ",
"            #KWWWWWWK#          ",
"             ##KWWK##           ",
"               KKK              ",
"             K   K              ",
"             K   K              ",
"              KKK               ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
        ],
        dog_adult_sad1:[
"                                ",
"                                ",
"        ##KWWK##  ##KWWK##      ",
"       #KWWWWWK##KWWWWWWK#      ",
"      #KWWRRRRWWWWRRRRWWK#      ",
"      #KWWRWWWWWWWWWWWRWWK#     ",
"      #KWWWWWWWWWWWWWWWWK#      ",
"       #KWWWK########WWWWK#     ",
"        #KWWK##KK  ##KWWK#      ",
"         #KWWK  KK   KWWK#      ",
"          ##KWWWWWWWWK##        ",
"            #KWWWWWWK#          ",
"        ####KWWWWWWWWK####      ",
"       #..##KWWWWWWWWK##..#     ",
"       #..##KWWWWWWWWK##..#     ",
"        ####KWWWWWWWWK####      ",
"          ##KWWWWWWWWK##        ",
"             ..RR..RR..         ",
"              .RR..RR.          ",
"               ..  ..           ",
"               KKK              ",
"              K   K             ",
"              K   K             ",
"               KKK              ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
        ],
        dog_faint:[
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"        ##KWWK##  ##KWWK##      ",
"       #KWWWWWK##KWWWWWWK#      ",
"      #KWWRRRRWWWWRRRRWWK#      ",
"      #KWWRWWWWWWWWWWWRWWK#     ",
"      #KWWWWWWWWWWWWWWWWK#      ",
"       #KWWWK######KWWWWK#      ",
"        #KWWK##KK##KWWWWK#      ",
"          ##KWWWWWWWWK##        ",
"            #KWWWWWWK#          ",
"      ######KWWWWWWWWK######    ",
"     #..###KWWWWWWWWWWK###..#   ",
"      ######KWWWWWWWWK######    ",
"          ##KWWWWWWWWK##        ",
"             ##KWWK##           ",
"               KKK              ",
"              K   K             ",
"              K   K             ",
"               KKK              ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
"                                ",
        ],
      };

      // Use the clear animal sprites for ALL stages (avoid ‚Äúghost baby‚Äù)
      (function normalizeAnimalStages(){
        const species=["cat","dog"];
        for(const sp of species){
          FRAMES[`${sp}_baby_idle1`] = FRAMES[`${sp}_adult_idle1`];
          FRAMES[`${sp}_baby_idle2`] = FRAMES[`${sp}_adult_idle2`];
          FRAMES[`${sp}_baby_idle1_blink`] = FRAMES[`${sp}_adult_idle1_blink`] || FRAMES[`${sp}_adult_idle1`];

          FRAMES[`${sp}_teen_idle1`] = FRAMES[`${sp}_adult_idle1`];
          FRAMES[`${sp}_teen_idle2`] = FRAMES[`${sp}_adult_idle2`];
          FRAMES[`${sp}_teen_idle1_blink`] = FRAMES[`${sp}_adult_idle1_blink`] || FRAMES[`${sp}_adult_idle1`];

          // optional walk frames
          FRAMES[`${sp}_baby_walk1`] = FRAMES[`${sp}_adult_walk1`] || FRAMES[`${sp}_adult_idle1`];
          FRAMES[`${sp}_baby_walk2`] = FRAMES[`${sp}_adult_walk2`] || FRAMES[`${sp}_adult_idle2`];
          FRAMES[`${sp}_teen_walk1`] = FRAMES[`${sp}_adult_walk1`] || FRAMES[`${sp}_adult_idle1`];
          FRAMES[`${sp}_teen_walk2`] = FRAMES[`${sp}_adult_walk2`] || FRAMES[`${sp}_adult_idle2`];

          // sad
          FRAMES[`${sp}_baby_sad1`] = FRAMES[`${sp}_adult_sad1`] || FRAMES[`${sp}_adult_idle1`];
          FRAMES[`${sp}_teen_sad1`] = FRAMES[`${sp}_adult_sad1`] || FRAMES[`${sp}_adult_idle1`];
        }
      })();

      function getFrame(species, stage, action, toggle, blink){
        const st = (stage === "hatchling") ? "baby" : stage;
        const base = `${species}_${st}_${action}${toggle ? "1" : "2"}`;

        if(action === "idle" && blink){
          const key = `${species}_${st}_idle1_blink`;
          if(FRAMES[key]) return FRAMES[key];
          const fall = `${species}_adult_idle1_blink`;
          if(FRAMES[fall]) return FRAMES[fall];
        }
        if(FRAMES[base]) return FRAMES[base];

        const adultKey = `${species}_adult_${action}${toggle ? "1" : "2"}`;
        if(FRAMES[adultKey]) return FRAMES[adultKey];

        return FRAMES[`${species}_adult_idle1`];
      }

      let pet=loadPet();
      let toggle=false;
      let lastRender=0;

      function maybeBlink(p){
        const now = Date.now();
        if(now >= (p.blinkNext||0)){
          p.blinkUntil = now + (120 + Math.random()*120);
          p.blinkNext = now + 2200 + Math.random()*3200;
        }
      }

      function renderPet(deltaInfo){
        pet=loadPet();
        const screen=$("pet-screen");
        const mode=animMode(pet);
        const t=Date.now();

        maybeBlink(pet);
        const blinking = t <= (pet.blinkUntil||0);

        const bob = Math.sin(t/240)*1.2 + Math.sin(t/900)*0.7;

        ctx.clearRect(0,0,canvas.width,canvas.height);

        const sp = (pet.species==="dog") ? "dog" : "cat";

        // ‚úÖ FIX: fainted shows a *fainted animal*, not a blob/stone
        if(pet.fainted && pet.hatched){
          screen.classList.remove("shake");
          drawCentered(FRAMES[`${sp}_faint`], bob);
          if(mode==="revive") drawSparkles(t);
        }
        else if(!pet.hatched){
          if(mode==="hatch"){
            screen.classList.add("shake");
            drawCentered(toggle ? FRAMES.egg_crack : FRAMES.egg_shake, bob);
            drawSparkles(t);
          } else {
            screen.classList.remove("shake");
            drawCentered(toggle ? FRAMES.egg_shake : FRAMES.egg_idle, bob);
          }
        } else {
          screen.classList.remove("shake");
          const stage = pet.stage;

          let action="idle";
          if(mode==="eat") action="idle";
          else if(mode==="sad") action="sad";
          else {
            const wantsWalk = (pet.hunger>60) ? true : (Math.random()<0.16);
            action = wantsWalk ? "walk" : "idle";
          }

          const frame = getFrame(sp, stage, action, toggle, blinking && action==="idle");
          drawCentered(frame, bob);

          if(mode==="eat"){
            drawCentered(FRAMES.bowl_food, 18);
            drawSparkles(t);
          } else if(mode==="sad"){
            drawCentered(FRAMES.plate_empty, 18);
          } else {
            if(pet.lastEvent==="food") drawCentered(FRAMES.bowl_food, 18);
            if(pet.lastEvent==="empty") drawCentered(FRAMES.plate_empty, 18);
          }

          if(stage==="hatchling") drawCentered(FRAMES.eggshell_bits, 18);
          if(stage==="teen") drawCentered(FRAMES.scarf_teen, 2);
          if(stage==="adult") drawCentered(FRAMES.crown_adult, 0);
        }

        pet.stage = stageFromXp(pet.xp, pet.hatched);

        $("pet-mood").textContent=moodText(pet);
        $("pet-stage").textContent=badgeText(pet);

        const xpp=pct(pet.xp);
        $("pet-xp-bar").style.width=xpp+"%";
        $("pet-xp-text").textContent=xpp+"%";

        const hp=pct(pet.hunger);
        $("pet-hunger-bar").style.width=hp+"%";
        $("pet-hunger-text").textContent=hp+"%";

        if(pet.fainted){
          $("pet-subtext").textContent="It fainted from hunger. It won‚Äôt reset ‚Äî feed it wins to revive üçó";
        } else if(!pet.hatched){
          $("pet-subtext").textContent="Egg stays until overall PnL turns positive‚Ä¶ then it hatches into a random cat or dog ü•ö‚ú®";
        } else {
          const spName=pet.species==="dog"?"dog":"cat";
          let msg="Wins are food üçó. Losses are empty plates üçΩÔ∏è.";
          if(pet.hunger>=85) msg="Starving‚Ä¶ feed it wins üçóüòø";
          else if(pet.hunger>=65) msg="Hungry‚Ä¶ it paces more when hungry üêæ";
          else if(mode==="eat") msg="Yum! A win fed it üçó‚ú®";
          else if(mode==="sad") msg="Ouch‚Ä¶ empty plate üçΩÔ∏è";
          $("pet-subtext").textContent=`Hatched as a ${spName}. Stage: ${pet.stage}. ${msg}`;
        }

        const dbg=[];
        if(deltaInfo?.dWins) dbg.push(`+${deltaInfo.dWins} win`);
        if(deltaInfo?.dLosses) dbg.push(`+${deltaInfo.dLosses} loss`);
        $("pet-debug").textContent=dbg.join(", ");

        savePet(pet);

        toggle = (Math.floor(t/180) % 2) === 0 ? !toggle : toggle;
      }

      $("pet-reset-btn").addEventListener("click",()=>{
        if(confirm("Reset the pet back to egg? (This does not affect bot data)")){
          pet=resetPet();
          renderPet(null);
        }
      });

      // ---------- refresh ----------
      async function refreshDashboard(){
        try{
          const res=await fetch("/data");
          const data=await res.json();

          $("metric-total-trades").textContent=data.total_trades??0;
          $("metric-wins").textContent=(data.wins??0)+" wins";
          $("metric-losses").textContent=(data.losses??0)+" losses";

          const winRate=data.win_rate!=null?data.win_rate:0;
          $("metric-win-rate").textContent=formatPercent(winRate,1);

          const totalTrades=data.total_trades??0;
          const totalPnl=Number(data.total_pnl_usd??0);
          const avgPnl=totalTrades?(totalPnl/totalTrades):0;
          $("metric-avg-pnl").textContent=formatUsd(avgPnl);

          const pnlEl=$("metric-total-pnl");
          pnlEl.textContent=formatUsd(totalPnl);
          pnlEl.classList.remove("positive","negative");
          pnlEl.classList.add(totalPnl>=0?"positive":"negative");

          updateEquityChart(data.equity_curve||[]);
          updateBotStatus(data.bot_status);
          updatePerMarket(data.per_market||[]);
          updateRecentTrades(data.recent_trades||[]);
          updateAdvancedMetrics(data.advanced_metrics, data.max_drawdown_usd);

          pet=loadPet();
          applyTimeHunger(pet);

          // keep species once hatched (never lose identity)
          if(pet.hatched && !pet.species) pet.species = (Math.random()<0.5 ? "cat" : "dog");

          maybeHatch(pet, totalPnl);

          const deltaInfo=processTradeDeltas(pet, data);
          updateFaintState(pet);

          savePet(pet);
          renderPet(deltaInfo);

        }catch(err){
          console.error("Failed to refresh dashboard", err);
        }
      }

      // ---------- pet loop ----------
      function petLoop(){
        const now=Date.now();
        if(now-lastRender > TICK_MS){
          lastRender=now;
          renderPet(null);
        }
        requestAnimationFrame(petLoop);
      }

      // ---------- init ----------
      document.addEventListener("DOMContentLoaded",()=>{
        setupTvTabs();
        loadTradingView(currentSymbol);
        renderPet(null);
        refreshDashboard();
        setInterval(refreshDashboard, 10_000);
        requestAnimationFrame(petLoop);
      });
    </script>
  </body>
</html>
