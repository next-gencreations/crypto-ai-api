<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crypto AI Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #050814;
        --bg-card: #101522;
        --bg-card-soft: #141b2c;
        --text-main: #f8f4fc;
        --text-muted: #9ca3af;
        --accent: #22c55e;
        --accent-red: #ef4444;
        --accent-blue: #3b82f6;
        --border-soft: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text-main);
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        margin-bottom: 24px;
      }

      h1 {
        margin: 0 0 4px;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      header p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted);
      }

      header a {
        color: #38bdf8;
        text-decoration: none;
        margin-left: 4px;
        margin-right: 4px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .card {
        background: linear-gradient(145deg, var(--bg-card), #060b17);
        border-radius: 14px;
        padding: 14px 16px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      }

      .card h2 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .metric-main {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .metric-sub {
        font-size: 12px;
        color: var(--text-muted);
      }

      .metric-main.positive {
        color: var(--accent);
      }

      .metric-main.negative {
        color: var(--accent-red);
      }

      .card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.8);
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
      }

      .status-running {
        background-color: #22c55e;
      }

      .status-idle {
        background-color: #eab308;
      }

      .status-stopped {
        background-color: #ef4444;
      }

      .status-unknown {
        background-color: #6b7280;
      }

      .section-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .section-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin: 0 0 12px;
      }

      .section-card {
        margin-bottom: 24px;
      }

      .chart-container {
        height: 260px;
        background: radial-gradient(circle at top, #020617, #020617);
        border-radius: 14px;
        border: 1px solid var(--border-soft);
        overflow: hidden;
      }

      .chart-inner {
        width: 100%;
        height: 100%;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      thead {
        background: rgba(15, 23, 42, 0.9);
      }

      th,
      td {
        padding: 8px 10px;
        text-align: left;
      }

      th {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-bottom: 1px solid var(--border-soft);
      }

      tbody tr:nth-child(odd) {
        background: rgba(15, 23, 42, 0.4);
      }

      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.1);
      }

      tbody tr:hover {
        background: rgba(55, 65, 81, 0.4);
      }

      .text-right {
        text-align: right;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        background: rgba(15, 23, 42, 0.9);
      }

      .pill.positive {
        color: var(--accent);
      }

      .pill.negative {
        color: var(--accent-red);
      }

      .muted {
        color: var(--text-muted);
      }

      .section-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
        gap: 16px;
      }

      @media (max-width: 900px) {
        .section-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .advanced-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px 14px;
        margin-top: 6px;
      }

      .adv-label {
        font-size: 11px;
        color: var(--text-muted);
      }

      .adv-value {
        font-size: 14px;
        font-weight: 600;
      }

      /* TradingView area */
      .tv-tabs {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        padding: 2px;
        margin-bottom: 8px;
      }

      .tv-tab {
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        cursor: pointer;
      }

      .tv-tab.active {
        background: #0f172a;
        color: var(--text-main);
      }

      .footer {
        margin-top: 18px;
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
      }

      /* ------------------------------
         BOT PET
      ------------------------------ */
      .pet-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .pet-card {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 10px;
      }

      .pet-top {
        display: grid;
        grid-template-columns: minmax(0, 0.95fr) minmax(0, 1.05fr);
        gap: 12px;
        align-items: center;
      }

      @media (max-width: 520px) {
        .pet-top {
          grid-template-columns: 1fr;
        }
      }

      .pet-screen {
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: radial-gradient(
            circle at 30% 20%,
            rgba(59, 130, 246, 0.22),
            transparent 45%
          ),
          radial-gradient(
            circle at 70% 80%,
            rgba(34, 197, 94, 0.18),
            transparent 45%
          ),
          rgba(2, 6, 23, 0.55);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.25),
          0 16px 44px rgba(0, 0, 0, 0.45);
        padding: 14px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 220px; /* big, but safe */
      }

      .pet-canvas-wrap {
        width: min(220px, 56vw);
        aspect-ratio: 1 / 1;
        display: grid;
        place-items: center;
      }

      canvas#pet-canvas {
        width: 100%;
        height: 100%;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.45));
      }

      .pet-info h3 {
        margin: 0 0 6px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--text-muted);
      }

      .pet-mood {
        font-size: 36px;
        line-height: 1.05;
        margin: 0 0 6px;
        font-weight: 800;
        letter-spacing: 0.01em;
      }

      .pet-sub {
        margin: 0 0 10px;
        color: var(--text-muted);
        font-size: 14px;
      }

      .pet-bars {
        display: grid;
        gap: 10px;
        margin: 12px 0 10px;
      }

      .bar-row {
        display: grid;
        grid-template-columns: 80px 1fr 48px;
        gap: 10px;
        align-items: center;
        font-size: 12px;
        color: var(--text-muted);
      }

      .bar {
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        background: rgba(15, 23, 42, 0.75);
        overflow: hidden;
      }

      .bar > span {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #22c55e, #38bdf8);
        border-radius: 999px;
      }

      .bar.hunger > span {
        background: linear-gradient(90deg, #f59e0b, #ef4444);
      }

      .pet-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .btn {
        border: 1px solid rgba(148, 163, 184, 0.16);
        background: rgba(15, 23, 42, 0.75);
        color: var(--text-main);
        padding: 10px 14px;
        border-radius: 999px;
        font-weight: 700;
        cursor: pointer;
      }

      .btn:active {
        transform: translateY(1px);
      }

      .pet-note {
        margin: 10px 0 0;
        color: var(--text-muted);
        font-size: 12px;
        line-height: 1.35;
      }

      .pet-note b {
        color: var(--text-main);
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header>
        <h1>Crypto AI Bot Dashboard</h1>
        <p>
          Paper-trading stats from Render ‚Äî
          <a href="/data" target="_blank">raw stats</a>
        </p>
      </header>

      <!-- Top KPIs -->
      <section class="cards">
        <div class="card">
          <h2>Total Trades</h2>
          <div class="metric-main" id="metric-total-trades">0</div>
          <div class="metric-sub">
            <span id="metric-wins">0 wins</span> /
            <span id="metric-losses">0 losses</span>
          </div>
        </div>

        <div class="card">
          <h2>Win Rate</h2>
          <div class="metric-main" id="metric-win-rate">0%</div>
          <div class="metric-sub">
            Avg <span id="metric-avg-pnl">-$0.00</span> per trade
          </div>
        </div>

        <div class="card">
          <h2>PNL (Total)</h2>
          <div class="metric-main negative" id="metric-total-pnl">$0.00</div>
          <div class="metric-sub">Based on closed trades only.</div>
        </div>

        <div class="card">
          <h2>Bot Status</h2>
          <div class="card-row" style="margin-bottom: 6px">
            <div class="status-pill" id="bot-status-pill">
              <span class="status-dot status-unknown" id="bot-status-dot"></span>
              <span id="bot-status-label">Unknown</span>
            </div>
            <span class="muted" id="bot-status-minutes"></span>
          </div>
          <div class="metric-sub" id="bot-status-last">Waiting for heartbeat‚Ä¶</div>
        </div>

        <!-- BOT PET -->
        <div class="card pet-card">
          <h2>Bot Pet</h2>

          <div class="pet-top">
            <div class="pet-screen">
              <div class="pet-canvas-wrap">
                <canvas id="pet-canvas" width="64" height="64"></canvas>
              </div>
            </div>

            <div class="pet-info">
              <h3>Mood</h3>
              <div class="pet-mood" id="pet-mood">Chilling üòå</div>
              <p class="pet-sub" id="pet-sub">Watching the market‚Ä¶</p>

              <div class="pet-bars">
                <div class="bar-row">
                  <div>Growth</div>
                  <div class="bar"><span id="pet-growth-bar"></span></div>
                  <div id="pet-growth-text">0%</div>
                </div>
                <div class="bar-row">
                  <div>Hunger</div>
                  <div class="bar hunger"><span id="pet-hunger-bar"></span></div>
                  <div id="pet-hunger-text">0%</div>
                </div>
              </div>

              <div class="pet-actions">
                <button class="btn" id="pet-reset">Reset Pet</button>
              </div>

              <p class="pet-note">
                <b>Wins</b> are food üçó. <b>Losses</b> are an empty plate üçΩÔ∏è.<br />
                The egg hatches when <b>Total PnL goes positive</b> ‚Äî then it never reverts.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Advanced Analytics -->
      <section class="card section-card">
        <div class="card-row" style="margin-bottom: 6px">
          <div>
            <div class="section-title">Advanced Analytics</div>
            <div class="section-subtitle">Deeper stats from your closed trades.</div>
          </div>
        </div>

        <div class="advanced-grid">
          <div>
            <div class="adv-label">Profit Factor</div>
            <div class="adv-value" id="adv-profit-factor">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Avg Win (USD)</div>
            <div class="adv-value" id="adv-avg-win">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Avg Loss (USD)</div>
            <div class="adv-value" id="adv-avg-loss">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Best Trade (USD)</div>
            <div class="adv-value" id="adv-best-trade">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Worst Trade (USD)</div>
            <div class="adv-value" id="adv-worst-trade">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Max Drawdown (USD)</div>
            <div class="adv-value" id="adv-max-dd">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Recovery Factor</div>
            <div class="adv-value" id="adv-recovery-factor">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Sharpe Ratio</div>
            <div class="adv-value" id="adv-sharpe">‚Äî</div>
          </div>
        </div>
      </section>

      <!-- Equity + tables -->
      <section class="section-grid">
        <div>
          <div class="section-title">Equity Curve</div>
          <div class="section-subtitle">Tracks paper-trading balance over time (USD).</div>
          <div class="chart-container">
            <canvas id="equity-chart" class="chart-inner"></canvas>
          </div>
        </div>

        <div>
          <div class="section-card">
            <div class="section-title">Per-Market Performance</div>
            <div class="section-subtitle">How the bot is doing on each market (paper trading).</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Market</th>
                    <th class="text-right">Trades</th>
                    <th class="text-right">Win Rate</th>
                    <th class="text-right">Total PnL</th>
                    <th class="text-right">Avg PnL</th>
                  </tr>
                </thead>
                <tbody id="per-market-body">
                  <tr>
                    <td colspan="5" class="muted">No markets yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">Recent Trades</div>
            <div class="section-subtitle">Showing last 20 closed trades.</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Market</th>
                    <th class="text-right">PnL (USD)</th>
                  </tr>
                </thead>
                <tbody id="recent-trades-body">
                  <tr>
                    <td colspan="3" class="muted">No trades yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- TradingView candlesticks -->
      <section class="section-card">
        <div class="section-title">Market Candlestick Charts</div>
        <div class="section-subtitle">
          Live BTC-USD candlesticks on your main venues. Charts are from TradingView only (they do not place trades).
        </div>

        <div class="card">
          <div class="card-row" style="margin-bottom: 10px">
            <div>Venue</div>
            <div class="tv-tabs">
              <button class="tv-tab active" data-symbol="COINBASE:BTCUSD">Coinbase</button>
              <button class="tv-tab" data-symbol="KUCOIN:BTCUSDT">KuCoin</button>
              <button class="tv-tab" data-symbol="CRYPTOCOM:BTCUSD">Crypto.com</button>
            </div>
          </div>

          <div class="tradingview-widget-container" style="height: 400px">
            <div id="tv-chart"></div>
          </div>

          <div class="section-subtitle" style="margin-top: 10px">
            If a chart fails to load for a venue, adjust the TradingView symbol in the HTML
            (e.g. <span class="muted">COINBASE:BTCUSD, KUCOIN:BTCUSDT, CRYPTOCOM:BTCUSD</span>).
          </div>
        </div>
      </section>

      <div class="footer">
        Bot is running on Render (paper trading only). Keep it training for 2‚Äì3 weeks before making AI changes.
      </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- TradingView widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
      // ------------------------------
      // Utilities
      // ------------------------------
      function $(id) {
        return document.getElementById(id);
      }

      function formatUsd(v) {
        if (v === null || v === undefined || isNaN(v)) return "‚Äî";
        const sign = v < 0 ? "-" : "";
        const abs = Math.abs(v);
        return (
          sign +
          "$" +
          abs.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })
        );
      }

      function formatPercent(v, digits = 1) {
        if (v === null || v === undefined || isNaN(v)) return "‚Äî";
        return v.toFixed(digits).replace(/^-0\.0+$/, "0.0") + "%";
      }

      function formatNumber(v, digits = 2) {
        if (v === null || v === undefined || isNaN(v)) return "‚Äî";
        return v.toFixed(digits);
      }

      function formatTime(iso) {
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return iso ?? "";
        return d.toLocaleString();
      }

      // ------------------------------
      // Equity Chart
      // ------------------------------
      let equityChart = null;

      function updateEquityChart(points) {
        const ctx = $("equity-chart");
        const labels = (points || []).map((p, idx) => {
          const t = p.time_utc ?? p.time ?? p.t ?? null;
          if (!t) return "t+" + idx;
          const d = new Date(t);
          return Number.isNaN(d.getTime()) ? "t+" + idx : d.toLocaleTimeString();
        });

        const data = (points || []).map((p) => p.equity_usd);

        if (equityChart) {
          equityChart.data.labels = labels;
          equityChart.data.datasets[0].data = data;
          equityChart.update();
          return;
        }

        equityChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Equity (USD)",
                data,
                tension: 0.35,
                borderWidth: 2,
                pointRadius: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (c) => "Equity: " + formatUsd(c.parsed.y),
                },
              },
            },
            scales: {
              x: {
                ticks: { maxTicksLimit: 6 },
                grid: { color: "rgba(31,41,55,0.6)" },
              },
              y: {
                ticks: { callback: (v) => "$" + v },
                grid: { color: "rgba(31,41,55,0.6)" },
              },
            },
          },
        });
      }

      // ------------------------------
      // Bot status
      // ------------------------------
      function updateBotStatus(status) {
        const dot = $("bot-status-dot");
        const label = $("bot-status-label");
        const minutesEl = $("bot-status-minutes");
        const lastEl = $("bot-status-last");

        const s = status?.status || "unknown";
        label.textContent = s.charAt(0).toUpperCase() + s.slice(1);
        dot.className = "status-dot status-" + s;

        if (status?.minutes_since != null) {
          minutesEl.textContent = status.minutes_since + " min since heartbeat";
        } else {
          minutesEl.textContent = "";
        }

        if (status?.last_heartbeat || status?.time_utc) {
          const t = status.last_heartbeat ?? status.time_utc;
          lastEl.textContent = "Last heartbeat: " + formatTime(t);
        } else {
          lastEl.textContent = "Waiting for heartbeat‚Ä¶";
        }
      }

      // ------------------------------
      // Per-market + recent trades
      // ------------------------------
      function updatePerMarket(perMarket) {
        const body = $("per-market-body");
        body.innerHTML = "";

        if (!perMarket || perMarket.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5;
          cell.className = "muted";
          cell.textContent = "No markets yet.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        perMarket.forEach((m) => {
          const row = document.createElement("tr");

          const cMarket = document.createElement("td");
          cMarket.textContent = m.market;
          row.appendChild(cMarket);

          const cTrades = document.createElement("td");
          cTrades.className = "text-right";
          cTrades.textContent = m.trades ?? 0;
          row.appendChild(cTrades);

          const cWin = document.createElement("td");
          cWin.className = "text-right";
          cWin.textContent = formatPercent(m.win_rate ?? 0, 1);
          row.appendChild(cWin);

          const total = m.total_pnl_usd ?? m.total_pnl ?? 0;
          const avg = m.avg_pnl_usd ?? m.avg_pnl ?? 0;

          const cTotal = document.createElement("td");
          cTotal.className = "text-right";
          cTotal.textContent = formatUsd(total);
          row.appendChild(cTotal);

          const cAvg = document.createElement("td");
          cAvg.className = "text-right";
          cAvg.textContent = formatUsd(avg);
          row.appendChild(cAvg);

          body.appendChild(row);
        });
      }

      function updateRecentTrades(trades) {
        const body = $("recent-trades-body");
        body.innerHTML = "";

        if (!trades || trades.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.className = "muted";
          cell.textContent = "No trades yet.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        trades.forEach((t) => {
          const row = document.createElement("tr");

          const cTime = document.createElement("td");
          cTime.textContent = formatTime(t.time ?? t.exit_time ?? "");
          row.appendChild(cTime);

          const cMarket = document.createElement("td");
          cMarket.textContent = t.market ?? "‚Äî";
          row.appendChild(cMarket);

          const cPnl = document.createElement("td");
          cPnl.className = "text-right";
          const pnl = t.pnl_usd ?? t.pnl ?? 0;
          cPnl.textContent = formatUsd(pnl);
          row.appendChild(cPnl);

          body.appendChild(row);
        });
      }

      // ------------------------------
      // Advanced metrics
      // ------------------------------
      function updateAdvancedMetrics(adv, maxDD) {
        const a = adv || {};
        $("adv-profit-factor").textContent =
          a.profit_factor == null ? "‚Äî" : formatNumber(a.profit_factor, 2);
        $("adv-avg-win").textContent = formatUsd(a.avg_win_usd ?? 0);
        $("adv-avg-loss").textContent = formatUsd(a.avg_loss_usd ?? 0);
        $("adv-best-trade").textContent = formatUsd(a.best_trade_usd);
        $("adv-worst-trade").textContent = formatUsd(a.worst_trade_usd);
        $("adv-max-dd").textContent = formatUsd(a.max_drawdown_usd ?? maxDD ?? 0);
        $("adv-recovery-factor").textContent =
          a.recovery_factor == null ? "‚Äî" : formatNumber(a.recovery_factor, 2);
        $("adv-sharpe").textContent = a.sharpe_ratio == null ? "‚Äî" : formatNumber(a.sharpe_ratio, 2);
      }

      // ------------------------------
      // TradingView
      // ------------------------------
      const tvContainerId = "tv-chart";
      let currentSymbol = "COINBASE:BTCUSD";
      let tvWidget = null;

      function loadTradingView(symbol) {
        currentSymbol = symbol;
        document.getElementById(tvContainerId).innerHTML = "";
        tvWidget = new TradingView.widget({
          autosize: true,
          symbol,
          interval: "15",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "en",
          enable_publishing: false,
          withdateranges: true,
          allow_symbol_change: false,
          container_id: tvContainerId,
        });
      }

      function setupTvTabs() {
        const tabs = document.querySelectorAll(".tv-tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            loadTradingView(tab.dataset.symbol);
          });
        });
      }

      // ------------------------------
      // BOT PET (Large 64x64 sprite)
      // ------------------------------
      const PET_KEY = "tradepilot_pet_v2";

      const defaultPet = () => ({
        hatched: false,
        animal: null, // 'cat' | 'dog'
        growth: 0,    // 0..100
        hunger: 0,    // 0..100 (higher = hungrier)
        lastWins: 0,
        lastLosses: 0,
        lastTotalPnl: null,
        lastUpdate: Date.now(),
      });

      function loadPet() {
        try {
          const raw = localStorage.getItem(PET_KEY);
          if (!raw) return defaultPet();
          const p = JSON.parse(raw);
          return { ...defaultPet(), ...p };
        } catch {
          return defaultPet();
        }
      }

      function savePet(p) {
        localStorage.setItem(PET_KEY, JSON.stringify(p));
      }

      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      // Pixel art palette (avoid pure black so it doesn't vanish)
      const PAL = {
        T: null,              // transparent
        O: "#f3f4f6",          // outline light
        S: "#cbd5e1",          // shadow outline
        W: "#ffffff",          // white
        G: "#e5e7eb",          // light grey
        D: "#94a3b8",          // darker grey
        Y: "#f59e0b",          // orange (cat)
        Y2:"#fb923c",          // orange light
        B: "#64748b",          // ear/spot grey (dog)
        P: "#fda4af",          // pink (nose/cheek)
        N: "#0f172a",          // deep navy for eyes only (tiny)
        R: "#ef4444",          // red (hungry)
      };

      // Sprites are 64x64 but we define in 32x32 for ease then render scaled 2x in code.
      // This keeps detail crisp while still being bigger.
      // Each sprite has: base frame A and optional frame B (blink / tail wag).
      const SPR = {
        eggA: [
          "................................",
          "................................",
          "................................",
          ".............OOOOOO.............",
          "...........OOOGGGGOOO...........",
          "..........OOGGGGGGGGOO..........",
          ".........OOGGGGGGGGGGOO.........",
          "........OOGGGGDDDDGGGGOO........",
          "........OGGGDDDDDDDDGGGO........",
          ".......OGGGDDDDDDDDDDGGGO.......",
          ".......OGGDDDDDDDDDDDDGGO.......",
          ".......OGGDDDDDDDDDDDDGGO.......",
          ".......OGGDDDDDDDDDDDDGGO.......",
          ".......OGGGDDDDDDDDDDGGGO.......",
          "........OGGGDDDDDDDDGGGO........",
          "........OOGGGDDDDDDGGGOO........",
          ".........OOGGGGDDGGGGOO.........",
          "..........OOGGGGGGGGOO..........",
          "...........OOOGGGGOOO...........",
          ".............OOOOOO.............",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
        ],
        eggB: [
          "................................",
          "................................",
          "................................",
          ".............OOOOOO.............",
          "...........OOOGGGGOOO...........",
          "..........OOGGGGGGGGOO..........",
          ".........OOGGGGGGGGGGOO.........",
          "........OOGGGGDDDDGGGGOO........",
          "........OGGGDDDDDDDDGGGO........",
          ".......OGGGDDDDDDDDDDGGGO.......",
          ".......OGGDDDDDDDDDDDDGGO.......",
          ".......OGGDDDDDDDDDDDDGGO.......",
          ".......OGGDDDDDDDDDDDDGGO.......",
          ".......OGGGDDDDDDDDDDGGGO.......",
          "........OGGGDDDDDDDDGGGO........",
          "........OOGGGDDDDDDGGGOO........",
          ".........OOGGGGDDGGGGOO.........",
          "..........OOGGGGGGGGOO..........",
          "...........OOOGGGGOOO...........",
          ".............OOOOOO.............",
          "...............SS...............",
          "..............SSS...............",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
        ],

        // Ginger Cat (very clearly cat)
        catA: [
          "................................",
          "................................",
          ".............OOOO...............",
          "............OYYYO...............",
          "...........OYYYYO...............",
          "..........OYYYYYOO..............",
          ".........OYYYYYYYYO.............",
          "........OYYYYYOOYYYO............",
          "........OYYYYOOOOYYO............",
          "........OYYYOO..OOYYO...........",
          "........OYYYO....OYYO...........",
          "........OYYYO....OYYO...........",
          "........OYYYOO..OOYYO...........",
          "........OYYYYOOOOYYYO...........",
          ".........OYYYYOOYYYYO............",
          "..........OYYYYYYYYO.............",
          "...........OYYOOYYO..............",
          "............OYYYYO...............",
          ".............OYYO................",
          ".............OYYO................",
          "............OYYYYO...............",
          "...........OYYYYYYO..............",
          "..........OYYY..YYYO.............",
          ".........OYYY....YYYO............",
          ".........OYYY....YYYO............",
          ".........OYYY....YYYO............",
          "..........OYYO..OYYO.............",
          "...........OYYYYYYO..............",
          ".............OOOO................",
          "..............SS.................",
          "................................",
          "................................",
        ],
        // cat blink/tail frame
        catB: [
          "................................",
          "................................",
          ".............OOOO...............",
          "............OYYYO...............",
          "...........OYYYYO...............",
          "..........OYYYYYOO..............",
          ".........OYYYYYYYYO.............",
          "........OYYYYYOOYYYO............",
          "........OYYYYOOOOYYO............",
          "........OYYYO....OYYO...........",
          "........OYYYO....OYYO...........",
          "........OYYYO....OYYO...........",
          "........OYYYO....OYYO...........",
          "........OYYYYOOOOYYYO...........",
          ".........OYYYYOOYYYYO............",
          "..........OYYYYYYYYO.............",
          "...........OYYOOYYO..............",
          "............OYYYYO...............",
          ".............OYYO................",
          ".............OYYO................",
          "............OYYYYO...............",
          "...........OYYYYYYO..............",
          "..........OYYY..YYYO.............",
          ".........OYYY....YYYO............",
          ".........OYYY....YYYO............",
          ".........OYYY....YYYO............",
          "..........OYYO..OYYO.............",
          "...........OYYYYYYO..............",
          "..............OOOO...............",
          "...............SS................",
          "................................",
          "................................",
        ],

        // Dog (beagle-ish: white body, grey ear; very clearly dog)
        dogA: [
          "................................",
          "................................",
          "............OOOOOO..............",
          "...........OWWWWWWO.............",
          "..........OWWWWWWWWOO...........",
          ".........OWWWWBBWWWWO...........",
          "........OWWWWBBBBWWWWO..........",
          "........OWWWWBBBBWWWWO..........",
          "........OWWWWWWWWWWWWO..........",
          "........OWWWNWWWWNWWWWO.........",
          "........OWWWWWWWWWWWWWO.........",
          ".........OWWWWPPWWWWWO..........",
          "..........OWWWWWWWWWO...........",
          "...........OWWWWWWWO............",
          "............OWWWWWO.............",
          ".............OWWWO..............",
          ".............OWWWO..............",
          "............OWWWWWO.............",
          "...........OWWWWWWWO............",
          "..........OWW..WW..WO...........",
          ".........OWW...WW...WO..........",
          ".........OWW...WW...WO..........",
          "..........OWW..WW..WO...........",
          "...........OWWWWWWWO............",
          ".............OOOOOO.............",
          "..............SSS...............",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
        ],
        // dog tail wag / blink
        dogB: [
          "................................",
          "................................",
          "............OOOOOO..............",
          "...........OWWWWWWO.............",
          "..........OWWWWWWWWOO...........",
          ".........OWWWWBBWWWWO...........",
          "........OWWWWBBBBWWWWO..........",
          "........OWWWWBBBBWWWWO..........",
          "........OWWWWWWWWWWWWO..........",
          "........OWWW..WW..WWWO..........",
          "........OWWWWWWWWWWWWWO.........",
          ".........OWWWWPPWWWWWO..........",
          "..........OWWWWWWWWWO...........",
          "...........OWWWWWWWO............",
          "............OWWWWWO.............",
          ".............OWWWO..............",
          ".............OWWWO..............",
          "............OWWWWWO.............",
          "...........OWWWWWWWO............",
          "..........OWW..WW..WO...........",
          ".........OWW...WW...WO..........",
          ".........OWW...WW...WO..........",
          "..........OWW..WW..WO...........",
          "...........OWWWWWWWO............",
          ".............OOOOOO.............",
          ".............SSSS...............",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
        ],

        // Plate icons (simple)
        plateFull: [
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "...........OOOOOOOOOO...........",
          "..........OGGGGGGGGGGO..........",
          ".........OGGGGGGGGGGGGO.........",
          "..........OGGGGGGGGGGO..........",
          "...........OOOOOOOOOO...........",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
        ],
        plateEmpty: [
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "...........OOOOOOOOOO...........",
          "..........ODDDDDDDDDDO..........",
          ".........ODDDDDDDDDDDDO.........",
          "..........ODDDDDDDDDDO..........",
          "...........OOOOOOOOOO...........",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
          "................................",
        ],
      };

      function drawSprite32To64(ctx, sprite32, ox = 0, oy = 0) {
        // scale each 32x32 "pixel" into 2x2 to fill 64x64
        for (let y = 0; y < 32; y++) {
          const row = sprite32[y];
          for (let x = 0; x < 32; x++) {
            const key = row[x];
            const col = PAL[key];
            if (!col) continue;
            ctx.fillStyle = col;
            ctx.fillRect(ox + x * 2, oy + y * 2, 2, 2);
          }
        }
      }

      function clearCanvas(ctx) {
        ctx.clearRect(0, 0, 64, 64);
      }

      function petMoodFrom(pet) {
        // hunger drives mood; growth affects ‚Äúconfidence‚Äù
        if (pet.hunger >= 92) return { mood: "Fainted ‚ò†Ô∏è", sub: "It fainted from hunger ‚Äî needs wins (food) to revive." };
        if (pet.hunger >= 70) return { mood: "Hungry üòø", sub: "Needs wins (food). Losses feel like an empty plate." };
        if (pet.hunger >= 45) return { mood: "Worried üòï", sub: "A couple wins would cheer it up." };
        if (pet.growth >= 85) return { mood: "Chilling üòå", sub: "Watching the market‚Ä¶" };
        return { mood: "Happy üôÇ", sub: "Wins are food. Keep it growing." };
      }

      function updatePetUI(pet) {
        $("pet-mood").textContent = petMoodFrom(pet).mood;
        $("pet-sub").textContent = petMoodFrom(pet).sub;

        const g = clamp(pet.growth, 0, 100);
        const h = clamp(pet.hunger, 0, 100);

        $("pet-growth-bar").style.width = g + "%";
        $("pet-growth-text").textContent = g.toFixed(0) + "%";
        $("pet-hunger-bar").style.width = h + "%";
        $("pet-hunger-text").textContent = h.toFixed(0) + "%";
      }

      // Apply delta from stats changes (wins feed, losses hunger)
      function applyPetFromStats(pet, stats) {
        const wins = stats?.wins ?? 0;
        const losses = stats?.losses ?? 0;
        const totalPnl = stats?.total_pnl_usd ?? 0;

        const dWins = Math.max(0, wins - (pet.lastWins ?? 0));
        const dLoss = Math.max(0, losses - (pet.lastLosses ?? 0));

        // food: reduce hunger, increase growth
        if (dWins > 0) {
          pet.hunger -= dWins * 10;     // each win feeds a lot
          pet.growth += dWins * 7;      // grows steadily
        }

        // empty plate: hunger increases; growth doesn't go down (it just struggles)
        if (dLoss > 0) {
          pet.hunger += dLoss * 12;
          pet.growth += dLoss * 1; // tiny ‚Äúexperience‚Äù growth so it doesn't stagnate
        }

        // idle hunger creeps slowly over time
        const now = Date.now();
        const minutes = Math.max(0, (now - (pet.lastUpdate ?? now)) / 60000);
        pet.hunger += minutes * 0.4;

        // clamp
        pet.hunger = clamp(pet.hunger, 0, 100);
        pet.growth = clamp(pet.growth, 0, 100);

        // hatch rule: once total pnl goes positive (first time) -> hatch random cat/dog
        if (!pet.hatched && totalPnl > 0) {
          pet.hatched = true;
          pet.animal = Math.random() < 0.5 ? "cat" : "dog";
          // little celebration: reduce hunger a bit on hatch
          pet.hunger = clamp(pet.hunger - 15, 0, 100);
          pet.growth = clamp(Math.max(pet.growth, 40), 0, 100);
        }

        pet.lastWins = wins;
        pet.lastLosses = losses;
        pet.lastTotalPnl = totalPnl;
        pet.lastUpdate = now;

        return pet;
      }

      // Pet animation loop
      const petCanvas = $("pet-canvas");
      const petCtx = petCanvas.getContext("2d");
      petCtx.imageSmoothingEnabled = false;

      let pet = loadPet();
      updatePetUI(pet);

      let animT = 0;
      function renderPet() {
        animT += 1;
        clearCanvas(petCtx);

        const isHungry = pet.hunger >= 70;
        const isFainted = pet.hunger >= 92;

        // Choose sprite frame
        let frameToggle = Math.floor(animT / 24) % 2; // ~2fps toggle
        let bob = Math.sin(animT / 18) * 1.5;

        // Plate: full if we just got a win recently, else empty if hungry
        // We'll decide based on hunger threshold
        const plate = isHungry ? SPR.plateEmpty : SPR.plateFull;

        // Draw character
        if (!pet.hatched) {
          // Egg wiggle
          const eggFrame = frameToggle ? SPR.eggB : SPR.eggA;
          const wiggle = Math.sin(animT / 10) * 2;
          drawSprite32To64(petCtx, eggFrame, Math.round(wiggle), Math.round(bob));
        } else {
          const animal = pet.animal || "cat";
          if (animal === "cat") {
            const sprite = frameToggle ? SPR.catB : SPR.catA;
            drawSprite32To64(petCtx, sprite, 0, Math.round(bob));
          } else {
            const sprite = frameToggle ? SPR.dogB : SPR.dogA;
            drawSprite32To64(petCtx, sprite, 0, Math.round(bob));
          }
        }

        // Draw plate at bottom always (like tamagotchi)
        drawSprite32To64(petCtx, plate, 0, 0);

        // If fainted, overlay subtle X eyes (still readable)
        if (isFainted) {
          petCtx.fillStyle = "rgba(239,68,68,0.35)";
          petCtx.fillRect(0, 0, 64, 64);
        }

        requestAnimationFrame(renderPet);
      }
      requestAnimationFrame(renderPet);

      $("pet-reset").addEventListener("click", () => {
        pet = defaultPet();
        savePet(pet);
        updatePetUI(pet);
      });

      // ------------------------------
      // Fetch + hydrate dashboard
      // ------------------------------
      async function refreshDashboard() {
        try {
          const res = await fetch("/data", { cache: "no-store" });
          const data = await res.json();

          // Top metrics (support both old/new key names)
          const totalTrades = data.total_trades ?? data.totalTrades ?? 0;
          $("metric-total-trades").textContent = totalTrades;
          $("metric-wins").textContent = (data.wins ?? 0) + " wins";
          $("metric-losses").textContent = (data.losses ?? 0) + " losses";

          const winRate = data.win_rate != null ? data.win_rate : 0;
          $("metric-win-rate").textContent = formatPercent(winRate, 1);

          const avgPnl = data.avg_pnl_usd ?? 0;
          $("metric-avg-pnl").textContent = formatUsd(avgPnl);

          const totalPnl = data.total_pnl_usd ?? 0;
          const pnlEl = $("metric-total-pnl");
          pnlEl.textContent = formatUsd(totalPnl);
          pnlEl.classList.remove("positive", "negative");
          pnlEl.classList.add(totalPnl >= 0 ? "positive" : "negative");

          // Equity
          updateEquityChart(data.equity_curve || []);

          // Bot status
          updateBotStatus(data.bot_status);

          // Per-market & trades
          updatePerMarket(data.per_market || []);
          updateRecentTrades(data.recent_trades || []);

          // Advanced
          updateAdvancedMetrics(data.advanced_metrics, data.max_drawdown_usd);

          // Pet update from stats (safe + persistent)
          pet = applyPetFromStats(pet, {
            wins: data.wins ?? 0,
            losses: data.losses ?? 0,
            total_pnl_usd: totalPnl,
          });
          savePet(pet);
          updatePetUI(pet);
        } catch (err) {
          console.error("Failed to refresh dashboard", err);
        }
      }

      // ------------------------------
      // Init
      // ------------------------------
      document.addEventListener("DOMContentLoaded", () => {
        setupTvTabs();
        loadTradingView(currentSymbol);
        refreshDashboard();
        setInterval(refreshDashboard, 10_000);
      });
    </script>
  </body>
                  </html>
