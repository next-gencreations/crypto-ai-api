<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crypto AI Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #050814;
        --bg-card: #101522;
        --bg-card-soft: #141b2c;
        --text-main: #f8f4fc;
        --text-muted: #9ca3af;
        --accent: #22c55e;
        --accent-red: #ef4444;
        --accent-blue: #3b82f6;
        --border-soft: #1f2937;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text-main);
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header { margin-bottom: 24px; }

      h1 {
        margin: 0 0 4px;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      header p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted);
      }

      header a {
        color: #38bdf8;
        text-decoration: none;
        margin-left: 4px;
        margin-right: 4px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .card {
        background: linear-gradient(145deg, var(--bg-card), #060b17);
        border-radius: 14px;
        padding: 14px 16px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      }

      .card h2 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .metric-main {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .metric-sub {
        font-size: 12px;
        color: var(--text-muted);
      }

      .metric-main.positive { color: var(--accent); }
      .metric-main.negative { color: var(--accent-red); }

      .card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.8);
      }

      .status-dot { width: 7px; height: 7px; border-radius: 50%; }
      .status-running { background-color: #22c55e; }
      .status-idle { background-color: #eab308; }
      .status-stopped { background-color: #ef4444; }
      .status-unknown { background-color: #6b7280; }

      .section-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }

      .section-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin: 0 0 12px;
      }

      .section-card { margin-bottom: 24px; }

      .chart-container {
        height: 260px;
        background: radial-gradient(circle at top, #020617, #020617);
        border-radius: 14px;
        border: 1px solid var(--border-soft);
        overflow: hidden;
      }

      .chart-inner { width: 100%; height: 100%; }

      table { width: 100%; border-collapse: collapse; font-size: 12px; }
      thead { background: rgba(15, 23, 42, 0.9); }

      th, td { padding: 8px 10px; text-align: left; }

      th {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-bottom: 1px solid var(--border-soft);
      }

      tbody tr:nth-child(odd) { background: rgba(15, 23, 42, 0.4); }
      tbody tr:nth-child(even) { background: rgba(15, 23, 42, 0.1); }
      tbody tr:hover { background: rgba(55, 65, 81, 0.4); }

      .text-right { text-align: right; }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        background: rgba(15, 23, 42, 0.9);
      }
      .pill.positive { color: var(--accent); }
      .pill.negative { color: var(--accent-red); }

      .muted { color: var(--text-muted); }

      .section-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
        gap: 16px;
      }

      @media (max-width: 900px) {
        .section-grid { grid-template-columns: minmax(0, 1fr); }
      }

      .advanced-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px 14px;
        margin-top: 6px;
      }

      .adv-label { font-size: 11px; color: var(--text-muted); }
      .adv-value { font-size: 14px; font-weight: 600; }

      .tv-tabs {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        padding: 2px;
        margin-bottom: 8px;
      }

      .tv-tab {
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        cursor: pointer;
      }

      .tv-tab.active { background: #0f172a; color: var(--text-main); }

      .footer {
        margin-top: 18px;
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
      }

      /* ----------------------------
         BOT PET UI
      ---------------------------- */
      .pet-wrap {
        display: grid;
        grid-template-columns: 76px 1fr;
        gap: 12px;
        align-items: center;
      }

      .pet-screen {
        width: 72px;
        height: 72px;
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        background:
          radial-gradient(circle at 20% 20%, rgba(59,130,246,0.18), transparent 55%),
          radial-gradient(circle at 80% 60%, rgba(34,197,94,0.16), transparent 55%),
          linear-gradient(180deg, rgba(15,23,42,0.85), rgba(2,6,23,0.92));
        display: grid;
        place-items: center;
        position: relative;
        overflow: hidden;
      }

      .pet-screen::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255,255,255,0.08), transparent 45%);
        pointer-events: none;
      }

      canvas#pet-canvas {
        image-rendering: pixelated;
        width: 56px;
        height: 56px;
      }

      .pet-meta .pet-title {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }

      .pet-meta .pet-title b {
        font-size: 14px;
        letter-spacing: 0.02em;
      }

      .pet-meta .pet-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

      .pet-bars { margin-top: 10px; display: grid; gap: 8px; }

      .bar-row { display: grid; grid-template-columns: 70px 1fr 44px; gap: 8px; align-items: center; }
      .bar-row span { font-size: 11px; color: var(--text-muted); }

      .bar {
        height: 10px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 999px;
        overflow: hidden;
      }

      .bar > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(34,197,94,0.95), rgba(59,130,246,0.85));
      }

      .bar.danger > i {
        background: linear-gradient(90deg, rgba(239,68,68,0.95), rgba(245,158,11,0.85));
      }

      .pet-actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }

      .btn {
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(15, 23, 42, 0.8);
        color: var(--text-main);
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 999px;
        cursor: pointer;
      }
      .btn:hover { border-color: rgba(148, 163, 184, 0.32); }

      .pet-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(15,23,42,0.8);
        color: var(--text-muted);
        border: 1px solid rgba(148, 163, 184, 0.12);
      }

      .shake {
        animation: shake 300ms ease-in-out infinite;
      }
      @keyframes shake {
        0% { transform: translate(0,0) rotate(0deg); }
        25% { transform: translate(1px,-1px) rotate(-1deg); }
        50% { transform: translate(-1px,1px) rotate(1deg); }
        75% { transform: translate(1px,1px) rotate(0deg); }
        100% { transform: translate(0,0) rotate(0deg); }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header>
        <h1>Crypto AI Bot Dashboard</h1>
        <p>
          Paper-trading stats from Render ‚Äî
          <a href="/data" target="_blank">raw stats</a>
        </p>
      </header>

      <!-- Top KPIs -->
      <section class="cards">
        <div class="card">
          <h2>Total Trades</h2>
          <div class="metric-main" id="metric-total-trades">0</div>
          <div class="metric-sub">
            <span id="metric-wins">0 wins</span> /
            <span id="metric-losses">0 losses</span>
          </div>
        </div>

        <div class="card">
          <h2>Win Rate</h2>
          <div class="metric-main" id="metric-win-rate">0%</div>
          <div class="metric-sub">
            Avg <span id="metric-avg-pnl">-$0.00</span> per trade
          </div>
        </div>

        <div class="card">
          <h2>PNL (Total)</h2>
          <div class="metric-main negative" id="metric-total-pnl">$0.00</div>
          <div class="metric-sub">Based on closed trades only.</div>
        </div>

        <div class="card">
          <h2>Bot Status</h2>
          <div class="card-row" style="margin-bottom: 6px">
            <div class="status-pill" id="bot-status-pill">
              <span class="status-dot status-unknown" id="bot-status-dot"></span>
              <span id="bot-status-label">Unknown</span>
            </div>
            <span class="muted" id="bot-status-minutes"></span>
          </div>
          <div class="metric-sub" id="bot-status-last">Waiting for heartbeat‚Ä¶</div>
        </div>

        <!-- BOT PET CARD -->
        <div class="card">
          <h2>Bot Pet</h2>
          <div class="pet-wrap">
            <div class="pet-screen" id="pet-screen">
              <canvas id="pet-canvas" width="32" height="32"></canvas>
            </div>

            <div class="pet-meta">
              <div class="pet-title">
                <div>
                  <div class="muted" style="font-size: 11px; letter-spacing: 0.14em; text-transform: uppercase;">
                    Mood
                  </div>
                  <b id="pet-mood">Watching‚Ä¶</b>
                </div>
                <span class="pet-badge" id="pet-stage">Egg</span>
              </div>

              <div class="pet-sub" id="pet-subtext">Wins are food üçó. Losses are empty plates üçΩÔ∏è.</div>

              <div class="pet-bars">
                <div class="bar-row">
                  <span>Growth</span>
                  <div class="bar"><i id="pet-xp-bar"></i></div>
                  <span class="muted" id="pet-xp-text">0%</span>
                </div>
                <div class="bar-row">
                  <span>Hunger</span>
                  <div class="bar danger"><i id="pet-hunger-bar"></i></div>
                  <span class="muted" id="pet-hunger-text">0%</span>
                </div>
              </div>

              <div class="pet-actions">
                <button class="btn" id="pet-reset-btn">Reset Pet</button>
                <span class="muted" style="font-size:11px" id="pet-debug"></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Advanced Analytics -->
      <section class="card section-card">
        <div class="card-row" style="margin-bottom: 6px">
          <div>
            <div class="section-title">Advanced Analytics</div>
            <div class="section-subtitle">Deeper stats from your closed trades.</div>
          </div>
        </div>

        <div class="advanced-grid">
          <div>
            <div class="adv-label">Profit Factor</div>
            <div class="adv-value" id="adv-profit-factor">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Avg Win (USD)</div>
            <div class="adv-value" id="adv-avg-win">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Avg Loss (USD)</div>
            <div class="adv-value" id="adv-avg-loss">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Best Trade (USD)</div>
            <div class="adv-value" id="adv-best-trade">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Worst Trade (USD)</div>
            <div class="adv-value" id="adv-worst-trade">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Max Drawdown (USD)</div>
            <div class="adv-value" id="adv-max-dd">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Recovery Factor</div>
            <div class="adv-value" id="adv-recovery-factor">‚Äî</div>
          </div>
          <div>
            <div class="adv-label">Sharpe Ratio</div>
            <div class="adv-value" id="adv-sharpe">‚Äî</div>
          </div>
        </div>
      </section>

      <!-- Equity + tables -->
      <section class="section-grid">
        <div>
          <div class="section-title">Equity Curve</div>
          <div class="section-subtitle">Tracks paper-trading balance over time (USD).</div>
          <div class="chart-container">
            <canvas id="equity-chart" class="chart-inner"></canvas>
          </div>
        </div>

        <div>
          <div class="section-card">
            <div class="section-title">Per-Market Performance</div>
            <div class="section-subtitle">How the bot is doing on each market (paper trading).</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Market</th>
                    <th class="text-right">Trades</th>
                    <th class="text-right">Win Rate</th>
                    <th class="text-right">Total PnL</th>
                    <th class="text-right">Avg PnL</th>
                  </tr>
                </thead>
                <tbody id="per-market-body">
                  <tr>
                    <td colspan="5" class="muted">No markets yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">Recent Trades</div>
            <div class="section-subtitle">Showing last 20 closed trades.</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Market</th>
                    <th class="text-right">PnL (USD)</th>
                  </tr>
                </thead>
                <tbody id="recent-trades-body">
                  <tr>
                    <td colspan="3" class="muted">No trades yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- TradingView candlesticks -->
      <section class="section-card">
        <div class="section-title">Market Candlestick Charts</div>
        <div class="section-subtitle">
          Live BTC-USD candlesticks on your main venues. Charts are from TradingView only (they do not place trades).
        </div>

        <div class="card">
          <div class="card-row" style="margin-bottom: 10px">
            <div>Venue</div>
            <div class="tv-tabs">
              <button class="tv-tab active" data-symbol="COINBASE:BTCUSD">Coinbase</button>
              <button class="tv-tab" data-symbol="KUCOIN:BTCUSDT">KuCoin</button>
              <button class="tv-tab" data-symbol="CRYPTOCOM:BTCUSD">Crypto.com</button>
            </div>
          </div>

          <div class="tradingview-widget-container" style="height: 400px">
            <div id="tv-chart"></div>
          </div>

          <div class="section-subtitle" style="margin-top: 10px">
            If a chart fails to load for a venue, adjust the TradingView symbol in the HTML
            (e.g. <span class="muted">COINBASE:BTCUSD, KUCOIN:BTCUSDT, CRYPTOCOM:BTCUSD</span>).
          </div>
        </div>
      </section>

      <div class="footer">
        Bot is running on Render (paper trading only). Keep it training for 2‚Äì3 weeks before making AI changes.
      </div>
    </div>

    <!-- Chart.js for equity curve -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- TradingView widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
      // ------------------------------
      // Utilities
      // ------------------------------
      function $(id) { return document.getElementById(id); }

      function formatUsd(v) {
        if (v === null || v === undefined || isNaN(v)) return "‚Äî";
        const sign = v < 0 ? "-" : "";
        const abs = Math.abs(v);
        return sign + "$" + abs.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function formatPercent(v, digits = 1) {
        if (v === null || v === undefined || isNaN(v)) return "‚Äî";
        return v.toFixed(digits).replace(/^-0\.0+$/, "0.0") + "%";
      }

      function formatNumber(v, digits = 2) {
        if (v === null || v === undefined || isNaN(v)) return "‚Äî";
        return v.toFixed(digits);
      }

      function formatTime(iso) {
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return iso;
        return d.toLocaleString();
      }

      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

      // ------------------------------
      // Equity Chart
      // ------------------------------
      let equityChart = null;

      function updateEquityChart(points) {
        const ctx = $("equity-chart");

        // FIX: backend returns { time_utc, equity_usd }
        const labels = points.map((p) => {
          const t = p.time_utc || p.time || p.timeUtc || p.timeUTC || "";
          const d = new Date(t);
          return Number.isNaN(d.getTime()) ? "" : d.toLocaleTimeString();
        });

        const data = points.map((p) => p.equity_usd);

        if (equityChart) {
          equityChart.data.labels = labels;
          equityChart.data.datasets[0].data = data;
          equityChart.update();
          return;
        }

        equityChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Equity (USD)",
                data,
                tension: 0.35,
                borderWidth: 2,
                pointRadius: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => "Equity: " + formatUsd(ctx.parsed.y),
                },
              },
            },
            scales: {
              x: {
                ticks: { maxTicksLimit: 6 },
                grid: { color: "rgba(31,41,55,0.6)" },
              },
              y: {
                ticks: { callback: (v) => "$" + v },
                grid: { color: "rgba(31,41,55,0.6)" },
              },
            },
          },
        });
      }

      // ------------------------------
      // Bot status
      // ------------------------------
      function updateBotStatus(status) {
        const dot = $("bot-status-dot");
        const label = $("bot-status-label");
        const minutesEl = $("bot-status-minutes");
        const lastEl = $("bot-status-last");

        const s = status?.status || "unknown";
        label.textContent = s.charAt(0).toUpperCase() + s.slice(1);
        dot.className = "status-dot status-" + s;

        // If you later add minutes_since in backend, this will show it:
        if (status?.minutes_since != null) {
          minutesEl.textContent = status.minutes_since + " min since heartbeat";
        } else {
          minutesEl.textContent = "";
        }

        if (status?.last_heartbeat) {
          lastEl.textContent = "Last heartbeat: " + formatTime(status.last_heartbeat);
        } else {
          lastEl.textContent = "Heartbeat file not found yet.";
        }
      }

      // ------------------------------
      // Advanced metrics
      // ------------------------------
      function updateAdvancedMetrics(adv, maxDdFromRoot) {
        const a = adv || {};
        $("adv-profit-factor").textContent = a.profit_factor == null ? "‚Äî" : formatNumber(a.profit_factor, 2);
        $("adv-avg-win").textContent = a.avg_win_usd == null ? "‚Äî" : formatUsd(a.avg_win_usd);
        $("adv-avg-loss").textContent = a.avg_loss_usd == null ? "‚Äî" : formatUsd(a.avg_loss_usd);
        $("adv-best-trade").textContent = a.best_trade_usd == null ? "‚Äî" : formatUsd(a.best_trade_usd);
        $("adv-worst-trade").textContent = a.worst_trade_usd == null ? "‚Äî" : formatUsd(a.worst_trade_usd);

        const maxdd = (a.max_drawdown_usd != null) ? a.max_drawdown_usd : maxDdFromRoot;
        $("adv-max-dd").textContent = maxdd == null ? "‚Äî" : formatUsd(maxdd);

        $("adv-recovery-factor").textContent = a.recovery_factor == null ? "‚Äî" : formatNumber(a.recovery_factor, 2);
        $("adv-sharpe").textContent = a.sharpe_ratio == null ? "‚Äî" : formatNumber(a.sharpe_ratio, 2);
      }

      // ------------------------------
      // Per-market + recent trades
      // ------------------------------
      function updatePerMarket(perMarket) {
        const body = $("per-market-body");
        body.innerHTML = "";

        if (!perMarket || perMarket.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5;
          cell.className = "muted";
          cell.textContent = "No markets yet.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        perMarket.forEach((m) => {
          const row = document.createElement("tr");

          const cMarket = document.createElement("td");
          cMarket.textContent = m.market;
          row.appendChild(cMarket);

          const cTrades = document.createElement("td");
          cTrades.className = "text-right";
          cTrades.textContent = m.trades;
          row.appendChild(cTrades);

          const cWin = document.createElement("td");
          cWin.className = "text-right";
          cWin.textContent = formatPercent(m.win_rate, 1);
          row.appendChild(cWin);

          // backend uses total_pnl, avg_pnl
          const cTotal = document.createElement("td");
          cTotal.className = "text-right";
          cTotal.textContent = formatUsd(m.total_pnl);
          row.appendChild(cTotal);

          const cAvg = document.createElement("td");
          cAvg.className = "text-right";
          cAvg.textContent = formatUsd(m.avg_pnl);
          row.appendChild(cAvg);

          body.appendChild(row);
        });
      }

      function updateRecentTrades(trades) {
        const body = $("recent-trades-body");
        body.innerHTML = "";

        if (!trades || trades.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.className = "muted";
          cell.textContent = "No trades yet.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        trades.forEach((t) => {
          const row = document.createElement("tr");

          const cTime = document.createElement("td");
          cTime.textContent = t.time ? formatTime(t.time) : "‚Äî";
          row.appendChild(cTime);

          const cMarket = document.createElement("td");
          cMarket.textContent = t.market || "‚Äî";
          row.appendChild(cMarket);

          const cPnl = document.createElement("td");
          cPnl.className = "text-right";
          const v = Number(t.pnl_usd);
          cPnl.innerHTML = `<span class="pill ${v >= 0 ? "positive" : "negative"}">${formatUsd(v)}</span>`;
          row.appendChild(cPnl);

          body.appendChild(row);
        });
      }

      // ------------------------------
      // TradingView
      // ------------------------------
      let currentSymbol = "COINBASE:BTCUSD";
      function loadTradingView(symbol) {
        currentSymbol = symbol;
        const container = document.getElementById("tv-chart");
        container.innerHTML = "";
        new TradingView.widget({
          autosize: true,
          symbol: symbol,
          interval: "15",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "en",
          enable_publishing: false,
          withdateranges: true,
          allow_symbol_change: false,
          container_id: "tv-chart",
        });
      }
      function setupTvTabs() {
        const tabs = document.querySelectorAll(".tv-tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            loadTradingView(tab.dataset.symbol);
          });
        });
      }

      // ==========================================================
      // BOT PET (FULL HOG)
      // ==========================================================
      const PET_KEY = "botpet_v1";

      const DEFAULT_PET = {
        hatched: false,
        species: null,          // "cat" or "dog"
        stage: "egg",           // "egg" | "baby" | "teen" | "adult"
        xp: 0,                  // grows on wins
        hunger: 35,             // grows on losses / time
        mood: "watching",
        lastTotalTrades: 0,
        lastWins: 0,
        lastLosses: 0,
        lastTotalPnl: 0,
        lastEquity: null,
        lastEventAt: Date.now(),
        anim: { mode: "idle", until: 0 },
      };

      // --- tune these if you want ---
      const HATCH_PNL_THRESHOLD = 0.01;     // hatch when total_pnl_usd > 0
      const WIPEOUT_EQUITY_THRESHOLD = 850; // auto-reset pet if equity drops under this
      const HUNGER_TIME_RATE = 1;           // hunger increases slowly over time
      const TICK_MS = 200;                  // frame speed

      function loadPet() {
        try {
          const raw = localStorage.getItem(PET_KEY);
          if (!raw) return structuredClone(DEFAULT_PET);
          const parsed = JSON.parse(raw);
          return { ...structuredClone(DEFAULT_PET), ...parsed, anim: { ...DEFAULT_PET.anim, ...(parsed.anim||{}) } };
        } catch {
          return structuredClone(DEFAULT_PET);
        }
      }

      function savePet(pet) {
        localStorage.setItem(PET_KEY, JSON.stringify(pet));
      }

      function resetPet(hard=false) {
        const p = structuredClone(DEFAULT_PET);
        if (!hard) {
          // keep last counters so it doesn't re-trigger deltas oddly
          const old = loadPet();
          p.lastTotalTrades = old.lastTotalTrades || 0;
          p.lastWins = old.lastWins || 0;
          p.lastLosses = old.lastLosses || 0;
          p.lastTotalPnl = old.lastTotalPnl || 0;
          p.lastEquity = old.lastEquity || null;
        }
        savePet(p);
        return p;
      }

      // ------------------------------
      // Pixel sprites (simple but lively)
      // Each frame is 16x16, scaled up
      // " " empty, "." shadow, "#" outline, "W" white, "G" grey, "P" pink, "Y" yellow, "B" blue, "R" red, "O" orange
      // ------------------------------
      const PALETTE = {
        " ": null,
        ".": "rgba(0,0,0,0.25)",
        "#": "#0b1220",
        "W": "#e6edf7",
        "G": "#94a3b8",
        "P": "#fb7185",
        "Y": "#fbbf24",
        "B": "#60a5fa",
        "R": "#ef4444",
        "O": "#f97316",
      };

      function drawFrame(ctx, frame, ox=0, oy=0, scale=2) {
        const h = frame.length;
        const w = frame[0].length;
        for (let y=0; y<h; y++) {
          for (let x=0; x<w; x++) {
            const ch = frame[y][x];
            const col = PALETTE[ch];
            if (!col) continue;
            ctx.fillStyle = col;
            ctx.fillRect(ox + x*scale, oy + y*scale, scale, scale);
          }
        }
      }

      // 16x16 frames
      const FRAMES = {
        egg_idle: [
          "      ####      ",
          "    ##GGGG##    ",
          "   #GGWWWWGG#   ",
          "  #GGWGGGGWGG#  ",
          "  #GGWGGGGWGG#  ",
          "  #GGWWWWWWGG#  ",
          "  #GGGGGGGGGG#  ",
          "   #GGGGGGGG#   ",
          "    ##GGGG##    ",
          "      ####      ",
          "                ",
          "     .......    ",
          "    .........   ",
          "                ",
          "                ",
          "                ",
        ],
        egg_shake: [
          "     ####       ",
          "   ##GGGG##     ",
          "  #GGWWWWGG#    ",
          " #GGWGGGGWGG#   ",
          " #GGWGGGGWGG#   ",
          " #GGWWWWWWGG#   ",
          " #GGGGGGGGGG#   ",
          "  #GGGGGGGG#    ",
          "   ##GGGG##     ",
          "     ####       ",
          "                ",
          "     .......    ",
          "    .........   ",
          "                ",
          "                ",
          "                ",
        ],
        crack: [
          "      ####      ",
          "    ##GGGG##    ",
          "   #GGWWWWGG#   ",
          "  #GGWGG#GWGG#  ",
          "  #GGWGG#GWGG#  ",
          "  #GGWWW#WWGG#  ",
          "  #GGGG#GGGGG#  ",
          "   #GG#GGGGG#   ",
          "    ##GGGG##    ",
          "      ####      ",
          "                ",
          "     .......    ",
          "    .........   ",
          "                ",
          "                ",
          "                ",
        ],

        // CAT BABY
        cat_idle1: [
          "                ",
          "     ##  ##     ",
          "    #WW##WW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "      ####      ",
          "     ##..##     ",
          "    #..##..#    ",
          "    #..##..#    ",
          "     ######     ",
          "      ....      ",
          "                ",
          "                ",
          "                ",
        ],
        cat_idle2: [
          "                ",
          "     ##  ##     ",
          "    #WW##WW#    ",
          "    #WGGGGW#    ",
          "    #WGP PGW#   ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "      ####      ",
          "     ##..##     ",
          "    #..##..#    ",
          "    #..##..#    ",
          "     ######     ",
          "      .. ..     ",
          "                ",
          "                ",
          "                ",
        ],
        cat_walk1: [
          "                ",
          "     ##  ##     ",
          "    #WW##WW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "      ####      ",
          "    ###..##     ",
          "   #..##..#     ",
          "    #..##..#    ",
          "     ######     ",
          "       ....     ",
          "                ",
          "                ",
          "                ",
        ],
        cat_walk2: [
          "                ",
          "     ##  ##     ",
          "    #WW##WW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "      ####      ",
          "     ##..###    ",
          "     #..##..#   ",
          "    #..##..#    ",
          "     ######     ",
          "     ....       ",
          "                ",
          "                ",
          "                ",
        ],
        cat_eat1: [
          "                ",
          "     ##  ##     ",
          "    #WW##WW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "      ####      ",
          "     ##..##     ",
          "    #..##..#    ",
          "    #..##..#    ",
          "     ######     ",
          "   ....YY....   ",
          "      ....      ",
          "                ",
          "                ",
        ],
        cat_eat2: [
          "                ",
          "     ##  ##     ",
          "    #WW##WW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "      ####      ",
          "     ##..##     ",
          "    #..##..#    ",
          "    #..##..#    ",
          "     ######     ",
          "   ...YY..YY..  ",
          "      ....      ",
          "                ",
          "                ",
        ],
        cat_sad1: [
          "                ",
          "     ##  ##     ",
          "    #WW##WW#    ",
          "    #WGGGGW#    ",
          "    #WGRRGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "      ####      ",
          "     ##..##     ",
          "    #..##..#    ",
          "    #..##..#    ",
          "     ######     ",
          "   .........    ",
          "    ..RRR..     ",
          "                ",
          "                ",
        ],
        cat_sad2: [
          "                ",
          "     ##  ##     ",
          "    #WW##WW#    ",
          "    #WGGGGW#    ",
          "    #WGRRGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "      ####      ",
          "     ##..##     ",
          "    #..##..#    ",
          "    #..##..#    ",
          "     ######     ",
          "   .........    ",
          "     ..RRR..    ",
          "                ",
          "                ",
        ],

        // DOG BABY
        dog_idle1: [
          "                ",
          "     ######     ",
          "    #WWGGWW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "    ## ######   ",
          "   #..##..##.#  ",
          "   #..##..##.#  ",
          "    #########   ",
          "      ....      ",
          "                ",
          "                ",
          "                ",
          "                ",
        ],
        dog_idle2: [
          "                ",
          "     ######     ",
          "    #WWGGWW#    ",
          "    #WGGGGW#    ",
          "    #WGP PGW#   ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "   ### ######   ",
          "  #..##..##..#  ",
          "  #..##..##..#  ",
          "   ##########   ",
          "      .. ..     ",
          "                ",
          "                ",
          "                ",
          "                ",
        ],
        dog_walk1: [
          "                ",
          "     ######     ",
          "    #WWGGWW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "   ### ######   ",
          "  #..##..##..#  ",
          "   #..##..##..# ",
          "    ##########  ",
          "        ....    ",
          "                ",
          "                ",
          "                ",
          "                ",
        ],
        dog_walk2: [
          "                ",
          "     ######     ",
          "    #WWGGWW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "    ## ######   ",
          "   #..##..##..# ",
          "  #..##..##..#  ",
          "   ##########   ",
          "    ....        ",
          "                ",
          "                ",
          "                ",
          "                ",
        ],
        dog_eat1: [
          "                ",
          "     ######     ",
          "    #WWGGWW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "    ## ######   ",
          "   #..##..##..# ",
          "   #..##..##..# ",
          "    ##########  ",
          "      ....      ",
          "   ....YY....   ",
          "                ",
          "                ",
          "                ",
        ],
        dog_eat2: [
          "                ",
          "     ######     ",
          "    #WWGGWW#    ",
          "    #WGGGGW#    ",
          "    #WGPPGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "   ### ######   ",
          "  #..##..##..#  ",
          "  #..##..##..#  ",
          "   ##########   ",
          "      ....      ",
          "   ..YY..YY..   ",
          "                ",
          "                ",
          "                ",
        ],
        dog_sad1: [
          "                ",
          "     ######     ",
          "    #WWGGWW#    ",
          "    #WGGGGW#    ",
          "    #WGRRGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "    ## ######   ",
          "   #..##..##..# ",
          "   #..##..##..# ",
          "    ##########  ",
          "      ....      ",
          "   .........    ",
          "    ..RRR..     ",
          "                ",
          "                ",
        ],
        dog_sad2: [
          "                ",
          "     ######     ",
          "    #WWGGWW#    ",
          "    #WGGGGW#    ",
          "    #WGRRGW#    ",
          "    #WGGGGW#    ",
          "     #WWWW#     ",
          "   ### ######   ",
          "  #..##..##..#  ",
          "  #..##..##..#  ",
          "   ##########   ",
          "      ....      ",
          "   .........    ",
          "     ..RRR..    ",
          "                ",
          "                ",
        ],
      };

      // Growth stages are cosmetic overlays on badge + behaviour
      function stageFromXp(xp) {
        if (xp < 20) return "baby";
        if (xp < 55) return "teen";
        return "adult";
      }

      function xpPercentWithinStage(xp) {
        // 0-20 baby, 20-55 teen, 55-100 adult
        const cap = 100;
        const clamped = clamp(xp, 0, cap);
        return Math.round((clamped / cap) * 100);
      }

      function hungerPercent(h) {
        return Math.round(clamp(h, 0, 100));
      }

      function setAnim(pet, mode, durationMs) {
        pet.anim = { mode, until: Date.now() + durationMs };
      }

      function currentAnimMode(pet) {
        if (!pet.anim) return "idle";
        if (Date.now() > (pet.anim.until || 0)) return "idle";
        return pet.anim.mode || "idle";
      }

      function decideMood(pet) {
        if (!pet.hatched) return "Hatching‚Ä¶ ü•ö";
        const h = pet.hunger;
        if (h >= 80) return "Starving üòø";
        if (h >= 60) return "Hungry üêæ";
        if (pet.mood === "sad") return "Sad üò¢";
        return "Happy üòä";
      }

      function badgeText(pet) {
        if (!pet.hatched) return "Egg";
        const s = pet.stage || "baby";
        const sp = pet.species === "cat" ? "Cat" : "Dog";
        if (s === "baby") return "Baby " + sp;
        if (s === "teen") return "Teen " + sp;
        return "Adult " + sp;
      }

      function pickSpeciesRandom() {
        return Math.random() < 0.5 ? "cat" : "dog";
      }

      function maybeHatch(pet, totalPnlUsd) {
        if (pet.hatched) return false;
        if (totalPnlUsd > HATCH_PNL_THRESHOLD) {
          pet.hatched = true;
          pet.species = pickSpeciesRandom();     // RANDOM CAT/DOG
          pet.stage = "baby";
          pet.xp = Math.max(pet.xp, 1);
          pet.hunger = clamp(pet.hunger, 0, 70);
          setAnim(pet, "hatch", 2200);
          return true;
        }
        return false;
      }

      function applyTimeHunger(pet) {
        const now = Date.now();
        const dt = Math.max(0, now - (pet.lastEventAt || now));
        // roughly +HUNGER_TIME_RATE per hour (light drift)
        const perHour = HUNGER_TIME_RATE;
        const add = (dt / (60*60*1000)) * perHour;
        pet.hunger = clamp(pet.hunger + add, 0, 100);
        pet.lastEventAt = now;
      }

      // Detect new trades and react:
      function processTradeDeltas(pet, data) {
        const totalTrades = data.total_trades ?? 0;
        const wins = data.wins ?? 0;
        const losses = data.losses ?? 0;

        const dTrades = totalTrades - (pet.lastTotalTrades ?? 0);
        const dWins = wins - (pet.lastWins ?? 0);
        const dLosses = losses - (pet.lastLosses ?? 0);

        pet.lastTotalTrades = totalTrades;
        pet.lastWins = wins;
        pet.lastLosses = losses;

        if (dTrades <= 0) return { dTrades:0, dWins:0, dLosses:0 };

        // Wins feed:
        if (dWins > 0) {
          pet.xp = clamp(pet.xp + (dWins * 4), 0, 100);
          pet.hunger = clamp(pet.hunger - (dWins * 10), 0, 100);
          pet.mood = "happy";
          setAnim(pet, "eat", 1400);
        }

        // Losses hurt:
        if (dLosses > 0) {
          pet.hunger = clamp(pet.hunger + (dLosses * 12), 0, 100);
          pet.mood = "sad";
          setAnim(pet, "sad", 1400);
        }

        // Stage update only if hatched
        if (pet.hatched) {
          pet.stage = stageFromXp(pet.xp);
        }

        return { dTrades, dWins, dLosses };
      }

      function maybeWipeoutReset(pet, lastEquity) {
        if (lastEquity == null) return false;
        // Only wipeout-reset once hatched (feels more meaningful)
        if (pet.hatched && lastEquity < WIPEOUT_EQUITY_THRESHOLD) {
          // hard reset: back to egg
          const p = resetPet(true);
          return { wiped: true, pet: p };
        }
        return { wiped: false, pet };
      }

      // ------------------------------
      // Pet renderer (frame animation)
      // ------------------------------
      const petCanvas = $("pet-canvas");
      const petCtx = petCanvas.getContext("2d");

      let pet = loadPet();
      let frameToggle = false;
      let lastRenderAt = 0;

      function renderPet(pet, deltaInfo) {
        // clear
        petCtx.clearRect(0,0,petCanvas.width, petCanvas.height);

        const mode = currentAnimMode(pet);
        const isEgg = !pet.hatched;

        // screen shake while hatching
        const screen = $("pet-screen");
        if (mode === "hatch" && isEgg) screen.classList.add("shake");
        else screen.classList.remove("shake");

        // choose base frame
        let frame = null;

        if (isEgg) {
          if (mode === "hatch") {
            // cycle egg_shake -> crack
            frame = frameToggle ? FRAMES.egg_shake : FRAMES.crack;
          } else {
            frame = frameToggle ? FRAMES.egg_idle : FRAMES.egg_idle;
          }
        } else {
          const sp = pet.species === "dog" ? "dog" : "cat";
          if (mode === "eat") {
            frame = frameToggle ? FRAMES[sp + "_eat1"] : FRAMES[sp + "_eat2"];
          } else if (mode === "sad") {
            frame = frameToggle ? FRAMES[sp + "_sad1"] : FRAMES[sp + "_sad2"];
          } else {
            // idle pacing: alternate idle/walk for life
            const hunger = pet.hunger;
            const pace = (hunger > 55) ? "walk" : (Math.random()<0.35 ? "walk" : "idle");
            if (pace === "walk") frame = frameToggle ? FRAMES[sp + "_walk1"] : FRAMES[sp + "_walk2"];
            else frame = frameToggle ? FRAMES[sp + "_idle1"] : FRAMES[sp + "_idle2"];
          }
        }

        // draw 16x16 at scale 2, centered
        const scale = 2;
        const ox = 0;
        const oy = 0;
        drawFrame(petCtx, frame, ox, oy, scale);

        // UI text + bars
        const moodText = decideMood(pet);
        $("pet-mood").textContent = moodText;
        $("pet-stage").textContent = badgeText(pet);

        const xpPct = xpPercentWithinStage(pet.xp);
        $("pet-xp-bar").style.width = xpPct + "%";
        $("pet-xp-text").textContent = xpPct + "%";

        const hPct = hungerPercent(pet.hunger);
        $("pet-hunger-bar").style.width = hPct + "%";
        $("pet-hunger-text").textContent = hPct + "%";

        // subtext dynamic
        if (!pet.hatched) {
          $("pet-subtext").textContent = "Stays an egg until overall PnL turns positive‚Ä¶ then it hatches ü•ö‚ú®";
        } else {
          const spName = pet.species === "dog" ? "dog" : "cat";
          let appetite = "Wins are food üçó. Losses are empty plates üçΩÔ∏è.";
          if (pet.hunger >= 80) appetite = "Starving‚Ä¶ feed it wins üçóüòø";
          else if (pet.hunger >= 60) appetite = "Hungry‚Ä¶ needs wins (food) üçó";
          else if (mode === "eat") appetite = "Yum! Wins fed it üçó";
          else if (mode === "sad") appetite = "Ouch‚Ä¶ empty plate üçΩÔ∏è";
          $("pet-subtext").textContent =
            `Hatched as a ${spName}. ${appetite} More wins = it grows.`;
        }

        // debug (small + helpful)
        const dbg = [];
        if (deltaInfo?.dWins) dbg.push(`+${deltaInfo.dWins} win`);
        if (deltaInfo?.dLosses) dbg.push(`+${deltaInfo.dLosses} loss`);
        $("pet-debug").textContent = dbg.join(", ");

        frameToggle = !frameToggle;
      }

      // manual reset button
      $("pet-reset-btn").addEventListener("click", () => {
        if (confirm("Reset the pet back to egg?")) {
          pet = resetPet(true);
          renderPet(pet, null);
        }
      });

      // ------------------------------
      // Fetch + hydrate dashboard
      // ------------------------------
      async function refreshDashboard() {
        try {
          const res = await fetch("/data");
          const data = await res.json();

          // Top metrics
          $("metric-total-trades").textContent = data.total_trades ?? 0;
          $("metric-wins").textContent = (data.wins ?? 0) + " wins";
          $("metric-losses").textContent = (data.losses ?? 0) + " losses";

          const winRate = data.win_rate != null ? data.win_rate : 0;
          $("metric-win-rate").textContent = formatPercent(winRate, 1);

          // avg pnl per trade (derived)
          const totalTrades = data.total_trades ?? 0;
          const avgPnl = totalTrades ? (Number(data.total_pnl_usd ?? 0) / totalTrades) : 0;
          $("metric-avg-pnl").textContent = formatUsd(avgPnl);

          const totalPnl = Number(data.total_pnl_usd ?? 0);
          const pnlEl = $("metric-total-pnl");
          pnlEl.textContent = formatUsd(totalPnl);
          pnlEl.classList.remove("positive", "negative");
          pnlEl.classList.add(totalPnl >= 0 ? "positive" : "negative");

          // Equity
          updateEquityChart(data.equity_curve || []);

          // Bot status
          updateBotStatus(data.bot_status);

          // Per-market & trades
          updatePerMarket(data.per_market || []);
          updateRecentTrades(data.recent_trades || []);

          // Advanced
          updateAdvancedMetrics(data.advanced_metrics, data.max_drawdown_usd);

          // --------------------------
          // PET LOGIC
          // --------------------------
          pet = loadPet();
          applyTimeHunger(pet);

          // last equity for wipeout check
          const eq = (data.equity_curve && data.equity_curve.length)
            ? Number(data.equity_curve[data.equity_curve.length - 1].equity_usd)
            : (pet.lastEquity != null ? Number(pet.lastEquity) : null);

          pet.lastEquity = (eq != null && !Number.isNaN(eq)) ? eq : pet.lastEquity;

          // hatch if conditions met
          const hatchedNow = maybeHatch(pet, totalPnl);

          // react to trade deltas
          const deltaInfo = processTradeDeltas(pet, data);

          // if hatched, stage from xp
          if (pet.hatched) pet.stage = stageFromXp(pet.xp);

          // wipeout auto reset (tweak threshold at top)
          const wipe = maybeWipeoutReset(pet, pet.lastEquity);
          if (wipe.wiped) {
            pet = wipe.pet;
          }

          savePet(pet);

          // render pet
          renderPet(pet, deltaInfo);

        } catch (err) {
          console.error("Failed to refresh dashboard", err);
        }
      }

      // ------------------------------
      // Pet animation loop (smooth feel)
      // ------------------------------
      function petLoop() {
        const now = Date.now();
        if (now - lastRenderAt > TICK_MS) {
          lastRenderAt = now;
          // render with no delta info (refreshDashboard handles deltas)
          renderPet(loadPet(), null);
        }
        requestAnimationFrame(petLoop);
      }

      // ------------------------------
      // Init
      // ------------------------------
      document.addEventListener("DOMContentLoaded", () => {
        setupTvTabs();
        loadTradingView(currentSymbol);

        // render immediately
        renderPet(loadPet(), null);

        // start loops
        refreshDashboard();
        setInterval(refreshDashboard, 10_000);
        requestAnimationFrame(petLoop);
      });
    </script>
  </body>
</html>
