<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto AI Bot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, initial-scale=1.0" />
  <!-- Simple dark theme with basic CSS only -->
  <style>
    :root {
      --bg: #050814;
      --bg-card: #101522;
      --bg-card-soft: #141b2c;
      --text-main: #f8fafc;
      --text-muted: #9ca3af;
      --accent: #22c55e;
      --accent-red: #f44c4c;
      --border-soft: #1f2937;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827, #020617);
      color: var(--text-main);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      margin-bottom: 24px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 28px;
      font-weight: 700;
    }

    header p {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    header a {
      color: #38bdf8;
      text-decoration: none;
      margin-left: 4px;
      margin-right: 4px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .card {
      background: linear-gradient(145deg, var(--bg-card), #060b17);
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
    }

    .card h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin: 0 0 8px;
    }

    .metric-main {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .metric-sub span {
      font-weight: 600;
    }

    .metric-positive {
      color: var(--accent);
    }

    .metric-negative {
      color: var(--accent-red);
    }

    .panel {
      background: linear-gradient(160deg, var(--bg-card-soft), #020617);
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 14px 14px 16px;
      margin-bottom: 16px;
    }

    .panel h2 {
      font-size: 14px;
      margin: 0 0 4px;
    }

    .panel-subtitle {
      margin: 0 0 12px;
      font-size: 12px;
      color: var(--text-muted);
    }

    canvas {
      width: 100%;
      max-width: 100%;
    }

    .equity-wrapper {
      min-height: 220px;
    }

    .tables-wrapper {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 12px;
    }

    @media (max-width: 800px) {
      .tables-wrapper {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: rgba(15, 23, 42, 0.8);
    }

    th, td {
      padding: 6px 4px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
      font-size: 11px;
    }

    td.time {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pnl-positive {
      color: var(--accent);
      font-weight: 600;
    }

    .pnl-negative {
      color: var(--accent-red);
      font-weight: 600;
    }

    .footer-note {
      margin-top: 16px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    /* Candles section */

    .candles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .candles-card-title {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .candles-card-title span {
      font-size: 11px;
      color: var(--text-muted);
    }

    .candles-status {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
  </style>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
</head>
<body>
  <div class="page">
    <header>
      <h1>Crypto AI Bot Dashboard</h1>
      <p>
        Paper-trading stats from Render —
        <a href="/data" target="_blank">raw stats</a> |
        <a href="/health" target="_blank">API status</a>
      </p>
    </header>

    <!-- Top metrics -->
    <section class="cards">
      <article class="card">
        <h2>Total Trades</h2>
        <div class="metric-main" id="metric-total-trades">0</div>
        <div class="metric-sub" id="metric-wins-losses">0 wins / 0 losses</div>
      </article>

      <article class="card">
        <h2>Win Rate</h2>
        <div class="metric-main" id="metric-win-rate">0.0%</div>
        <div class="metric-sub">
          Avg <span id="metric-avg-pnl">$0.00</span> per trade
        </div>
      </article>

      <article class="card">
        <h2>PNL (Total)</h2>
        <div class="metric-main" id="metric-total-pnl">$0.00</div>
        <div class="metric-sub">Based on closed trades only</div>
      </article>
    </section>

    <!-- Equity curve -->
    <section class="panel">
      <h2>Equity Curve</h2>
      <p class="panel-subtitle">Based on closed trades only.</p>
      <div class="equity-wrapper">
        <canvas id="equityChart"></canvas>
      </div>
    </section>

    <!-- Candlestick charts -->
    <section class="panel">
      <h2>Market Candles</h2>
      <p class="panel-subtitle">
        Bot performance vs. public BTC markets (1h candles, best-effort from Coinbase &amp; KuCoin).
      </p>
      <div class="candles-grid">
        <article class="card">
          <div class="candles-card-title">
            <h2>Bot Equity (Line)</h2>
            <span id="bot-candles-status">From /data</span>
          </div>
          <canvas id="botEquityLineChart"></canvas>
        </article>

        <article class="card">
          <div class="candles-card-title">
            <h2>Coinbase BTC-USD</h2>
            <span id="coinbase-status">Loading…</span>
          </div>
          <canvas id="coinbaseCandles"></canvas>
          <div class="candles-status">
            Uses Coinbase public candles (no API key). If this stays empty, it’s likely blocked by CORS.
          </div>
        </article>

        <article class="card">
          <div class="candles-card-title">
            <h2>KuCoin BTC-USDT</h2>
            <span id="kucoin-status">Loading…</span>
          </div>
          <canvas id="kucoinCandles"></canvas>
          <div class="candles-status">
            Uses KuCoin public candles (no API key). If this stays empty, it’s likely blocked by CORS.
          </div>
        </article>
      </div>
    </section>

    <!-- Tables -->
    <section class="tables-wrapper">
      <article class="panel">
        <h2>Per-Market Performance</h2>
        <p class="panel-subtitle" id="per-market-subtitle">How the bot is doing on each market (paper trading).</p>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Market</th>
                <th>Trades</th>
                <th>Win rate</th>
                <th>Total PnL</th>
                <th>Avg PnL</th>
              </tr>
            </thead>
            <tbody id="per-market-body">
              <tr>
                <td colspan="5">Waiting for trades…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </article>

      <article class="panel">
        <h2>Recent Trades</h2>
        <p class="panel-subtitle" id="recent-trades-subtitle">Waiting for trades…</p>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Market</th>
                <th>PNL (USD)</th>
              </tr>
            </thead>
            <tbody id="recent-trades-body">
              <tr>
                <td colspan="3">No trades yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </article>
    </section>

    <p class="footer-note">
      Bot is running on Render (paper trading only). Keep it training for 2–3 weeks before making AI changes.
    </p>
  </div>

  <script>
    // Helper: format dollars
    function fmtUsd(value) {
      const n = Number(value || 0);
      const sign = n >= 0 ? "" : "-";
      return sign + "$" + Math.abs(n).toFixed(2);
    }

    function fmtPercentage(value) {
      const n = Number(value || 0) * 100;
      return n.toFixed(1) + "%";
    }

    // Global chart instances
    let equityChart = null;
    let botEquityLineChart = null;
    let coinbaseCandleChart = null;
    let kucoinCandleChart = null;

    async function loadStats() {
      try {
        const res = await fetch("/data", { cache: "no-store" });
        const data = await res.json();

        const totalTrades = data.total_events || 0;
        const wins = data.wins || 0;
        const losses = data.losses || 0;
        const winRate = data.win_rate || 0;
        const totalPnl = data.total_pnl_usd || 0;
        const avgPnl = data.avg_pnl_usd || 0;
        const equityCurve = data.equity_curve || [];
        const perMarket = data.per_market || [];
        const recentTrades = data.recent_trades || [];

        // Metrics cards
        document.getElementById("metric-total-trades").textContent = totalTrades;
        document.getElementById("metric-wins-losses").textContent =
          wins + " wins / " + losses + " losses";

        document.getElementById("metric-win-rate").textContent = fmtPercentage(winRate);

        const avgPnlEl = document.getElementById("metric-avg-pnl");
        avgPnlEl.textContent = fmtUsd(avgPnl);
        avgPnlEl.className =
          avgPnl > 0 ? "metric-positive" : avgPnl < 0 ? "metric-negative" : "";

        const totalPnlEl = document.getElementById("metric-total-pnl");
        totalPnlEl.textContent = fmtUsd(totalPnl);
        totalPnlEl.className =
          totalPnl > 0 ? "metric-positive" : totalPnl < 0 ? "metric-negative" : "";

        // Equity line chart
        const equityLabels = equityCurve.map((p) => p.time || p[0]);
        const equityValues = equityCurve.map((p) => Number(p.equity_usd || p[1]));

        const equityCtx = document.getElementById("equityChart").getContext("2d");
        if (!equityChart) {
          equityChart = new Chart(equityCtx, {
            type: "line",
            data: {
              labels: equityLabels,
              datasets: [
                {
                  label: "Equity (USD)",
                  data: equityValues,
                  borderWidth: 2,
                  fill: false,
                  tension: 0.2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  ticks: { display: false }
                },
                y: {
                  ticks: { color: "#9ca3af", font: { size: 10 } },
                  grid: { color: "rgba(31,41,55,0.6)" }
                }
              },
              plugins: {
                legend: { display: false }
              }
            }
          });
        } else {
          equityChart.data.labels = equityLabels;
          equityChart.data.datasets[0].data = equityValues;
          equityChart.update();
        }

        // Bot equity mini line in candles section
        const botCtx = document.getElementById("botEquityLineChart").getContext("2d");
        if (!botEquityLineChart) {
          botEquityLineChart = new Chart(botCtx, {
            type: "line",
            data: {
              labels: equityLabels,
              datasets: [
                {
                  label: "Equity (USD)",
                  data: equityValues,
                  borderWidth: 2,
                  fill: false,
                  tension: 0.2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { display: false },
                y: { display: false }
              },
              plugins: {
                legend: { display: false }
              }
            }
          });
        } else {
          botEquityLineChart.data.labels = equityLabels;
          botEquityLineChart.data.datasets[0].data = equityValues;
          botEquityLineChart.update();
        }

        // Per-market table
        const perMarketBody = document.getElementById("per-market-body");
        perMarketBody.innerHTML = "";

        if (!perMarket.length) {
          perMarketBody.innerHTML =
            '<tr><td colspan="5">Waiting for trades…</td></tr>';
          document.getElementById("per-market-subtitle").textContent =
            "How the bot is doing on each market (paper trading).";
        } else {
          document.getElementById("per-market-subtitle").textContent =
            "How the bot is doing on each market (paper trading).";
          perMarket.forEach((m) => {
            const tr = document.createElement("tr");

            const total = m.trades || 0;
            const wr = m.win_rate || 0;
            const tp = m.total_pnl_usd || 0;
            const ap = total ? tp / total : 0;

            tr.innerHTML = `
              <td>${m.market}</td>
              <td>${total}</td>
              <td>${fmtPercentage(wr)}</td>
              <td class="${tp > 0 ? "pnl-positive" : tp < 0 ? "pnl-negative" : ""}">
                ${fmtUsd(tp)}
              </td>
              <td class="${ap > 0 ? "pnl-positive" : ap < 0 ? "pnl-negative" : ""}">
                ${fmtUsd(ap)}
              </td>
            `;
            perMarketBody.appendChild(tr);
          });
        }

        // Recent trades table
        const recentBody = document.getElementById("recent-trades-body");
        const recentSubtitle = document.getElementById("recent-trades-subtitle");
        recentBody.innerHTML = "";

        if (!recentTrades.length) {
          recentBody.innerHTML = '<tr><td colspan="3">No trades yet.</td></tr>';
          recentSubtitle.textContent = "Waiting for trades…";
        } else {
          recentSubtitle.textContent =
            "Showing last " + recentTrades.length + " trades.";
          recentTrades.forEach((t) => {
            const tr = document.createElement("tr");
            const pnl = Number(t.pnl_usd || t.pnl || 0);
            tr.innerHTML = `
              <td class="time">${t.exit_time || t.time || ""}</td>
              <td>${t.market || ""}</td>
              <td class="${pnl > 0 ? "pnl-positive" : pnl < 0 ? "pnl-negative" : ""}">
                ${fmtUsd(pnl)}
              </td>
            `;
            recentBody.appendChild(tr);
          });
        }
      } catch (err) {
        console.error("Failed to load stats:", err);
      }
    }

    // ---- Candles from Coinbase & KuCoin (best effort) ----

    async function loadCoinbaseCandles() {
      const statusEl = document.getElementById("coinbase-status");
      statusEl.textContent = "Loading…";
      try {
        // 1h candles for BTC-USD
        const url =
          "https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=3600";
        const res = await fetch(url);
        if (!res.ok) {
          statusEl.textContent = "Error " + res.status;
          return;
        }
        const raw = await res.json();
        // Coinbase returns [time, low, high, open, close, volume]
        const candles = raw
          .slice(0, 60) // limit to ~60 hours
          .map((c) => ({
            x: new Date(c[0] * 1000),
            o: Number(c[3]),
            h: Number(c[2]),
            l: Number(c[1]),
            c: Number(c[4])
          }))
          .reverse();

        const ctx = document
          .getElementById("coinbaseCandles")
          .getContext("2d");

        if (!coinbaseCandleChart) {
          coinbaseCandleChart = new Chart(ctx, {
            type: "candlestick",
            data: {
              datasets: [
                {
                  label: "BTC-USD",
                  data: candles
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              parsing: false,
              scales: {
                x: {
                  ticks: { display: false },
                  time: { unit: "hour" }
                },
                y: {
                  ticks: { display: false }
                }
              },
              plugins: {
                legend: { display: false }
              }
            }
          });
        } else {
          coinbaseCandleChart.data.datasets[0].data = candles;
          coinbaseCandleChart.update();
        }

        statusEl.textContent = "1h candles";
      } catch (err) {
        console.error("Coinbase candles error:", err);
        statusEl.textContent = "No data (likely CORS)";
      }
    }

    async function loadKucoinCandles() {
      const statusEl = document.getElementById("kucoin-status");
      statusEl.textContent = "Loading…";
      try {
        // 1h candles for BTC-USDT on KuCoin
        const url =
          "https://api.kucoin.com/api/v1/market/candles?type=1hour&symbol=BTC-USDT";
        const res = await fetch(url);
        if (!res.ok) {
          statusEl.textContent = "Error " + res.status;
          return;
        }
        const json = await res.json();
        const raw = json.data || [];
        // KuCoin: [time, open, close, high, low, volume, turnover]
        const candles = raw
          .slice(0, 60)
          .map((c) => ({
            x: new Date(Number(c[0]) * 1000),
            o: Number(c[1]),
            c: Number(c[2]),
            h: Number(c[3]),
            l: Number(c[4])
          }))
          .reverse();

        const ctx = document
          .getElementById("kucoinCandles")
          .getContext("2d");

        if (!kucoinCandleChart) {
          kucoinCandleChart = new Chart(ctx, {
            type: "candlestick",
            data: {
              datasets: [
                {
                  label: "BTC-USDT",
                  data: candles
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              parsing: false,
              scales: {
                x: {
                  ticks: { display: false },
                  time: { unit: "hour" }
                },
                y: {
                  ticks: { display: false }
                }
              },
              plugins: {
                legend: { display: false }
              }
            }
          });
        } else {
          kucoinCandleChart.data.datasets[0].data = candles;
          kucoinCandleChart.update();
        }

        statusEl.textContent = "1h candles";
      } catch (err) {
        console.error("KuCoin candles error:", err);
        statusEl.textContent = "No data (likely CORS)";
      }
    }

    // Initial load + periodic refresh
    document.addEventListener("DOMContentLoaded", () => {
      loadStats();
      loadCoinbaseCandles();
      loadKucoinCandles();

      // Refresh stats and candles every 5 minutes
      setInterval(loadStats, 5 * 60 * 1000);
      setInterval(loadCoinbaseCandles, 5 * 60 * 1000);
      setInterval(loadKucoinCandles, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
