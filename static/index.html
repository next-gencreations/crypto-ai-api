<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crypto AI Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #050814;
        --bg-card: #101522;
        --text-main: #f8f4fc;
        --text-muted: #9ca3af;
        --accent: #22c55e;
        --accent-red: #ef4444;
        --border-soft: #1f2937;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text-main);
      }
      .page { max-width: 1200px; margin: 0 auto; padding: 24px 16px 40px; }
      header { margin-bottom: 24px; }
      h1 { margin: 0 0 4px; font-size: 28px; font-weight: 700; letter-spacing: 0.03em; }
      header p { margin: 0; font-size: 13px; color: var(--text-muted); }
      header a { color: #38bdf8; text-decoration: none; margin: 0 4px; }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }
      .card {
        background: linear-gradient(145deg, var(--bg-card), #060b17);
        border-radius: 14px;
        padding: 14px 16px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 12px 30px rgba(0,0,0,0.45);
      }
      .card h2 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 8px;
      }
      .metric-main { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
      .metric-sub { font-size: 12px; color: var(--text-muted); }
      .metric-main.positive { color: var(--accent); }
      .metric-main.negative { color: var(--accent-red); }

      .card-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); }
      .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; border-radius: 999px; font-size: 11px; background: rgba(15, 23, 42, 0.8); }
      .status-dot { width: 7px; height: 7px; border-radius: 50%; }
      .status-running { background-color: #22c55e; }
      .status-idle { background-color: #eab308; }
      .status-stopped { background-color: #ef4444; }
      .status-unknown { background-color: #6b7280; }

      .section-title { font-size: 14px; text-transform: uppercase; letter-spacing: 0.14em; color: var(--text-muted); margin: 0 0 8px; }
      .section-subtitle { font-size: 12px; color: var(--text-muted); margin: 0 0 12px; }
      .section-card { margin-bottom: 24px; }

      .section-grid { display: grid; grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr); gap: 16px; }
      @media (max-width: 900px) { .section-grid { grid-template-columns: minmax(0,1fr); } }

      .chart-container {
        height: 260px;
        background: radial-gradient(circle at top, #020617, #020617);
        border-radius: 14px;
        border: 1px solid var(--border-soft);
        overflow: hidden;
      }
      .chart-inner { width: 100%; height: 100%; }

      table { width: 100%; border-collapse: collapse; font-size: 12px; }
      thead { background: rgba(15, 23, 42, 0.9); }
      th, td { padding: 8px 10px; text-align: left; }
      th {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-bottom: 1px solid var(--border-soft);
      }
      tbody tr:nth-child(odd) { background: rgba(15, 23, 42, 0.4); }
      tbody tr:nth-child(even) { background: rgba(15, 23, 42, 0.1); }
      tbody tr:hover { background: rgba(55, 65, 81, 0.4); }
      .text-right { text-align: right; }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        background: rgba(15, 23, 42, 0.9);
      }
      .pill.positive { color: var(--accent); }
      .pill.negative { color: var(--accent-red); }
      .muted { color: var(--text-muted); }

      .advanced-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px 14px;
        margin-top: 6px;
      }
      .adv-label { font-size: 11px; color: var(--text-muted); }
      .adv-value { font-size: 14px; font-weight: 600; }

      .tv-tabs {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        padding: 2px;
        margin-bottom: 8px;
      }
      .tv-tab {
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        cursor: pointer;
      }
      .tv-tab.active { background: #0f172a; color: var(--text-main); }

      .footer { margin-top: 18px; font-size: 11px; color: var(--text-muted); text-align: center; }

      /* ----------------------------
         BOT PET UI (more Tamagotchi)
      ---------------------------- */
      .pet-wrap { display: grid; grid-template-columns: 86px 1fr; gap: 12px; align-items: center; }

      .pet-screen {
        width: 82px;
        height: 82px;
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        background:
          radial-gradient(circle at 20% 20%, rgba(59,130,246,0.18), transparent 55%),
          radial-gradient(circle at 80% 60%, rgba(34,197,94,0.16), transparent 55%),
          linear-gradient(180deg, rgba(15,23,42,0.85), rgba(2,6,23,0.92));
        display: grid;
        place-items: center;
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 0 18px rgba(56,189,248,0.08);
      }
      /* scanlines */
      .pet-screen::before {
        content: "";
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
          180deg,
          rgba(255,255,255,0.03),
          rgba(255,255,255,0.03) 1px,
          transparent 2px,
          transparent 4px
        );
        opacity: 0.22;
        pointer-events: none;
      }
      /* glass sheen */
      .pet-screen::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255,255,255,0.10), transparent 45%);
        pointer-events: none;
        opacity: 0.35;
      }

      canvas#pet-canvas { image-rendering: pixelated; width: 64px; height: 64px; }

      .pet-meta .pet-title { display: flex; align-items: baseline; justify-content: space-between; gap: 10px; }
      .pet-meta .pet-title b { font-size: 14px; letter-spacing: 0.02em; }
      .pet-meta .pet-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

      .pet-bars { margin-top: 10px; display: grid; gap: 8px; }
      .bar-row { display: grid; grid-template-columns: 70px 1fr 44px; gap: 8px; align-items: center; }
      .bar-row span { font-size: 11px; color: var(--text-muted); }

      .bar {
        height: 10px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 999px;
        overflow: hidden;
      }
      .bar > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(34,197,94,0.95), rgba(59,130,246,0.85));
      }
      .bar.danger > i {
        background: linear-gradient(90deg, rgba(239,68,68,0.95), rgba(245,158,11,0.85));
      }

      .pet-actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
      .btn {
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(15, 23, 42, 0.8);
        color: var(--text-main);
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 999px;
        cursor: pointer;
      }
      .btn:hover { border-color: rgba(148, 163, 184, 0.32); }

      .pet-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(15,23,42,0.8);
        color: var(--text-muted);
        border: 1px solid rgba(148, 163, 184, 0.12);
      }

      .shake { animation: shake 250ms ease-in-out infinite; }
      @keyframes shake {
        0% { transform: translate(0,0) rotate(0deg); }
        25% { transform: translate(1px,-1px) rotate(-1deg); }
        50% { transform: translate(-1px,1px) rotate(1deg); }
        75% { transform: translate(1px,1px) rotate(0deg); }
        100% { transform: translate(0,0) rotate(0deg); }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header>
        <h1>Crypto AI Bot Dashboard</h1>
        <p>Paper-trading stats from Render ‚Äî <a href="/data" target="_blank">raw stats</a></p>
      </header>

      <section class="cards">
        <div class="card">
          <h2>Total Trades</h2>
          <div class="metric-main" id="metric-total-trades">0</div>
          <div class="metric-sub">
            <span id="metric-wins">0 wins</span> /
            <span id="metric-losses">0 losses</span>
          </div>
        </div>

        <div class="card">
          <h2>Win Rate</h2>
          <div class="metric-main" id="metric-win-rate">0%</div>
          <div class="metric-sub">Avg <span id="metric-avg-pnl">-$0.00</span> per trade</div>
        </div>

        <div class="card">
          <h2>PNL (Total)</h2>
          <div class="metric-main negative" id="metric-total-pnl">$0.00</div>
          <div class="metric-sub">Based on closed trades only.</div>
        </div>

        <div class="card">
          <h2>Bot Status</h2>
          <div class="card-row" style="margin-bottom: 6px">
            <div class="status-pill" id="bot-status-pill">
              <span class="status-dot status-unknown" id="bot-status-dot"></span>
              <span id="bot-status-label">Unknown</span>
            </div>
            <span class="muted" id="bot-status-minutes"></span>
          </div>
          <div class="metric-sub" id="bot-status-last">Waiting for heartbeat‚Ä¶</div>
        </div>

        <!-- BOT PET CARD -->
        <div class="card">
          <h2>Bot Pet</h2>
          <div class="pet-wrap">
            <div class="pet-screen" id="pet-screen">
              <canvas id="pet-canvas" width="64" height="64"></canvas>
            </div>

            <div class="pet-meta">
              <div class="pet-title">
                <div>
                  <div class="muted" style="font-size: 11px; letter-spacing: 0.14em; text-transform: uppercase;">Mood</div>
                  <b id="pet-mood">Watching‚Ä¶</b>
                </div>
                <span class="pet-badge" id="pet-stage">Egg</span>
              </div>

              <div class="pet-sub" id="pet-subtext">Wins are food üçó. Losses are empty plates üçΩÔ∏è.</div>

              <div class="pet-bars">
                <div class="bar-row">
                  <span>Growth</span>
                  <div class="bar"><i id="pet-xp-bar"></i></div>
                  <span class="muted" id="pet-xp-text">0%</span>
                </div>
                <div class="bar-row">
                  <span>Hunger</span>
                  <div class="bar danger"><i id="pet-hunger-bar"></i></div>
                  <span class="muted" id="pet-hunger-text">0%</span>
                </div>
              </div>

              <div class="pet-actions">
                <button class="btn" id="pet-reset-btn">Reset Pet</button>
                <span class="muted" style="font-size:11px" id="pet-debug"></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card section-card">
        <div class="card-row" style="margin-bottom: 6px">
          <div>
            <div class="section-title">Advanced Analytics</div>
            <div class="section-subtitle">Deeper stats from your closed trades.</div>
          </div>
        </div>

        <div class="advanced-grid">
          <div><div class="adv-label">Profit Factor</div><div class="adv-value" id="adv-profit-factor">‚Äî</div></div>
          <div><div class="adv-label">Avg Win (USD)</div><div class="adv-value" id="adv-avg-win">‚Äî</div></div>
          <div><div class="adv-label">Avg Loss (USD)</div><div class="adv-value" id="adv-avg-loss">‚Äî</div></div>
          <div><div class="adv-label">Best Trade (USD)</div><div class="adv-value" id="adv-best-trade">‚Äî</div></div>
          <div><div class="adv-label">Worst Trade (USD)</div><div class="adv-value" id="adv-worst-trade">‚Äî</div></div>
          <div><div class="adv-label">Max Drawdown (USD)</div><div class="adv-value" id="adv-max-dd">‚Äî</div></div>
          <div><div class="adv-label">Recovery Factor</div><div class="adv-value" id="adv-recovery-factor">‚Äî</div></div>
          <div><div class="adv-label">Sharpe Ratio</div><div class="adv-value" id="adv-sharpe">‚Äî</div></div>
        </div>
      </section>

      <section class="section-grid">
        <div>
          <div class="section-title">Equity Curve</div>
          <div class="section-subtitle">Tracks paper-trading balance over time (USD).</div>
          <div class="chart-container">
            <canvas id="equity-chart" class="chart-inner"></canvas>
          </div>
        </div>

        <div>
          <div class="section-card">
            <div class="section-title">Per-Market Performance</div>
            <div class="section-subtitle">How the bot is doing on each market (paper trading).</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Market</th>
                    <th class="text-right">Trades</th>
                    <th class="text-right">Win Rate</th>
                    <th class="text-right">Total PnL</th>
                    <th class="text-right">Avg PnL</th>
                  </tr>
                </thead>
                <tbody id="per-market-body">
                  <tr><td colspan="5" class="muted">No markets yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">Recent Trades</div>
            <div class="section-subtitle">Showing last 20 closed trades.</div>
            <div class="card" style="padding: 0">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Market</th>
                    <th class="text-right">PnL (USD)</th>
                  </tr>
                </thead>
                <tbody id="recent-trades-body">
                  <tr><td colspan="3" class="muted">No trades yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="section-card">
        <div class="section-title">Market Candlestick Charts</div>
        <div class="section-subtitle">
          Live BTC-USD candlesticks on your main venues. Charts are from TradingView only (they do not place trades).
        </div>

        <div class="card">
          <div class="card-row" style="margin-bottom: 10px">
            <div>Venue</div>
            <div class="tv-tabs">
              <button class="tv-tab active" data-symbol="COINBASE:BTCUSD">Coinbase</button>
              <button class="tv-tab" data-symbol="KUCOIN:BTCUSDT">KuCoin</button>
              <button class="tv-tab" data-symbol="CRYPTOCOM:BTCUSD">Crypto.com</button>
            </div>
          </div>

          <div class="tradingview-widget-container" style="height: 400px">
            <div id="tv-chart"></div>
          </div>

          <div class="section-subtitle" style="margin-top: 10px">
            If a chart fails to load for a venue, adjust the TradingView symbol in the HTML
            (e.g. <span class="muted">COINBASE:BTCUSD, KUCOIN:BTCUSDT, CRYPTOCOM:BTCUSD</span>).
          </div>
        </div>
      </section>

      <div class="footer">
        Bot is running on Render (paper trading only). Keep it training for 2‚Äì3 weeks before making AI changes.
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
      // ------------------------------
      // Utilities
      // ------------------------------
      function $(id) { return document.getElementById(id); }
      function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
      function formatUsd(v){
        if (v===null||v===undefined||isNaN(v)) return "‚Äî";
        const sign = v<0 ? "-" : "";
        const abs = Math.abs(v);
        return sign + "$" + abs.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      }
      function formatPercent(v,d=1){
        if (v===null||v===undefined||isNaN(v)) return "‚Äî";
        return v.toFixed(d) + "%";
      }
      function formatNumber(v,d=2){
        if (v===null||v===undefined||isNaN(v)) return "‚Äî";
        return v.toFixed(d);
      }
      function formatTime(iso){
        const d=new Date(iso);
        if (Number.isNaN(d.getTime())) return iso;
        return d.toLocaleString();
      }

      // ------------------------------
      // Equity Chart
      // ------------------------------
      let equityChart=null;
      function updateEquityChart(points){
        const ctx=$("equity-chart");
        const labels = points.map(p=>{
          const t=p.time_utc || p.time || "";
          const d=new Date(t);
          return Number.isNaN(d.getTime()) ? "" : d.toLocaleTimeString();
        });
        const data = points.map(p=>p.equity_usd);

        if(equityChart){
          equityChart.data.labels=labels;
          equityChart.data.datasets[0].data=data;
          equityChart.update();
          return;
        }
        equityChart=new Chart(ctx,{
          type:"line",
          data:{ labels, datasets:[{ label:"Equity (USD)", data, tension:0.35, borderWidth:2, pointRadius:2 }] },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(c)=>"Equity: "+formatUsd(c.parsed.y) } } },
            scales:{
              x:{ ticks:{maxTicksLimit:6}, grid:{color:"rgba(31,41,55,0.6)"} },
              y:{ ticks:{ callback:(v)=>"$"+v }, grid:{color:"rgba(31,41,55,0.6)"} }
            }
          }
        });
      }

      // ------------------------------
      // Bot status
      // ------------------------------
      function updateBotStatus(status){
        const dot=$("bot-status-dot");
        const label=$("bot-status-label");
        const minutesEl=$("bot-status-minutes");
        const lastEl=$("bot-status-last");

        const s=status?.status||"unknown";
        label.textContent=s.charAt(0).toUpperCase()+s.slice(1);
        dot.className="status-dot status-"+s;

        minutesEl.textContent = status?.minutes_since!=null ? (status.minutes_since+" min since heartbeat") : "";
        lastEl.textContent = status?.last_heartbeat ? ("Last heartbeat: "+formatTime(status.last_heartbeat)) : "Heartbeat file not found yet.";
      }

      // ------------------------------
      // Advanced metrics
      // ------------------------------
      function updateAdvancedMetrics(adv,maxDdFromRoot){
        const a=adv||{};
        $("adv-profit-factor").textContent = a.profit_factor==null ? "‚Äî" : formatNumber(a.profit_factor,2);
        $("adv-avg-win").textContent = a.avg_win_usd==null ? "‚Äî" : formatUsd(a.avg_win_usd);
        $("adv-avg-loss").textContent = a.avg_loss_usd==null ? "‚Äî" : formatUsd(a.avg_loss_usd);
        $("adv-best-trade").textContent = a.best_trade_usd==null ? "‚Äî" : formatUsd(a.best_trade_usd);
        $("adv-worst-trade").textContent = a.worst_trade_usd==null ? "‚Äî" : formatUsd(a.worst_trade_usd);
        const maxdd = (a.max_drawdown_usd!=null)?a.max_drawdown_usd:maxDdFromRoot;
        $("adv-max-dd").textContent = maxdd==null ? "‚Äî" : formatUsd(maxdd);
        $("adv-recovery-factor").textContent = a.recovery_factor==null ? "‚Äî" : formatNumber(a.recovery_factor,2);
        $("adv-sharpe").textContent = a.sharpe_ratio==null ? "‚Äî" : formatNumber(a.sharpe_ratio,2);
      }

      // ------------------------------
      // Per-market + recent trades
      // ------------------------------
      function updatePerMarket(perMarket){
        const body=$("per-market-body");
        body.innerHTML="";
        if(!perMarket||perMarket.length===0){
          body.innerHTML=`<tr><td colspan="5" class="muted">No markets yet.</td></tr>`;
          return;
        }
        perMarket.forEach(m=>{
          const row=document.createElement("tr");
          row.innerHTML=`
            <td>${m.market}</td>
            <td class="text-right">${m.trades}</td>
            <td class="text-right">${formatPercent(m.win_rate,1)}</td>
            <td class="text-right">${formatUsd(m.total_pnl)}</td>
            <td class="text-right">${formatUsd(m.avg_pnl)}</td>
          `;
          body.appendChild(row);
        });
      }

      function updateRecentTrades(trades){
        const body=$("recent-trades-body");
        body.innerHTML="";
        if(!trades||trades.length===0){
          body.innerHTML=`<tr><td colspan="3" class="muted">No trades yet.</td></tr>`;
          return;
        }
        trades.forEach(t=>{
          const v=Number(t.pnl_usd);
          const row=document.createElement("tr");
          row.innerHTML=`
            <td>${t.time?formatTime(t.time):"‚Äî"}</td>
            <td>${t.market||"‚Äî"}</td>
            <td class="text-right"><span class="pill ${v>=0?"positive":"negative"}">${formatUsd(v)}</span></td>
          `;
          body.appendChild(row);
        });
      }

      // ------------------------------
      // TradingView
      // ------------------------------
      let currentSymbol="COINBASE:BTCUSD";
      function loadTradingView(symbol){
        currentSymbol=symbol;
        const container=document.getElementById("tv-chart");
        container.innerHTML="";
        new TradingView.widget({
          autosize:true, symbol, interval:"15", timezone:"Etc/UTC",
          theme:"dark", style:"1", locale:"en",
          enable_publishing:false, withdateranges:true, allow_symbol_change:false,
          container_id:"tv-chart"
        });
      }
      function setupTvTabs(){
        const tabs=document.querySelectorAll(".tv-tab");
        tabs.forEach(tab=>{
          tab.addEventListener("click",()=>{
            tabs.forEach(t=>t.classList.remove("active"));
            tab.classList.add("active");
            loadTradingView(tab.dataset.symbol);
          });
        });
      }

      // ==========================================================
      // BOT PET (Full Hog + More Realistic)
      // ==========================================================
      const PET_KEY="botpet_v2";

      const DEFAULT_PET={
        hatched:false,
        species:null,          // "cat" or "dog"
        stage:"egg",           // "egg" | "baby" | "teen" | "adult"
        xp:0,
        hunger:35,
        mood:"watching",
        lastTotalTrades:0,
        lastWins:0,
        lastLosses:0,
        lastEquity:null,
        lastEventAt:Date.now(),
        anim:{mode:"idle",until:0},
        lastEvent:"none",      // "food" | "empty" | "none"
        hatchedAt:null
      };

      // tweak knobs
      const HATCH_PNL_THRESHOLD = 0.01;     // first time total PnL > 0 hatches
      const WIPEOUT_EQUITY_THRESHOLD = 850; // auto reset to egg if equity drops under this
      const HUNGER_TIME_RATE = 1.1;         // hunger drift per hour
      const TICK_MS = 160;                  // animation frame interval

      function loadPet(){
        try{
          const raw=localStorage.getItem(PET_KEY);
          if(!raw) return structuredClone(DEFAULT_PET);
          const p=JSON.parse(raw);
          return { ...structuredClone(DEFAULT_PET), ...p, anim:{...DEFAULT_PET.anim,...(p.anim||{})} };
        }catch{ return structuredClone(DEFAULT_PET); }
      }
      function savePet(p){ localStorage.setItem(PET_KEY, JSON.stringify(p)); }
      function resetPet(hard=true){
        const p=structuredClone(DEFAULT_PET);
        if(!hard){
          const old=loadPet();
          p.lastTotalTrades=old.lastTotalTrades||0;
          p.lastWins=old.lastWins||0;
          p.lastLosses=old.lastLosses||0;
          p.lastEquity=old.lastEquity||null;
        }
        savePet(p);
        return p;
      }

      // ------------------------------
      // Pixel renderer
      // ------------------------------
      const petCanvas=$("pet-canvas");
      const ctx=petCanvas.getContext("2d");

      const PALETTE={
        " ": null,
        ".": "rgba(0,0,0,0.25)",
        "#": "#0b1220",
        "W": "#e6edf7",
        "G": "#94a3b8",
        "D": "#64748b",
        "P": "#fb7185",
        "Y": "#fbbf24",
        "B": "#60a5fa",
        "R": "#ef4444",
        "O": "#f97316",
        "K": "#111827"
      };

      function drawFrame(frame, ox, oy, scale){
        const h=frame.length;
        const w=frame[0].length;
        for(let y=0;y<h;y++){
          for(let x=0;x<w;x++){
            const ch=frame[y][x];
            const col=PALETTE[ch];
            if(!col) continue;
            ctx.fillStyle=col;
            ctx.fillRect(ox+x*scale, oy+y*scale, scale, scale);
          }
        }
      }

      // 24x24 sprites (more detail), drawn at scale 2 into 64x64 (24*2=48) centered
      const FRAMES={
        // EGG sequence
        egg_idle:[
          "        ######         ",
          "      ##GGGGGG##       ",
          "     #GGGWWWWGGG#      ",
          "    #GGWWGGGGWWGG#     ",
          "   #GGWGGGGGGGGWGG#    ",
          "   #GGWGGGGGGGGWGG#    ",
          "   #GGWWGGGGGGWWGG#    ",
          "   #GGGWWWWWWWWGGG#    ",
          "   #GGGGGGGGGGGGGG#    ",
          "    #GGGGGGGGGGGG#     ",
          "     #GGGGGGGGGG#      ",
          "      ##GGGGGG##       ",
          "        ######         ",
          "                       ",
          "       .........       ",
          "      ...........      ",
          "       .........       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        egg_shake:[
          "       ######          ",
          "     ##GGGGGG##        ",
          "    #GGGWWWWGGG#       ",
          "   #GGWWGGGGWWGG#      ",
          "  #GGWGGGGGGGGWGG#     ",
          "  #GGWGGGGGGGGWGG#     ",
          "  #GGWWGGGGGGWWGG#     ",
          "  #GGGWWWWWWWWGGG#     ",
          "  #GGGGGGGGGGGGGG#     ",
          "   #GGGGGGGGGGGG#      ",
          "    #GGGGGGGGGG#       ",
          "     ##GGGGGG##        ",
          "       ######          ",
          "                       ",
          "      .........        ",
          "     ...........       ",
          "      .........        ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        egg_crack:[
          "        ######         ",
          "      ##GGGGGG##       ",
          "     #GGGWWWWGGG#      ",
          "    #GGWWGG##WWGG#     ",
          "   #GGWGGG##GGGWGG#    ",
          "   #GGWGG##GGGGWGG#    ",
          "   #GGWWG##GGGWWGG#    ",
          "   #GGGWW##WWWWGGG#    ",
          "   #GGGGG##GGGGGGG#    ",
          "    #GGGG##GGGGGG#     ",
          "     #GGG##GGGGG#      ",
          "      ##GGGGGG##       ",
          "        ######         ",
          "                       ",
          "       .........       ",
          "      ...........      ",
          "       .........       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        sparkle1:[
          "                       ",
          "   B   B        B      ",
          "      B   B            ",
          "        ######         ",
          "      ##GGGGGG##       ",
          "     #GGGWWWWGGG#      ",
          "    #GGWWGG##WWGG#     ",
          "   #GGWGGG##GGGWGG#    ",
          "   #GGWGG##GGGGWGG#    ",
          "   #GGWWG##GGGWWGG#    ",
          "   #GGGWW##WWWWGGG#    ",
          "   #GGGGG##GGGGGGG#    ",
          "    #GGGG##GGGGGG#     ",
          "     #GGG##GGGGG#      ",
          "      ##GGGGGG##       ",
          "        ######         ",
          "       .........       ",
          "      ...........      ",
          "       .........       ",
          "            B          ",
          "       B               ",
          "                       ",
          "                       ",
          "                       ",
        ],
        sparkle2:[
          "                       ",
          "      B        B       ",
          "   B       B           ",
          "        ######         ",
          "      ##GGGGGG##       ",
          "     #GGGWWWWGGG#      ",
          "    #GGWWGG##WWGG#     ",
          "   #GGWGGG##GGGWGG#    ",
          "   #GGWGG##GGGGWGG#    ",
          "   #GGWWG##GGGWWGG#    ",
          "   #GGGWW##WWWWGGG#    ",
          "   #GGGGG##GGGGGGG#    ",
          "    #GGGG##GGGGGG#     ",
          "     #GGG##GGGGG#      ",
          "      ##GGGGGG##       ",
          "        ######         ",
          "       .........       ",
          "      ...........      ",
          "       .........       ",
          "                       ",
          "             B         ",
          "        B              ",
          "                       ",
          "                       ",
        ],

        // BOWL / PLATE overlays (bottom of screen)
        bowl_food:[
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "        #######        ",
          "       #WWWWWWW#       ",
          "       #YYWYYYW#       ",
          "        #WWWWW#        ",
          "         #####         ",
          "                       ",
        ],
        plate_empty:[
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "         #####         ",
          "       ##WWWWW##       ",
          "      #WWWWWWWWW#      ",
          "       ##WWWWW##       ",
          "         #####         ",
          "                       ",
        ],

        // CAT (more detailed)
        cat_idle1:[
          "                       ",
          "        ##    ##       ",
          "       #WW####WW#      ",
          "      #WGGGGGGGGW#     ",
          "      #WGPPGGPPGW#     ",
          "      #WGGGGGGGGW#     ",
          "       #WGG##GGW#      ",
          "        #WWWWWW#       ",
          "       ##W####W##      ",
          "      #..##..##..#     ",
          "      #..##..##..#     ",
          "       ####..####      ",
          "        ##....##       ",
          "       #..####..#      ",
          "       #..#  #..#      ",
          "        ###  ###       ",
          "          .. ..        ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        cat_idle2:[ // blink + tail flick
          "                       ",
          "        ##    ##       ",
          "       #WW####WW#      ",
          "      #WGGGGGGGGW#     ",
          "      #WGPPGGPPGW#     ",
          "      #WGGGGGGGGW#     ",
          "       #WGG####W#      ",
          "        #WWWWWW#       ",
          "      ###W####W##      ",
          "     #..##..##..#      ",
          "     #..##..##..#      ",
          "      ####..####       ",
          "       ##....##        ",
          "      #..####..#       ",
          "      #..#  #..#       ",
          "       ###  ###        ",
          "         .. ..         ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        cat_walk1:[
          "                       ",
          "        ##    ##       ",
          "       #WW####WW#      ",
          "      #WGGGGGGGGW#     ",
          "      #WGPPGGPPGW#     ",
          "      #WGGGGGGGGW#     ",
          "       #WGG##GGW#      ",
          "        #WWWWWW#       ",
          "     ####W####W##      ",
          "    #..##..##..#       ",
          "     #..##..##..#      ",
          "      ####..####       ",
          "        ##....##       ",
          "         ..####..      ",
          "          .#  #..      ",
          "           ##  ###     ",
          "            .. ..      ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        cat_walk2:[
          "                       ",
          "        ##    ##       ",
          "       #WW####WW#      ",
          "      #WGGGGGGGGW#     ",
          "      #WGPPGGPPGW#     ",
          "      #WGGGGGGGGW#     ",
          "       #WGG##GGW#      ",
          "        #WWWWWW#       ",
          "      ##W####W####     ",
          "       #..##..##..#    ",
          "      #..##..##..#     ",
          "      ####..####       ",
          "       ##....##        ",
          "      ..####..         ",
          "      ..#  #.          ",
          "      ###  ##          ",
          "       .. ..           ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        cat_eat1:[
          "                       ",
          "        ##    ##       ",
          "       #WW####WW#      ",
          "      #WGGGGGGGGW#     ",
          "      #WGPPGGPPGW#     ",
          "      #WGGGGGGGGW#     ",
          "       #WGG##GGW#      ",
          "        #WWWWWW#       ",
          "       ##W####W##      ",
          "      #..##..##..#     ",
          "      #..##..##..#     ",
          "       ####..####      ",
          "        ##....##       ",
          "       #..####..#      ",
          "       #..#  #..#      ",
          "        ###  ###       ",
          "          .. ..        ",
          "                       ",
          "        (bowl)         ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        cat_sad1:[
          "                       ",
          "        ##    ##       ",
          "       #WW####WW#      ",
          "      #WGGGGGGGGW#     ",
          "      #WGRRGGRRGW#     ",
          "      #WGGGGGGGGW#     ",
          "       #WGG####W#      ",
          "        #WWWWWW#       ",
          "       ##W####W##      ",
          "      #..##..##..#     ",
          "      #..##..##..#     ",
          "       ####..####      ",
          "        ##....##       ",
          "       #..####..#      ",
          "         ..RR..         ",
          "          .RR.          ",
          "          .. ..        ",
          "                       ",
          "        (plate)        ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],

        // DOG (more detailed)
        dog_idle1:[
          "                       ",
          "       ##########      ",
          "      #WWGGGGGGWW#     ",
          "     #WGGGGGGGGGGW#    ",
          "     #WGPPGGPPGGGW#    ",
          "     #WGGGGGGGGGGW#    ",
          "      #WGG####GGW#     ",
          "       #WWWWWWWW#      ",
          "      ##W######W##     ",
          "     #..##..##..#      ",
          "     #..##..##..#      ",
          "      ####..####       ",
          "       ##....##        ",
          "      #..####..#       ",
          "      #..#  #..#       ",
          "       ###  ###        ",
          "         .. ..         ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        dog_idle2:[ // wag + blink
          "                       ",
          "       ##########      ",
          "      #WWGGGGGGWW#     ",
          "     #WGGGGGGGGGGW#    ",
          "     #WGPPGGPPGGGW#    ",
          "     #WGGGGGGGGGGW#    ",
          "      #WGG######W#     ",
          "       #WWWWWWWW#      ",
          "     ###W######W##     ",
          "    #..##..##..#       ",
          "     #..##..##..#      ",
          "      ####..####       ",
          "       ##....##        ",
          "      #..####..#       ",
          "      #..#  #..#       ",
          "       ###  ###        ",
          "         .. ..         ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        dog_walk1:[
          "                       ",
          "       ##########      ",
          "      #WWGGGGGGWW#     ",
          "     #WGGGGGGGGGGW#    ",
          "     #WGPPGGPPGGGW#    ",
          "     #WGGGGGGGGGGW#    ",
          "      #WGG####GGW#     ",
          "       #WWWWWWWW#      ",
          "    ####W######W##     ",
          "   #..##..##..#        ",
          "    #..##..##..#       ",
          "      ####..####       ",
          "       ##....##        ",
          "        ..####..       ",
          "          #  #..       ",
          "          ##  ###      ",
          "           .. ..       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        dog_walk2:[
          "                       ",
          "       ##########      ",
          "      #WWGGGGGGWW#     ",
          "     #WGGGGGGGGGGW#    ",
          "     #WGPPGGPPGGGW#    ",
          "     #WGGGGGGGGGGW#    ",
          "      #WGG####GGW#     ",
          "       #WWWWWWWW#      ",
          "      ##W######W####   ",
          "        #..##..##..#   ",
          "       #..##..##..#    ",
          "      ####..####       ",
          "       ##....##        ",
          "      ..####..         ",
          "      ..#  #.          ",
          "      ###  ##          ",
          "       .. ..           ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        dog_sad1:[
          "                       ",
          "       ##########      ",
          "      #WWGGGGGGWW#     ",
          "     #WGGGGGGGGGGW#    ",
          "     #WGRRGGRRGGGW#    ",
          "     #WGGGGGGGGGGW#    ",
          "      #WGG######W#     ",
          "       #WWWWWWWW#      ",
          "      ##W######W##     ",
          "     #..##..##..#      ",
          "     #..##..##..#      ",
          "      ####..####       ",
          "       ##....##        ",
          "      #..####..#       ",
          "        ..RR..         ",
          "         .RR.          ",
          "         .. ..         ",
          "                       ",
          "        (plate)        ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
        dog_eat1:[
          "                       ",
          "       ##########      ",
          "      #WWGGGGGGWW#     ",
          "     #WGGGGGGGGGGW#    ",
          "     #WGPPGGPPGGGW#    ",
          "     #WGGGGGGGGGGW#    ",
          "      #WGG####GGW#     ",
          "       #WWWWWWWW#      ",
          "      ##W######W##     ",
          "     #..##..##..#      ",
          "     #..##..##..#      ",
          "      ####..####       ",
          "       ##....##        ",
          "      #..####..#       ",
          "      #..#  #..#       ",
          "       ###  ###        ",
          "         .. ..         ",
          "                       ",
          "        (bowl)         ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
          "                       ",
        ],
      };

      function stageFromXp(xp){
        if (xp < 20) return "baby";
        if (xp < 55) return "teen";
        return "adult";
      }
      function xpPct(xp){ return Math.round((clamp(xp,0,100)/100)*100); }
      function hungerPct(h){ return Math.round(clamp(h,0,100)); }

      function setAnim(pet, mode, ms){ pet.anim={mode, until: Date.now()+ms}; }
      function animMode(pet){ return (Date.now() <= (pet.anim?.until||0)) ? (pet.anim?.mode||"idle") : "idle"; }

      function pickSpeciesRandom(){ return Math.random()<0.5 ? "cat" : "dog"; }

      function decideMoodText(pet){
        if(!pet.hatched) return "Hatching‚Ä¶ ü•ö";
        if(pet.hunger>=85) return "Starving üòø";
        if(pet.hunger>=65) return "Hungry üêæ";
        if(pet.mood==="sad") return "Sad üò¢";
        return "Happy üòä";
      }

      function badgeText(pet){
        if(!pet.hatched) return "Egg";
        const sp = pet.species==="dog" ? "Dog" : "Cat";
        const st = pet.stage || "baby";
        return (st==="adult" ? "Adult " : st==="teen" ? "Teen " : "Baby ") + sp;
      }

      function applyTimeHunger(pet){
        const now=Date.now();
        const dt=Math.max(0, now-(pet.lastEventAt||now));
        const add=(dt/(60*60*1000))*HUNGER_TIME_RATE;
        pet.hunger=clamp(pet.hunger+add,0,100);
        pet.lastEventAt=now;
      }

      function maybeHatch(pet, totalPnlUsd){
        if(pet.hatched) return false;
        if(totalPnlUsd > HATCH_PNL_THRESHOLD){
          pet.hatched=true;
          pet.species=pickSpeciesRandom();
          pet.stage="baby";
          pet.xp=Math.max(pet.xp, 2);
          pet.hunger=clamp(pet.hunger, 0, 75);
          pet.hatchedAt=Date.now();

          // a nicer hatch sequence
          setAnim(pet, "hatch_sparkle", 1800);
          pet.lastEvent="none";
          return true;
        }
        return false;
      }

      function maybeWipeoutReset(pet, equity){
        if(equity==null) return {wiped:false, pet};
        if(pet.hatched && equity < WIPEOUT_EQUITY_THRESHOLD){
          return {wiped:true, pet: resetPet(true)};
        }
        return {wiped:false, pet};
      }

      function processTradeDeltas(pet, data){
        const totalTrades=data.total_trades??0;
        const wins=data.wins??0;
        const losses=data.losses??0;

        const dTrades = totalTrades - (pet.lastTotalTrades||0);
        const dWins = wins - (pet.lastWins||0);
        const dLosses = losses - (pet.lastLosses||0);

        pet.lastTotalTrades=totalTrades;
        pet.lastWins=wins;
        pet.lastLosses=losses;

        if(dTrades<=0) return {dTrades:0,dWins:0,dLosses:0};

        if(dWins>0){
          pet.xp=clamp(pet.xp + dWins*5, 0, 100);
          pet.hunger=clamp(pet.hunger - dWins*12, 0, 100);
          pet.mood="happy";
          pet.lastEvent="food";
          setAnim(pet, "eat", 1400);
        }

        if(dLosses>0){
          pet.hunger=clamp(pet.hunger + dLosses*13, 0, 100);
          pet.mood="sad";
          pet.lastEvent="empty";
          setAnim(pet, "sad", 1400);
        }

        if(pet.hatched) pet.stage=stageFromXp(pet.xp);

        return {dTrades,dWins,dLosses};
      }

      // ------------------------------
      // Draw helpers + bobbing
      // ------------------------------
      function clear(){ ctx.clearRect(0,0,petCanvas.width,petCanvas.height); }

      function drawSpriteCentered(frame, bobY=0){
        const scale=2;
        const w=frame[0].length*scale;
        const h=frame.length*scale;
        const ox=Math.floor((64-w)/2);
        const oy=Math.floor((64-h)/2 + bobY);
        drawFrame(frame, ox, oy, scale);
      }

      // small sparkles
      function drawSparkles(t){
        ctx.save();
        ctx.globalAlpha=0.9;
        ctx.fillStyle=PALETTE["B"];
        const pts=[
          [10,14],[52,20],[18,50],[44,46]
        ];
        pts.forEach((p,i)=>{
          const pulse = (Math.sin((t/120)+(i*1.3))*0.5+0.5);
          const r = 1 + Math.floor(pulse*2);
          ctx.fillRect(p[0]-r, p[1], r*2, 1);
          ctx.fillRect(p[0], p[1]-r, 1, r*2);
        });
        ctx.restore();
      }

      let pet=loadPet();
      let toggle=false;
      let lastRender=0;

      function renderPet(deltaInfo){
        pet=loadPet();
        const mode=animMode(pet);
        const screen=$("pet-screen");

        // subtle breathing bob
        const t=Date.now();
        const bob = Math.sin(t/260)*1.2;

        clear();

        // egg animation + hatch sparkles
        if(!pet.hatched){
          if(mode==="hatch_sparkle"){
            screen.classList.add("shake");
            drawSpriteCentered(toggle ? FRAMES.sparkle1 : FRAMES.sparkle2, bob);
            drawSparkles(t);
          } else if(mode==="hatch_crack"){
            screen.classList.add("shake");
            drawSpriteCentered(toggle ? FRAMES.egg_crack : FRAMES.egg_shake, bob);
          } else if(mode==="hatch_shake"){
            screen.classList.add("shake");
            drawSpriteCentered(toggle ? FRAMES.egg_shake : FRAMES.egg_idle, bob);
          } else {
            screen.classList.remove("shake");
            drawSpriteCentered(FRAMES.egg_idle, bob);
          }
        } else {
          screen.classList.remove("shake");
          const sp = pet.species==="dog" ? "dog" : "cat";

          let base=null;
          if(mode==="eat"){
            base = FRAMES[sp+"_eat1"];
            drawSpriteCentered(base, bob-0.5);
            // bowl overlay
            drawSpriteCentered(FRAMES.bowl_food, 18);
            drawSparkles(t);
          } else if(mode==="sad"){
            base = FRAMES[sp+"_sad1"];
            drawSpriteCentered(base, bob+0.6);
            drawSpriteCentered(FRAMES.plate_empty, 18);
          } else {
            // idle realism: blink/wag alternation + occasional walk
            const hungry = pet.hunger > 60;
            const wantsWalk = hungry ? true : (Math.random() < 0.25);
            if(wantsWalk){
              base = FRAMES[sp + (toggle ? "_walk1" : "_walk2")];
              drawSpriteCentered(base, bob);
            } else {
              base = FRAMES[sp + (toggle ? "_idle1" : "_idle2")];
              drawSpriteCentered(base, bob);
            }

            // show last event briefly as overlay
            if(pet.lastEvent==="food") drawSpriteCentered(FRAMES.bowl_food, 18);
            if(pet.lastEvent==="empty") drawSpriteCentered(FRAMES.plate_empty, 18);
          }
        }

        // UI text/bars
        $("pet-mood").textContent = decideMoodText(pet);
        $("pet-stage").textContent = badgeText(pet);

        const xpp=xpPct(pet.xp);
        $("pet-xp-bar").style.width = xpp+"%";
        $("pet-xp-text").textContent = xpp+"%";

        const hp=hungerPct(pet.hunger);
        $("pet-hunger-bar").style.width = hp+"%";
        $("pet-hunger-text").textContent = hp+"%";

        if(!pet.hatched){
          $("pet-subtext").textContent = "Egg stays until overall PnL turns positive‚Ä¶ then it hatches into a random cat or dog ü•ö‚ú®";
        } else {
          const spName = pet.species==="dog" ? "dog" : "cat";
          let msg = "Wins are food üçó. Losses are empty plates üçΩÔ∏è.";
          if(pet.hunger>=85) msg="Starving‚Ä¶ feed it wins üçóüòø";
          else if(pet.hunger>=65) msg="Hungry‚Ä¶ needs wins (food) üçó";
          else if(mode==="eat") msg="Yum! A win fed it üçó‚ú®";
          else if(mode==="sad") msg="Ouch‚Ä¶ empty plate üçΩÔ∏è";
          $("pet-subtext").textContent = `Hatched as a ${spName}. ${msg} More wins = it grows.`;
        }

        const dbg=[];
        if(deltaInfo?.dWins) dbg.push(`+${deltaInfo.dWins} win`);
        if(deltaInfo?.dLosses) dbg.push(`+${deltaInfo.dLosses} loss`);
        $("pet-debug").textContent = dbg.join(", ");

        toggle=!toggle;
      }

      $("pet-reset-btn").addEventListener("click",()=>{
        if(confirm("Reset the pet back to egg?")){
          pet=resetPet(true);
          renderPet(null);
        }
      });

      // ------------------------------
      // Fetch + hydrate dashboard
      // ------------------------------
      async function refreshDashboard(){
        try{
          const res=await fetch("/data");
          const data=await res.json();

          $("metric-total-trades").textContent = data.total_trades ?? 0;
          $("metric-wins").textContent = (data.wins ?? 0) + " wins";
          $("metric-losses").textContent = (data.losses ?? 0) + " losses";

          const winRate = data.win_rate != null ? data.win_rate : 0;
          $("metric-win-rate").textContent = formatPercent(winRate,1);

          const totalTrades = data.total_trades ?? 0;
          const totalPnl = Number(data.total_pnl_usd ?? 0);
          const avgPnl = totalTrades ? (totalPnl / totalTrades) : 0;
          $("metric-avg-pnl").textContent = formatUsd(avgPnl);

          const pnlEl=$("metric-total-pnl");
          pnlEl.textContent = formatUsd(totalPnl);
          pnlEl.classList.remove("positive","negative");
          pnlEl.classList.add(totalPnl>=0 ? "positive" : "negative");

          updateEquityChart(data.equity_curve || []);
          updateBotStatus(data.bot_status);
          updatePerMarket(data.per_market || []);
          updateRecentTrades(data.recent_trades || []);
          updateAdvancedMetrics(data.advanced_metrics, data.max_drawdown_usd);

          // PET logic
          pet=loadPet();
          applyTimeHunger(pet);

          const eq = (data.equity_curve && data.equity_curve.length)
            ? Number(data.equity_curve[data.equity_curve.length-1].equity_usd)
            : (pet.lastEquity!=null ? Number(pet.lastEquity) : null);
          pet.lastEquity = (eq!=null && !Number.isNaN(eq)) ? eq : pet.lastEquity;

          // pre-hatch dramatic lead-in
          if(!pet.hatched){
            if(totalPnl > HATCH_PNL_THRESHOLD){
              // hatch!
              maybeHatch(pet, totalPnl);
            } else {
              // keep egg lively
              if(animMode(pet)==="idle"){
                setAnim(pet, "hatch_shake", 900);
                // sometimes crack tease
                if(Math.random()<0.18) setAnim(pet, "hatch_crack", 800);
              }
            }
          }

          const deltaInfo=processTradeDeltas(pet, data);

          const wipe = maybeWipeoutReset(pet, pet.lastEquity);
          pet = wipe.pet;

          savePet(pet);
          renderPet(deltaInfo);

        }catch(err){
          console.error("Failed to refresh dashboard", err);
        }
      }

      // ------------------------------
      // Pet animation loop
      // ------------------------------
      function petLoop(){
        const now=Date.now();
        if(now-lastRender > TICK_MS){
          lastRender=now;
          renderPet(null);
        }
        requestAnimationFrame(petLoop);
      }

      // ------------------------------
      // Init
      // ------------------------------
      document.addEventListener("DOMContentLoaded",()=>{
        setupTvTabs();
        loadTradingView(currentSymbol);
        renderPet(null);
        refreshDashboard();
        setInterval(refreshDashboard, 10_000);
        requestAnimationFrame(petLoop);
      });
    </script>
  </body>
</html>
