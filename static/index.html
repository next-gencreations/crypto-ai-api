<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto AI Bot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Simple dark theme with basic CSS only -->
  <style>
    :root {
      --bg: #050814;
      --bg-card: #101522;
      --bg-card-soft: #141b2c;
      --text-main: #f8fafc;
      --text-muted: #9ca3af;
      --accent: #22c55e;
      --accent-red: #f44c4c;
      --border-soft: #1f2937;
      --pill-ok: #16a34a;
      --pill-warn: #f97316;
      --pill-bad: #ef4444;
      --pill-text: #0b1120;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827, #020617);
      color: var(--text-main);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      margin-bottom: 24px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 28px;
      font-weight: 700;
    }

    header p {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    header a {
      color: #38bdf8;
      text-decoration: none;
      margin-left: 4px;
      margin-right: 4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
      color: var(--pill-text);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      margin-right: 6px;
      background: #22c55e;
    }

    .pill-ok { background: var(--pill-ok); }
    .pill-warn { background: var(--pill-warn); }
    .pill-bad { background: var(--pill-bad); }

    /* Cards row */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .card {
      background: linear-gradient(145deg, var(--bg-card), #060b17);
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
    }

    .card h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin: 0 0 8px;
    }

    .metric-main {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .metric-good {
      color: var(--accent);
    }

    .metric-bad {
      color: var(--accent-red);
    }

    /* Sections */
    .section {
      background: radial-gradient(circle at top left, #0b1220, #020617);
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 18px 16px 16px;
      margin-bottom: 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .section-header h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
    }

    .section-header span {
      font-size: 11px;
      color: var(--text-muted);
    }

    canvas {
      width: 100%;
      max-height: 260px;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      text-align: left;
      padding: 6px 4px;
    }

    th {
      color: var(--text-muted);
      font-weight: 500;
      border-bottom: 1px solid #1f2937;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.4);
    }

    .text-right {
      text-align: right;
    }

    .text-muted {
      color: var(--text-muted);
    }

    .pnl-pos {
      color: var(--accent);
    }

    .pnl-neg {
      color: var(--accent-red);
    }

    /* Market candles section */
    .markets-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .chart-container-embed {
      min-height: 420px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--border-soft);
      background: #020617;
    }

    .chart-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-muted);
    }

    .footer-note {
      margin-top: 16px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    @media (min-width: 900px) {
      .markets-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>

  <!-- Chart.js for equity curve -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="page">
    <header>
      <h1>
        Crypto AI Bot Dashboard
        <span id="api-status-pill" class="pill pill-warn">
          <span class="pill-dot"></span>
          <span id="api-status-text">Checking API…</span>
        </span>
      </h1>
      <p>
        Paper-trading stats from Render —
        <a href="/data" target="_blank" rel="noreferrer">raw stats</a> |
        <a href="/health" target="_blank" rel="noreferrer">API status JSON</a>
      </p>
    </header>

    <!-- Top metrics cards -->
    <section class="cards">
      <article class="card">
        <h2>Total Trades</h2>
        <div id="total-trades" class="metric-main">0</div>
        <div id="wins-losses" class="metric-sub text-muted">0 wins / 0 losses</div>
      </article>

      <article class="card">
        <h2>Win Rate</h2>
        <div id="win-rate" class="metric-main">0.0%</div>
        <div id="avg-pnl" class="metric-sub text-muted">Avg $0.00 per trade</div>
      </article>

      <article class="card">
        <h2>PNL (Total)</h2>
        <div id="total-pnl" class="metric-main metric-bad">$0.00</div>
        <div class="metric-sub text-muted">Based on closed trades only</div>
      </article>
    </section>

    <!-- Equity curve -->
    <section class="section">
      <div class="section-header">
        <h3>Equity Curve</h3>
        <span>Based on closed trades only (last 100 points).</span>
      </div>
      <canvas id="equityChart"></canvas>
    </section>

    <!-- Market performance -->
    <section class="section">
      <div class="section-header">
        <h3>Per-Market Performance</h3>
        <span id="market-summary-label">No data yet</span>
      </div>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Market</th>
              <th class="text-right">Trades</th>
              <th class="text-right">Win Rate</th>
              <th class="text-right">Total PnL</th>
              <th class="text-right">Avg PnL</th>
            </tr>
          </thead>
          <tbody id="per-market-body">
            <tr>
              <td colspan="5" class="text-muted">Waiting for trades…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Recent trades -->
    <section class="section">
      <div class="section-header">
        <h3>Recent Trades</h3>
        <span>Showing last 20 trades.</span>
      </div>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Market</th>
              <th class="text-right">PnL (USD)</th>
            </tr>
          </thead>
          <tbody id="recent-trades-body">
            <tr>
              <td colspan="3" class="text-muted">No trades yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Market candles (Coinbase + KuCoin) -->
    <section class="section">
      <div class="section-header">
        <h3>Market Candles</h3>
        <span>Live BTC candles from Coinbase & KuCoin (TradingView widgets).</span>
      </div>

      <div class="markets-grid">
        <!-- Coinbase chart -->
        <div>
          <div class="chart-title">Coinbase BTC-USD</div>
          <div id="coinbase-chart" class="chart-container-embed"></div>
        </div>

        <!-- KuCoin chart -->
        <div>
          <div class="chart-title">KuCoin BTC-USDT</div>
          <div id="kucoin-chart" class="chart-container-embed"></div>
        </div>
      </div>

      <div class="footer-note">
        Bot is running on Render (paper trading only). Keep it training for 2–3 weeks before making AI changes.
      </div>
    </section>
  </div>

  <!-- TradingView script for candlestick charts -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script type="text/javascript">
    // Coinbase BTC-USD chart
    new TradingView.widget({
      autosize: true,
      symbol: "COINBASE:BTCUSD",
      interval: "60",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      locale: "en",
      toolbar_bg: "#0b1120",
      enable_publishing: false,
      hide_top_toolbar: false,
      hide_legend: false,
      container_id: "coinbase-chart"
    });

    // KuCoin BTC-USDT chart
    new TradingView.widget({
      autosize: true,
      symbol: "KUCOIN:BTCUSDT",
      interval: "60",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      locale: "en",
      toolbar_bg: "#0b1120",
      enable_publishing: false,
      hide_top_toolbar: false,
      hide_legend: false,
      container_id: "kucoin-chart"
    });
  </script>

  <!-- Dashboard logic: load /data and draw equity + tables -->
  <script>
    let equityChart = null;

    function formatUsd(value) {
      const num = Number(value || 0);
      const sign = num >= 0 ? "" : "-";
      return sign + "$" + Math.abs(num).toFixed(2);
    }

    function updateApiStatus(botStatus) {
      const pill = document.getElementById("api-status-pill");
      const text = document.getElementById("api-status-text");

      let statusText = "Unknown";
      let klass = "pill-warn";

      if (botStatus && botStatus.status) {
        statusText = botStatus.status;
        if (botStatus.status === "running") klass = "pill-ok";
        else if (botStatus.status === "idle") klass = "pill-warn";
        else klass = "pill-bad";
      }

      pill.classList.remove("pill-ok", "pill-warn", "pill-bad");
      pill.classList.add(klass);
      text.textContent = "Bot: " + statusText;
    }

    function drawEquityCurve(equityCurve) {
      const ctx = document.getElementById("equityChart").getContext("2d");
      const labels = equityCurve.map(p => new Date(p.time).toLocaleString());
      const data = equityCurve.map(p => Number(p.equity_usd || p.equity || 0));

      if (equityChart) {
        equityChart.data.labels = labels;
        equityChart.data.datasets[0].data = data;
        equityChart.update();
        return;
      }

      equityChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Equity (USD)",
            data: data,
            tension: 0.25,
            borderWidth: 2,
            pointRadius: 2,
            borderColor: "#22c55e",
            backgroundColor: "rgba(34,197,94,0.08)",
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: "#9ca3af", maxRotation: 0, autoSkip: true },
              grid: { color: "rgba(31,41,55,0.6)" }
            },
            y: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(31,41,55,0.6)" }
            }
          }
        }
      });
    }

    function populatePerMarket(perMarket) {
      const tbody = document.getElementById("per-market-body");
      tbody.innerHTML = "";

      if (!perMarket || perMarket.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-muted">Waiting for trades…</td></tr>';
        document.getElementById("market-summary-label").textContent = "No data yet";
        return;
      }

      let totalTrades = 0;
      perMarket.forEach(row => {
        totalTrades += row.trades || 0;
        const tr = document.createElement("tr");

        const winRate = (row.win_rate || 0) * 100;
        const totalPnl = Number(row.total_pnl_usd || 0);
        const avgPnl = Number(row.avg_pnl_usd || 0);

        tr.innerHTML = `
          <td>${row.market}</td>
          <td class="text-right">${row.trades}</td>
          <td class="text-right">${winRate.toFixed(1)}%</td>
          <td class="text-right ${totalPnl >= 0 ? "pnl-pos" : "pnl-neg"}">${formatUsd(totalPnl)}</td>
          <td class="text-right ${avgPnl >= 0 ? "pnl-pos" : "pnl-neg"}">${formatUsd(avgPnl)}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("market-summary-label").textContent =
        `${perMarket.length} market${perMarket.length > 1 ? "s" : ""}, ${totalTrades} trade${totalTrades === 1 ? "" : "s"}`;
    }

    function populateRecentTrades(recentTrades) {
      const tbody = document.getElementById("recent-trades-body");
      tbody.innerHTML = "";

      if (!recentTrades || recentTrades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-muted">No trades yet.</td></tr>';
        return;
      }

      recentTrades.forEach(t => {
        const tr = document.createElement("tr");
        const pnl = Number(t.pnl_usd || 0);

        tr.innerHTML = `
          <td>${new Date(t.time).toLocaleString()}</td>
          <td>${t.market}</td>
          <td class="text-right ${pnl >= 0 ? "pnl-pos" : "pnl-neg"}">${formatUsd(pnl)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadDashboard() {
      try {
        const res = await fetch("/data");
        const data = await res.json();

        // Top metrics
        const totalTrades = data.total_events || 0;
        const wins = data.wins || 0;
        const losses = data.losses || 0;
        const winRate = (data.win_rate || 0) * 100;
        const avgPnl = data.avg_pnl_usd || 0;
        const totalPnl = data.total_pnl_usd || 0;

        document.getElementById("total-trades").textContent = totalTrades;
        document.getElementById("wins-losses").textContent = `${wins} wins / ${losses} losses`;
        document.getElementById("win-rate").textContent = `${winRate.toFixed(1)}%`;
        document.getElementById("avg-pnl").textContent =
          `Avg ${formatUsd(avgPnl)} per trade`;

        const pnlEl = document.getElementById("total-pnl");
        pnlEl.textContent = formatUsd(totalPnl);
        pnlEl.classList.toggle("metric-good", totalPnl > 0);
        pnlEl.classList.toggle("metric-bad", totalPnl <= 0);

        // Equity curve
        if (data.equity_curve && data.equity_curve.length > 0) {
          drawEquityCurve(data.equity_curve.slice(-100));
        }

        // Market + trades
        populatePerMarket(data.per_market || []);
        populateRecentTrades(data.recent_trades || []);

        // Bot status (optional field from /data)
        updateApiStatus(data.bot_status || null);
      } catch (err) {
        console.error("Failed to load /data", err);
        updateApiStatus({status: "offline"});
      }
    }

    // Initial load + refresh every 60 seconds
    loadDashboard();
    setInterval(loadDashboard, 60000);
  </script>
</body>
</html>
